<div class="invoice-form-container">
    <!-- Loading overlay -->
    <div class="loading-overlay" *ngIf="loading">
        <div class="loading-content">
            <i class="pi pi-spin pi-spinner loading-icon"></i>
            <p>{{ isEditMode ? "Cargando proforma..." : "Procesando..." }}</p>
        </div>
    </div>

    <div class="main-card">
        <!-- Header -->
        <div class="card-header">
            <div class="header-content">
                <div class="title-section">
                    <h1>
                        {{ isEditMode ? "Editar Proforma" : "Nueva Proforma" }}
                    </h1>
                    <p class="subtitle">Complete los datos de la proforma</p>
                </div>
                <div class="header-actions" *ngIf="!loading">
                    <p-button
                        icon="pi pi-arrow-left"
                        severity="secondary"
                        [text]="true"
                        [rounded]="true"
                        (click)="onCancel()"
                        pTooltip="Volver al listado"
                    ></p-button>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="card-body">
            <form [formGroup]="form" (ngSubmit)="onSubmit()">
                <!-- Tipo de Proforma -->
                <div class="form-section">
                    <div class="section-header">
                        <h3>Tipo de Proforma</h3>
                        <p *ngIf="loadingRates" class="loading-text">
                            <i class="pi pi-spin pi-spinner"></i> Cargando tipos
                            disponibles...
                        </p>
                    </div>

                    <div class="field-group" *ngIf="!loadingRates">
                        <div class="form-field full-width">
                            <label for="type" class="field-label required"
                                >Seleccione el tipo</label
                            >
                            <p-selectButton
                                id="type"
                                formControlName="type"
                                [options]="typeOptions"
                                optionLabel="label"
                                optionValue="value"
                                [class.field-error]="isFieldInvalid('type')"
                            ></p-selectButton>
                            <small
                                class="help-text"
                                *ngIf="getSelectedTypeDescription()"
                            >
                                {{ getSelectedTypeDescription() }}
                            </small>
                            <small
                                class="error-message"
                                *ngIf="isFieldInvalid('type')"
                            >
                                {{ getFieldError("type") }}
                            </small>
                        </div>
                    </div>
                </div>

                <!-- Información Básica -->
                <div class="form-section">
                    <div class="section-header">
                        <h3>Información Básica</h3>
                    </div>

                    <div class="field-group">
                        <div class="form-field">
                            <label
                                for="introducerId"
                                class="field-label required"
                                >Introductor</label
                            >
                            <p-autoComplete
                                id="introducerId"
                                inputId="introducerSearch"
                                [(ngModel)]="introducerSearch"
                                [ngModelOptions]="{ standalone: true }"
                                [suggestions]="filteredIntroducers"
                                (completeMethod)="
                                    filterIntroducers($event.query)
                                "
                                field="name"
                                [minLength]="1"
                                placeholder="Buscar introductor por nombre o cédula..."
                                [dropdown]="true"
                                (onSelect)="selectIntroducer($event)"
                                [class.field-error]="
                                    isFieldInvalid('introducerId')
                                "
                                [disabled]="introducerLocked"
                            >
                                <ng-template let-introducer pTemplate="item">
                                    <div class="introducer-item">
                                        <div class="introducer-icon">
                                            <i
                                                class="pi"
                                                [class.pi-user]="
                                                    introducer.personType ===
                                                    'Natural'
                                                "
                                                [class.pi-building]="
                                                    introducer.personType ===
                                                    'Jurídica'
                                                "
                                            ></i>
                                        </div>
                                        <div class="introducer-info">
                                            <div class="introducer-name">
                                                {{
                                                    introducer.name ||
                                                        introducer.companyName ||
                                                        "Sin nombre"
                                                }}
                                            </div>
                                            <div class="introducer-id">
                                                {{ introducer.idNumber }} -
                                                {{ introducer.personType }}
                                            </div>
                                        </div>
                                    </div>
                                </ng-template>
                            </p-autoComplete>
                            <small
                                class="help-text"
                                *ngIf="
                                    introducerLocked && selectedSlaughterProcess
                                "
                            >
                                <i class="pi pi-lock"></i>
                                Introductor seleccionado automáticamente por el
                                proceso de faenamiento
                            </small>
                            <small
                                class="error-message"
                                *ngIf="isFieldInvalid('introducerId')"
                            >
                                {{ getFieldError("introducerId") }}
                            </small>
                        </div>

                        <div class="form-field">
                            <label
                                for="invoiceNumber"
                                class="field-label required"
                                >Número de Proforma</label
                            >
                            <input
                                pInputText
                                id="invoiceNumber"
                                formControlName="invoiceNumber"
                                placeholder="Número de proforma"
                                [readonly]="isEditMode"
                                [class.field-error]="
                                    isFieldInvalid('invoiceNumber')
                                "
                            />
                            <small
                                class="error-message"
                                *ngIf="isFieldInvalid('invoiceNumber')"
                            >
                                {{ getFieldError("invoiceNumber") }}
                            </small>
                        </div>

                        <div class="form-field">
                            <label for="slaughterProcessId" class="field-label"
                                >Proceso de Faenamiento (Opcional)</label
                            >
                            <p-autoComplete
                                id="slaughterProcessId"
                                inputId="slaughterProcessSearch"
                                [(ngModel)]="slaughterProcessSearch"
                                [ngModelOptions]="{ standalone: true }"
                                [suggestions]="filteredSlaughterProcesses"
                                (completeMethod)="
                                    filterSlaughterProcesses($event.query)
                                "
                                field="numeroOrden"
                                [minLength]="1"
                                placeholder="Buscar proceso de faenamiento..."
                                [dropdown]="true"
                                (onSelect)="selectSlaughterProcess($event)"
                                (onClear)="clearSlaughterProcessSelection()"
                                [showClear]="true"
                            >
                                <ng-template
                                    let-slaughterProcess
                                    pTemplate="item"
                                >
                                    <div class="slaughter-process-item">
                                        <div class="slaughter-process-icon">
                                            <i class="pi pi-cog"></i>
                                        </div>
                                        <div class="slaughter-process-info">
                                            <div
                                                class="slaughter-process-number"
                                            >
                                                {{
                                                    slaughterProcess.numeroOrden ||
                                                        "Sin número"
                                                }}
                                            </div>
                                            <div
                                                class="slaughter-process-status"
                                            >
                                                Estado:
                                                {{
                                                    slaughterProcess.estado ||
                                                        "Desconocido"
                                                }}
                                            </div>
                                        </div>
                                        <div class="slaughter-process-badge">
                                            <span
                                                class="status-badge"
                                                [ngClass]="
                                                    'status-' +
                                                    (slaughterProcess.estado?.toLowerCase() ||
                                                        'desconocido')
                                                "
                                            >
                                                {{
                                                    slaughterProcess.estado ||
                                                        "Desconocido"
                                                }}
                                            </span>
                                        </div>
                                    </div>
                                </ng-template>
                            </p-autoComplete>
                            <small
                                class="help-text"
                                *ngIf="selectedSlaughterProcess"
                            >
                                <i class="pi pi-info-circle"></i>
                                Proceso seleccionado:
                                {{ selectedSlaughterProcess.numeroOrden }} -
                                {{ selectedSlaughterProcess.estado }}
                            </small>
                            <small
                                class="help-text"
                                *ngIf="!selectedSlaughterProcess"
                            >
                                Puede asociar esta proforma a un proceso de
                                faenamiento existente
                            </small>
                        </div>
                    </div>
                </div>

                <!-- Tarifas Disponibles -->
                <!-- En la sección de agregar rates, modifica para mostrar compatibilidad -->
                <div class="rates-section" *ngIf="filteredRates.length > 0">
                    <h4>Tarifas Disponibles</h4>
                    <div class="grid">
                        <div
                            class="col-12 md:col-6 lg:col-4"
                            *ngFor="let rate of filteredRates"
                        >
                            <div
                                class="rate-card p-3 border-round cursor-pointer"
                                [class.rate-incompatible]="
                                    !isRateCompatible(rate)
                                "
                                [class.rate-compatible]="isRateCompatible(rate)"
                                (click)="
                                    isRateCompatible(rate) &&
                                        addItem(null, rate)
                                "
                                [pTooltip]="
                                    !isRateCompatible(rate)
                                        ? getIncompatibilityMessage(rate)
                                        : rate.description
                                "
                                tooltipPosition="top"
                            >
                                <div
                                    class="flex justify-content-between align-items-start mb-2"
                                >
                                    <span class="rate-code font-bold">{{
                                        rate.code
                                    }}</span>
                                    <p-badge
                                        [value]="rate.type"
                                        [severity]="
                                            getRateBadgeSeverity(rate.type)
                                        "
                                        class="ml-2"
                                    ></p-badge>
                                </div>

                                <p
                                    class="rate-description text-sm mb-2 line-height-3"
                                >
                                    {{ rate.description }}
                                </p>

                                <div
                                    class="flex justify-content-between align-items-center"
                                >
                                    <span
                                        class="rate-attribute text-xs text-color-secondary"
                                    >
                                        {{ rate.rubroxAtributo }}
                                    </span>
                                    <p-button
                                        icon="pi pi-plus"
                                        [disabled]="!isRateCompatible(rate)"
                                        size="small"
                                        severity="success"
                                        [text]="true"
                                    ></p-button>
                                </div>

                                <!-- Mensaje de incompatibilidad -->
                                <div
                                    *ngIf="!isRateCompatible(rate)"
                                    class="mt-2 p-2 bg-red-50 border-round text-xs text-red-600"
                                >
                                    <i
                                        class="pi pi-exclamation-triangle mr-1"
                                    ></i>
                                    {{ getIncompatibilityMessage(rate) }}
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Mensaje cuando no hay rates disponibles -->
                    <div
                        *ngIf="filteredRates.length === 0"
                        class="text-center p-4"
                    >
                        <i
                            class="pi pi-info-circle text-4xl text-color-secondary mb-3"
                        ></i>
                        <p class="text-color-secondary">
                            No hay tarifas disponibles para la configuración
                            actual
                        </p>
                        <small class="text-color-secondary">
                            Verifica que el introductor tenga tipos de ganado
                            configurados
                            <span *ngIf="selectedSlaughterProcess">
                                y que el proceso de faenamiento sea compatible
                            </span>
                        </small>
                    </div>
                </div>

                <!-- Sección de información del tipo de factura seleccionado -->
                <div
                    *ngIf="selectedInvoiceRateType"
                    class="invoice-type-info mt-3 p-3 bg-blue-50 border-round"
                >
                    <div class="flex align-items-center mb-2">
                        <i class="pi pi-info-circle text-blue-600 mr-2"></i>
                        <span class="font-semibold text-blue-800">
                            Tipo de Factura: {{ selectedInvoiceRateType }}
                        </span>
                    </div>
                    <p class="text-sm text-blue-700 m-0">
                        Solo se pueden agregar items del tipo
                        {{ selectedInvoiceRateType }} a esta factura.
                    </p>
                </div>

                <!-- Advertencia cuando se selecciona un Slaughter Process -->
                <div
                    *ngIf="selectedSlaughterProcess"
                    class="slaughter-process-warning mt-3 p-3 bg-orange-50 border-round"
                >
                    <div class="flex align-items-center mb-2">
                        <i
                            class="pi pi-exclamation-triangle text-orange-600 mr-2"
                        ></i>
                        <span class="font-semibold text-orange-800">
                            Proceso de Faenamiento Seleccionado
                        </span>
                    </div>
                    <p class="text-sm text-orange-700 m-0">
                        Las tarifas de inscripción (TARIFA) no están disponibles
                        cuando hay un proceso de faenamiento seleccionado. Solo
                        se pueden usar servicios de faenamiento (TASA) y
                        servicios adicionales (SERVICIOS).
                    </p>
                </div>

                <!-- Información del introductor seleccionado -->
                <div
                    *ngIf="selectedIntroducer"
                    class="introducer-info mt-3 p-3 bg-green-50 border-round"
                >
                    <div class="flex justify-content-between align-items-start">
                        <div>
                            <div class="flex align-items-center mb-2">
                                <i class="pi pi-user text-green-600 mr-2"></i>
                                <span class="font-semibold text-green-800">
                                    {{
                                        getIntroducerDisplayName(
                                            selectedIntroducer
                                        )
                                    }}
                                </span>
                                <p-badge
                                    [value]="selectedIntroducer.personType"
                                    severity="success"
                                    class="ml-2"
                                ></p-badge>
                            </div>
                            <div class="text-sm text-green-700">
                                <div>
                                    <strong>Cédula/RUC:</strong>
                                    {{
                                        selectedIntroducer.idNumber ||
                                            selectedIntroducer.ruc
                                    }}
                                </div>
                                <div
                                    *ngIf="
                                        selectedIntroducer.cattleTypes?.length >
                                        0
                                    "
                                >
                                    <strong>Tipos de Ganado:</strong>
                                    <span
                                        *ngFor="
                                            let cattleType of selectedIntroducer.cattleTypes;
                                            let last = last
                                        "
                                    >
                                        {{ cattleType.species }}
                                        <span *ngIf="!last">, </span>
                                    </span>
                                </div>
                            </div>
                        </div>
                        <p-button
                            *ngIf="!introducerLocked"
                            icon="pi pi-times"
                            size="small"
                            severity="danger"
                            [text]="true"
                            (click)="clearIntroducerSelection()"
                            pTooltip="Limpiar selección"
                        ></p-button>
                    </div>
                </div>

                <!-- Items -->
                <div class="form-section">
                    <div class="section-header">
                        <h3>Items de la Proforma</h3>
                        <div
                            class="calculation-status"
                            *ngIf="calculationError"
                        >
                            <i class="pi pi-exclamation-triangle"></i>
                            <span>Cálculo manual activo</span>
                        </div>
                    </div>

                    <div class="items-container">
                        <!-- Lista de items -->
                        <div
                            class="items-list"
                            *ngIf="items.length > 0"
                            formArrayName="items"
                        >
                            <div
                                *ngFor="
                                    let item of items.controls;
                                    let i = index
                                "
                                class="item-card"
                                [formGroupName]="i"
                            >
                                <div class="item-header">
                                    <div class="item-number">
                                        <span>Item #{{ i + 1 }}</span>
                                    </div>
                                    <p-button
                                        icon="pi pi-trash"
                                        severity="danger"
                                        size="small"
                                        [text]="true"
                                        [rounded]="true"
                                        (onClick)="removeItem(i)"
                                        pTooltip="Eliminar item"
                                        class="delete-button"
                                    ></p-button>
                                </div>

                                <div class="item-content">
                                    <div class="item-field full-width">
                                        <label
                                            [for]="'itemDescription_' + i"
                                            class="field-label required"
                                        >
                                            Descripción
                                        </label>
                                        <textarea
                                            pInputTextarea
                                            [id]="'itemDescription_' + i"
                                            formControlName="description"
                                            rows="2"
                                            placeholder="Descripción del item"
                                            [autoResize]="true"
                                            [class.field-error]="
                                                isItemFieldInvalid(
                                                    i,
                                                    'description'
                                                )
                                            "
                                        ></textarea>
                                        <small
                                            class="error-message"
                                            *ngIf="
                                                isItemFieldInvalid(
                                                    i,
                                                    'description'
                                                )
                                            "
                                        >
                                            Este campo es requerido
                                        </small>
                                    </div>

                                    <div class="item-fields-row">
                                        <div class="item-field">
                                            <label
                                                [for]="'itemQuantity_' + i"
                                                class="field-label required"
                                            >
                                                Cantidad
                                            </label>
                                            <p-inputNumber
                                                [id]="'itemQuantity_' + i"
                                                formControlName="quantity"
                                                [min]="1"
                                                mode="decimal"
                                                [showButtons]="true"
                                                [class.field-error]="
                                                    isItemFieldInvalid(
                                                        i,
                                                        'quantity'
                                                    )
                                                "
                                            ></p-inputNumber>
                                            <small
                                                class="error-message"
                                                *ngIf="
                                                    isItemFieldInvalid(
                                                        i,
                                                        'quantity'
                                                    )
                                                "
                                            >
                                                Cantidad debe ser mayor a 0
                                            </small>
                                        </div>

                                        <div class="item-field">
                                            <label
                                                [for]="'itemUnitPrice_' + i"
                                                class="field-label required"
                                            >
                                                Precio Unitario
                                            </label>
                                            <p-inputNumber
                                                [id]="'itemUnitPrice_' + i"
                                                formControlName="unitPrice"
                                                mode="currency"
                                                currency="USD"
                                                locale="es-EC"
                                                [min]="0"
                                                [step]="0.01"
                                                [class.field-error]="
                                                    isItemFieldInvalid(
                                                        i,
                                                        'unitPrice'
                                                    )
                                                "
                                            ></p-inputNumber>
                                            <small
                                                class="error-message"
                                                *ngIf="
                                                    isItemFieldInvalid(
                                                        i,
                                                        'unitPrice'
                                                    )
                                                "
                                            >
                                                Precio debe ser mayor o igual a
                                                0
                                            </small>
                                        </div>

                                        <div class="item-field">
                                            <label
                                                [for]="'itemTotal_' + i"
                                                class="field-label"
                                            >
                                                Total
                                            </label>
                                            <p-inputNumber
                                                [id]="'itemTotal_' + i"
                                                formControlName="total"
                                                mode="currency"
                                                currency="USD"
                                                locale="es-EC"
                                                [min]="0"
                                                [step]="0.01"
                                                [readonly]="true"
                                            ></p-inputNumber>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Botón agregar item manual -->
                        <div class="add-item-section">
                            <p-button
                                label="Agregar Item Manual"
                                icon="pi pi-plus"
                                styleClass="p-button-outlined"
                                (click)="addItem()"
                            ></p-button>
                        </div>

                        <!-- Mensaje cuando no hay items -->
                        <div class="empty-items" *ngIf="items.length === 0">
                            <i class="pi pi-inbox empty-icon"></i>
                            <h4>No hay items agregados</h4>
                            <p>
                                Agregue items desde las tarifas disponibles o
                                manualmente
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Totales -->
                <div class="form-section totals-section">
                    <div class="section-header">
                        <h3>Resumen de Totales</h3>
                    </div>

                    <div class="totals-grid">
                        <div class="total-field">
                            <label class="field-label">Subtotal</label>
                            <p-inputNumber
                                formControlName="subtotal"
                                mode="currency"
                                currency="USD"
                                locale="es-EC"
                                [readonly]="true"
                            ></p-inputNumber>
                        </div>

                        <div class="total-field total-final">
                            <label class="field-label">Total</label>
                            <p-inputNumber
                                formControlName="totalAmount"
                                mode="currency"
                                currency="USD"
                                locale="es-EC"
                                [readonly]="true"
                            ></p-inputNumber>
                        </div>
                    </div>
                </div>

                <!-- Información Adicional -->
                <div class="form-section">
                    <div class="section-header">
                        <h3>Información Adicional</h3>
                    </div>

                    <div class="field-group">
                        <div class="form-field">
                            <label for="dueDate" class="field-label required"
                                >Fecha de Vencimiento</label
                            >
                            <p-calendar
                                id="dueDate"
                                formControlName="dueDate"
                                dateFormat="dd/mm/yy"
                                [showIcon]="true"
                                [class.field-error]="isFieldInvalid('dueDate')"
                                placeholder="Seleccione fecha"
                            ></p-calendar>
                            <small
                                class="error-message"
                                *ngIf="isFieldInvalid('dueDate')"
                            >
                                {{ getFieldError("dueDate") }}
                            </small>
                        </div>

                        <div class="form-field">
                            <label for="notes" class="field-label">Notas</label>
                            <textarea
                                pInputTextarea
                                id="notes"
                                formControlName="notes"
                                rows="3"
                                placeholder="Notas adicionales (opcional)"
                                [autoResize]="true"
                            ></textarea>
                        </div>
                    </div>
                </div>

                <!-- Acciones -->
                <div class="form-actions">
                    <p-button
                        type="button"
                        label="Cancelar"
                        icon="pi pi-times"
                        severity="secondary"
                        (click)="onCancel()"
                        [disabled]="loading"
                    ></p-button>

                    <p-button
                        type="submit"
                        [label]="
                            isEditMode
                                ? 'Actualizar Proforma'
                                : 'Crear Proforma'
                        "
                        icon="pi pi-check"
                        [loading]="loading"
                        [disabled]="
                            form.invalid || loading || items.length === 0
                        "
                    ></p-button>
                </div>
            </form>
        </div>
    </div>
</div>
