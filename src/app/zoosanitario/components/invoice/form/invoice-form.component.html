<div class="invoice-form-container">
    <div class="card">
        <div class="card-header">
            <div class="flex justify-content-between align-items-center">
                <h3 class="m-0">
                    {{ isEditMode ? "Editar Proforma" : "Nueva Proforma" }}
                </h3>
            </div>
        </div>

        <form [formGroup]="form" (ngSubmit)="onSubmit()" class="card-content">
            <!-- Tipo de Proforma -->
            <div class="formgrid grid">
                <div class="field col-12">
                    <label for="type" class="required">Tipo de Proforma</label>
                    <p-selectButton
                        id="type"
                        formControlName="type"
                        [options]="typeOptions"
                        optionLabel="label"
                        optionValue="value"
                    >
                    </p-selectButton>
                    <small class="p-error" *ngIf="isFieldInvalid('type')">
                        {{ getFieldError("type") }}
                    </small>
                </div>
            </div>

            <!-- Introducer -->
            <div class="formgrid grid">
                <div class="field col-12 md:col-6">
                    <label for="introducerId" class="required"
                        >Introductor</label
                    >
                    <p-autoComplete
                        id="introducerId"
                        inputId="introducerSearch"
                        [(ngModel)]="introducerSearch"
                        [ngModelOptions]="{ standalone: true }"
                        [suggestions]="filteredIntroducers"
                        (completeMethod)="filterIntroducers($event.query)"
                        field="name"
                        [minLength]="1"
                        placeholder="Buscar introductor..."
                        [dropdown]="true"
                        (onSelect)="selectIntroducer($event)"
                    >
                        <ng-template let-introducer pTemplate="item">
                            <div class="flex align-items-center gap-2">
                                <i
                                    class="pi"
                                    [class.pi-user]="
                                        introducer.type === 'Natural'
                                    "
                                    [class.pi-building]="
                                        introducer.type === 'Jurídica'
                                    "
                                ></i>
                                <div>
                                    <div class="font-semibold">
                                        {{
                                            getIntroducerDisplayName(introducer)
                                        }}
                                    </div>
                                    <div class="text-sm text-600">
                                        {{ introducer.idNumber }}
                                    </div>
                                </div>
                            </div>
                        </ng-template>
                    </p-autoComplete>
                    <small
                        class="p-error"
                        *ngIf="isFieldInvalid('introducerId')"
                    >
                        {{ getFieldError("introducerId") }}
                    </small>
                </div>

                <div class="field col-12 md:col-6">
                    <label for="invoiceNumber" class="required"
                        >Número de Proforma</label
                    >
                    <input
                        pInputText
                        id="invoiceNumber"
                        formControlName="invoiceNumber"
                        placeholder="Número de Proforma"
                        [readonly]="isEditMode"
                    />
                    <small
                        class="p-error"
                        *ngIf="isFieldInvalid('invoiceNumber')"
                    >
                        {{ getFieldError("invoiceNumber") }}
                    </small>
                </div>
            </div>

            <!-- Tarifas disponibles -->
            <div class="formgrid grid" *ngIf="filteredRates.length > 0">
                <div class="field col-12">
                    <label>Tarifas Disponibles</label>
                    <div class="flex flex-wrap gap-2">
                        <p-chip
                            *ngFor="let rate of filteredRates"
                            [label]="rate.description"
                            [styleClass]="'mb-2'"
                            (click)="addItem(null, rate)"
                            pTooltip="Click para agregar"
                            tooltipPosition="top"
                        >
                            <span class="font-semibold">{{ rate.code }}</span> -
                            {{ formatCurrency(rate.unitPrice || 0) }}
                        </p-chip>
                    </div>
                </div>
            </div>

            <!-- Items -->
            <div class="formgrid grid">
                <div class="field col-12">
                    <label class="required">Items</label>
                    <div class="items-list">
                        <div
                            *ngFor="let item of items.controls; let i = index"
                            class="item-card p-3 border-round border-1 surface-border mb-3"
                        >
                            <div
                                class="flex justify-content-between align-items-center mb-2"
                            >
                                <h4 class="m-0">Item #{{ i + 1 }}</h4>
                                <p-button
                                    icon="pi pi-trash"
                                    severity="danger"
                                    size="small"
                                    [text]="true"
                                    [rounded]="true"
                                    (onClick)="removeItem(i)"
                                    pTooltip="Eliminar"
                                ></p-button>
                            </div>

                            <div class="grid">
                                <div class="col-12 md:col-6">
                                    <div class="field">
                                        <label
                                            [for]="'itemDescription_' + i"
                                            class="required"
                                            >Descripción</label
                                        >
                                        <textarea
                                            pInputTextarea
                                            [id]="'itemDescription_' + i"
                                            [formControlName]="
                                                i + '.description'
                                            "
                                            rows="2"
                                            placeholder="Descripción del item"
                                            [class.ng-invalid]="
                                                isItemFieldInvalid(
                                                    i,
                                                    'description'
                                                )
                                            "
                                        ></textarea>
                                        <small
                                            class="p-error"
                                            *ngIf="
                                                isItemFieldInvalid(
                                                    i,
                                                    'description'
                                                )
                                            "
                                        >
                                            {{ getFieldError("description") }}
                                        </small>
                                    </div>
                                </div>

                                <div class="col-12 md:col-2">
                                    <div class="field">
                                        <label
                                            [for]="'itemQuantity_' + i"
                                            class="required"
                                            >Cantidad</label
                                        >
                                        <p-inputNumber
                                            [id]="'itemQuantity_' + i"
                                            [formControlName]="i + '.quantity'"
                                            [min]="1"
                                            mode="decimal"
                                            [showButtons]="true"
                                            [class.ng-invalid]="
                                                isItemFieldInvalid(
                                                    i,
                                                    'quantity'
                                                )
                                            "
                                        ></p-inputNumber>
                                        <small
                                            class="p-error"
                                            *ngIf="
                                                isItemFieldInvalid(
                                                    i,
                                                    'quantity'
                                                )
                                            "
                                        >
                                            {{ getFieldError("quantity") }}
                                        </small>
                                    </div>
                                </div>

                                <div class="col-12 md:col-2">
                                    <div class="field">
                                        <label
                                            [for]="'itemUnitPrice_' + i"
                                            class="required"
                                            >P. Unitario</label
                                        >
                                        <p-inputNumber
                                            [id]="'itemUnitPrice_' + i"
                                            [formControlName]="i + '.unitPrice'"
                                            mode="currency"
                                            currency="USD"
                                            locale="es-EC"
                                            [min]="0"
                                            [step]="0.01"
                                            [class.ng-invalid]="
                                                isItemFieldInvalid(
                                                    i,
                                                    'unitPrice'
                                                )
                                            "
                                        ></p-inputNumber>
                                        <small
                                            class="p-error"
                                            *ngIf="
                                                isItemFieldInvalid(
                                                    i,
                                                    'unitPrice'
                                                )
                                            "
                                        >
                                            {{ getFieldError("unitPrice") }}
                                        </small>
                                    </div>
                                </div>

                                <div class="col-12 md:col-2">
                                    <div class="field">
                                        <label
                                            [for]="'itemTotal_' + i"
                                            class="required"
                                            >Total</label
                                        >
                                        <p-inputNumber
                                            [id]="'itemTotal_' + i"
                                            [formControlName]="i + '.total'"
                                            mode="currency"
                                            currency="USD"
                                            locale="es-EC"
                                            [min]="0"
                                            [step]="0.01"
                                            [readonly]="true"
                                        ></p-inputNumber>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <p-button
                        label="Agregar Item Manual"
                        icon="pi pi-plus"
                        styleClass="p-button-outlined mt-2"
                        (click)="addItem()"
                    ></p-button>
                </div>
            </div>

            <!-- Totales -->
            <div class="formgrid grid">
                <div class="field col-12 md:col-4">
                    <label>Subtotal</label>
                    <p-inputNumber
                        formControlName="subtotal"
                        mode="currency"
                        currency="USD"
                        locale="es-EC"
                        [readonly]="true"
                    ></p-inputNumber>
                </div>

                <div class="field col-12 md:col-4">
                    <label>Total</label>
                    <p-inputNumber
                        formControlName="totalAmount"
                        mode="currency"
                        currency="USD"
                        locale="es-EC"
                        [readonly]="true"
                    ></p-inputNumber>
                </div>
            </div>

            <!-- Fecha y Notas -->
            <div class="formgrid grid">
                <div class="field col-12 md:col-6">
                    <label for="dueDate" class="required"
                        >Fecha Vencimiento</label
                    >
                    <p-calendar
                        id="dueDate"
                        formControlName="dueDate"
                        dateFormat="dd/mm/yy"
                        [showIcon]="true"
                        [class.ng-invalid]="isFieldInvalid('dueDate')"
                    ></p-calendar>
                    <small class="p-error" *ngIf="isFieldInvalid('dueDate')">
                        {{ getFieldError("dueDate") }}
                    </small>
                </div>

                <div class="field col-12 md:col-6">
                    <label for="notes">Notas</label>
                    <textarea
                        pInputTextarea
                        id="notes"
                        formControlName="notes"
                        rows="3"
                        placeholder="Notas adicionales (opcional)"
                        [autoResize]="true"
                    ></textarea>
                </div>
            </div>

            <!-- Botones -->
            <div class="form-actions">
                <p-button
                    type="button"
                    label="Cancelar"
                    icon="pi pi-times"
                    severity="secondary"
                    (click)="onCancel()"
                    [disabled]="loading"
                ></p-button>

                <p-button
                    type="submit"
                    [label]="isEditMode ? 'Actualizar' : 'Crear'"
                    icon="pi pi-check"
                    [loading]="loading"
                    [disabled]="form.invalid || loading"
                ></p-button>
            </div>
        </form>
    </div>
</div>
