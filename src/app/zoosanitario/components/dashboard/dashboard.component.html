<div class="dashboard-container">
    <!-- Loading Overlay -->
    <div class="loading-overlay" *ngIf="loading">
        <p-progressSpinner strokeWidth="4"></p-progressSpinner>
        <p>Cargando estadísticas...</p>
    </div>

    <!-- Dashboard Header -->
    <div class="dashboard-header">
        <div class="header-content">
            <div class="welcome-section">
                <h1 class="welcome-title">Dashboard de Faenamiento</h1>
                <p class="welcome-subtitle">Resumen general del sistema</p>
            </div>
            <div class="header-actions">
                <p-button
                    icon="pi pi-refresh"
                    severity="secondary"
                    (onClick)="loadDashboardData()"
                    [loading]="loading"
                    pTooltip="Actualizar datos"
                >
                </p-button>
                <p-button
                    icon="pi pi-download"
                    severity="info"
                    pTooltip="Exportar reporte"
                >
                </p-button>
            </div>
        </div>

        <!-- Quick Indicators -->
        <div class="quick-indicators">
            <div class="indicator">
                <i
                    class="pi pi-chart-line"
                    style="color: var(--primary-color)"
                ></i>
                <div class="indicator-value">
                    {{ dashboardData?.total || 0 }}
                </div>
                <div class="indicator-label">Procesos Totales</div>
            </div>
            <div class="indicator">
                <i class="pi pi-file-check" style="color: #28a745"></i>
                <div class="indicator-value">
                    {{ dashboardData?.withInvoice || 0 }}
                </div>
                <div class="indicator-label">Con Factura</div>
            </div>
            <div class="indicator">
                <i class="pi pi-money-bill" style="color: #17a2b8"></i>
                <div class="indicator-value">
                    {{ dashboardData?.paidInvoices || 0 }}
                </div>
                <div class="indicator-label">Facturado</div>
            </div>
            <div class="indicator">
                <i class="pi pi-percentage" style="color: #ffc107"></i>
                <div class="indicator-value">
                    {{ dashboardData?.completionRate || 0 | number : "1.1-1" }}%
                </div>
                <div class="indicator-label">Completados</div>
            </div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="quick-actions-section">
        <p-card>
            <ng-template pTemplate="header">
                <div class="card-header">
                    <h3 class="card-title">Acciones Rápidas</h3>
                </div>
            </ng-template>
            <div class="quick-actions-grid">
                <div
                    class="quick-action-item"
                    routerLink="/zoosanitario/workflow/reception"
                >
                    <div
                        class="action-icon"
                        style="
                            background: linear-gradient(
                                135deg,
                                #667eea 0%,
                                #764ba2 100%
                            );
                        "
                    >
                        <i class="pi pi-plus"></i>
                    </div>
                    <div class="action-label">Nuevo Proceso</div>
                </div>
                <div
                    class="quick-action-item"
                    routerLink="/zoosanitario/workflow/listar-reception"
                >
                    <div
                        class="action-icon"
                        style="
                            background: linear-gradient(
                                135deg,
                                #f093fb 0%,
                                #f5576c 100%
                            );
                        "
                    >
                        <i class="pi pi-truck"></i>
                    </div>
                    <div class="action-label">Gestionar Recepción</div>
                </div>
                <div
                    class="quick-action-item"
                    routerLink="/zoosanitario/workflow/external-inspection/recepcion"
                >
                    <div
                        class="action-icon"
                        style="
                            background: linear-gradient(
                                135deg,
                                #4facfe 0%,
                                #00f2fe 100%
                            );
                        "
                    >
                        <i class="pi pi-search"></i>
                    </div>
                    <div class="action-label">Inspecciones</div>
                </div>
                <div
                    class="quick-action-item"
                    routerLink="/zoosanitario/invoices"
                >
                    <div
                        class="action-icon"
                        style="
                            background: linear-gradient(
                                135deg,
                                #43e97b 0%,
                                #38f9d7 100%
                            );
                        "
                    >
                        <i class="pi pi-file-pdf"></i>
                    </div>
                    <div class="action-label">Facturación</div>
                </div>
            </div>
        </p-card>
    </div>

    <!-- Dashboard Content -->
    <div class="dashboard-content">
        <!-- Statistics Section -->
        <div class="stats-section">
            <div class="stats-grid">
                <!-- Procesos de Faenamiento -->
                <p-card class="stat-card">
                    <ng-template pTemplate="header">
                        <div class="card-header">
                            <h4 class="card-title">Procesos de Faenamiento</h4>
                        </div>
                    </ng-template>
                    <div
                        class="stat-card-content"
                        style="display: flex; align-items: center"
                    >
                        <div class="stat-icon certificates">
                            <i class="pi pi-file-check"></i>
                        </div>
                        <div class="stat-info">
                            <h4>{{ dashboardData?.total || 0 }}</h4>
                            <p>Procesos Registrados</p>
                            <div class="stat-breakdown">
                                <div class="breakdown-item active">
                                    <i class="pi pi-circle-fill"></i>
                                    <span
                                        >Iniciado:
                                        {{
                                            dashboardData?.stateBreakdown
                                                ?.iniciado || 0
                                        }}</span
                                    >
                                </div>
                                <div class="breakdown-item processed">
                                    <i class="pi pi-circle-fill"></i>
                                    <span
                                        >En Proceso:
                                        {{
                                            dashboardData?.stateBreakdown
                                                ?.enProceso || 0
                                        }}</span
                                    >
                                </div>
                                <div class="breakdown-item external">
                                    <i class="pi pi-circle-fill"></i>
                                    <span
                                        >Finalizado:
                                        {{
                                            dashboardData?.stateBreakdown
                                                ?.finalizado || 0
                                        }}</span
                                    >
                                </div>
                            </div>
                        </div>
                    </div>
                </p-card>

                <!-- Inspecciones -->
                <p-card class="stat-card">
                    <ng-template pTemplate="header">
                        <div class="card-header">
                            <h4 class="card-title">Inspecciones</h4>
                        </div>
                    </ng-template>
                    <div
                        class="stat-card-content"
                        style="display: flex; align-items: center"
                    >
                        <div class="stat-icon inspections">
                            <i class="pi pi-search"></i>
                        </div>
                        <div class="stat-info">
                            <h4>{{ inspectionStats?.data?.total || 0 }}</h4>
                            <p>Inspecciones Realizadas</p>
                            <div class="stat-breakdown">
                                <div class="breakdown-item active">
                                    <i class="pi pi-circle-fill"></i>
                                    <span
                                        >Recepción:
                                        {{
                                            inspectionStats?.data
                                                ?.recepcionStats?.total || 0
                                        }}</span
                                    >
                                </div>
                                <div class="breakdown-item processed">
                                    <i class="pi pi-circle-fill"></i>
                                    <span
                                        >Ante Mortem:
                                        {{
                                            inspectionStats?.data
                                                ?.anteMortemStats?.total || 0
                                        }}</span
                                    >
                                </div>
                                <div class="breakdown-item weight">
                                    <i class="pi pi-circle-fill"></i>
                                    <span
                                        >Peso Prom:
                                        {{
                                            inspectionStats?.data?.averages
                                                ?.weight || 0
                                        }}
                                        kg</span
                                    >
                                </div>
                            </div>
                        </div>
                    </div>
                </p-card>

                <!-- Recepciones -->
                <p-card class="stat-card">
                    <ng-template pTemplate="header">
                        <div class="card-header">
                            <h4 class="card-title">Recepciones</h4>
                        </div>
                    </ng-template>
                    <div
                        class="stat-card-content"
                        style="display: flex; align-items: center"
                    >
                        <div class="stat-icon processing">
                            <i class="pi pi-truck"></i>
                        </div>
                        <div class="stat-info">
                            <h4>{{ receptionStats?.data?.total || 0 }}</h4>
                            <p>Recepciones de Ganado</p>
                            <div class="stat-breakdown">
                                <div class="breakdown-item pending">
                                    <i class="pi pi-circle-fill"></i>
                                    <span
                                        >Pendiente:
                                        {{
                                            receptionStats?.data?.stateBreakdown
                                                ?.pendiente || 0
                                        }}</span
                                    >
                                </div>
                                <div class="breakdown-item processed">
                                    <i class="pi pi-circle-fill"></i>
                                    <span
                                        >Procesando:
                                        {{
                                            receptionStats?.data?.stateBreakdown
                                                ?.procesando || 0
                                        }}</span
                                    >
                                </div>
                                <div class="breakdown-item active">
                                    <i class="pi pi-circle-fill"></i>
                                    <span
                                        >Completado:
                                        {{
                                            receptionStats?.data?.stateBreakdown
                                                ?.completado || 0
                                        }}</span
                                    >
                                </div>
                            </div>
                        </div>
                    </div>
                </p-card>

                <!-- Introductores -->
                <p-card class="stat-card">
                    <ng-template pTemplate="header">
                        <div class="card-header">
                            <h4 class="card-title">Introductores</h4>
                        </div>
                    </ng-template>
                    <div
                        class="stat-card-content"
                        style="display: flex; align-items: center"
                    >
                        <div class="stat-icon shipping">
                            <i class="pi pi-users"></i>
                        </div>
                        <div class="stat-info">
                            <h4>{{ introducerStats?.data?.total || 0 }}</h4>
                            <p>Introductores Registrados</p>
                            <div class="stat-breakdown">
                                <div class="breakdown-item active">
                                    <i class="pi pi-circle-fill"></i>
                                    <span
                                        >Natural:
                                        {{
                                            introducerStats?.data
                                                ?.personTypeBreakdown
                                                ?.natural || 0
                                        }}</span
                                    >
                                </div>
                                <div class="breakdown-item external">
                                    <i class="pi pi-circle-fill"></i>
                                    <span
                                        >Jurídica:
                                        {{
                                            introducerStats?.data
                                                ?.personTypeBreakdown
                                                ?.juridica || 0
                                        }}</span
                                    >
                                </div>
                                <div class="breakdown-item pending">
                                    <i class="pi pi-circle-fill"></i>
                                    <span
                                        >Pendientes:
                                        {{
                                            introducerStats?.data
                                                ?.statusBreakdown?.pending || 0
                                        }}</span
                                    >
                                </div>
                            </div>
                        </div>
                    </div>
                </p-card>
            </div>
        </div>

        <!-- Charts Section -->
        <div class="charts-section">
            <div class="charts-grid">
                <!-- Estados de Procesos Chart -->
                <p-card>
                    <ng-template pTemplate="header">
                        <div class="card-header">
                            <h4 class="card-title">Estados de Procesos</h4>
                        </div>
                    </ng-template>
                    <div class="chart-container">
                        <p-chart
                            type="doughnut"
                            [data]="processStatesChartData"
                            [options]="chartOptions"
                            width="100%"
                            height="300px"
                        >
                        </p-chart>
                    </div>
                </p-card>

                <!-- Condiciones Higiénicas Chart -->
                <p-card>
                    <ng-template pTemplate="header">
                        <div class="card-header">
                            <h4 class="card-title">Condiciones Higiénicas</h4>
                        </div>
                    </ng-template>
                    <div class="chart-container">
                        <p-chart
                            type="bar"
                            [data]="hygienicConditionsChartData"
                            [options]="barChartOptions"
                            width="100%"
                            height="300px"
                        >
                        </p-chart>
                    </div>
                </p-card>
            </div>
        </div>

        <!-- Financial Summary -->
        <div class="financial-section" *ngIf="financialSummary?.data">
            <p-card>
                <ng-template pTemplate="header">
                    <div class="card-header">
                        <h4 class="card-title">Resumen Financiero</h4>
                        <p-button
                            icon="pi pi-refresh"
                            severity="secondary"
                            size="small"
                            (onClick)="refreshData('financial')"
                            pTooltip="Actualizar datos financieros"
                        >
                        </p-button>
                    </div>
                </ng-template>

                <!-- Métricas principales -->
                <div
                    class="financial-grid"
                    style="
                        display: grid;
                        grid-template-columns: repeat(
                            auto-fit,
                            minmax(200px, 1fr)
                        );
                        gap: 1rem;
                        margin-bottom: 1.5rem;
                    "
                >
                    <div
                        class="financial-item"
                        style="
                            text-align: center;
                            padding: 1rem;
                            background: linear-gradient(
                                135deg,
                                #f8f9fa 0%,
                                #e9ecef 100%
                            );
                            border-radius: 8px;
                            border-left: 4px solid var(--primary-color);
                        "
                    >
                        <div
                            class="financial-label"
                            style="
                                font-size: 0.85rem;
                                color: #6c757d;
                                margin-bottom: 0.5rem;
                                text-transform: uppercase;
                                letter-spacing: 0.5px;
                            "
                        >
                            Total Facturas
                        </div>
                        <div
                            class="financial-value"
                            style="
                                font-size: 2rem;
                                font-weight: bold;
                                color: #2c3e50;
                            "
                        >
                            {{ financialSummary?.data?.totalInvoices || 0 }}
                        </div>
                    </div>
                    <div
                        class="financial-item"
                        style="
                            text-align: center;
                            padding: 1rem;
                            background: linear-gradient(
                                135deg,
                                #f8f9fa 0%,
                                #e9ecef 100%
                            );
                            border-radius: 8px;
                            border-left: 4px solid #28a745;
                        "
                    >
                        <div
                            class="financial-label"
                            style="
                                font-size: 0.85rem;
                                color: #6c757d;
                                margin-bottom: 0.5rem;
                                text-transform: uppercase;
                                letter-spacing: 0.5px;
                            "
                        >
                            Monto Total
                        </div>
                        <div
                            class="financial-value"
                            style="
                                font-size: 2rem;
                                font-weight: bold;
                                color: #2c3e50;
                            "
                        >
                            ${{
                                financialSummary?.data?.totalAmount || 0
                                    | number : "1.2-2"
                            }}
                        </div>
                    </div>
                    <div
                        class="financial-item"
                        style="
                            text-align: center;
                            padding: 1rem;
                            background: linear-gradient(
                                135deg,
                                #f8f9fa 0%,
                                #e9ecef 100%
                            );
                            border-radius: 8px;
                            border-left: 4px solid #17a2b8;
                        "
                    >
                        <div
                            class="financial-label"
                            style="
                                font-size: 0.85rem;
                                color: #6c757d;
                                margin-bottom: 0.5rem;
                                text-transform: uppercase;
                                letter-spacing: 0.5px;
                            "
                        >
                            Promedio por Factura
                        </div>
                        <div
                            class="financial-value"
                            style="
                                font-size: 2rem;
                                font-weight: bold;
                                color: #2c3e50;
                            "
                        >
                            ${{
                                financialSummary?.data?.avgAmount || 0
                                    | number : "1.2-2"
                            }}
                        </div>
                    </div>
                    <div
                        class="financial-item"
                        style="
                            text-align: center;
                            padding: 1rem;
                            background: linear-gradient(
                                135deg,
                                #f8f9fa 0%,
                                #e9ecef 100%
                            );
                            border-radius: 8px;
                            border-left: 4px solid #ffc107;
                        "
                    >
                        <div
                            class="financial-label"
                            style="
                                font-size: 0.85rem;
                                color: #6c757d;
                                margin-bottom: 0.5rem;
                                text-transform: uppercase;
                                letter-spacing: 0.5px;
                            "
                        >
                            Tasa de Pago
                        </div>
                        <div
                            class="financial-value"
                            style="
                                font-size: 2rem;
                                font-weight: bold;
                                color: #2c3e50;
                            "
                        >
                            {{ getPaymentRate() | number : "1.1-1" }}%
                        </div>
                    </div>
                </div>

                <!-- Rango de montos -->
                <div
                    class="financial-range"
                    style="
                        display: grid;
                        grid-template-columns: repeat(
                            auto-fit,
                            minmax(150px, 1fr)
                        );
                        gap: 1rem;
                        margin-bottom: 1.5rem;
                    "
                >
                    <div
                        class="range-item"
                        style="
                            text-align: center;
                            padding: 0.75rem;
                            background: #f8f9fa;
                            border-radius: 8px;
                        "
                    >
                        <div
                            class="range-label"
                            style="
                                font-size: 0.8rem;
                                color: #6c757d;
                                margin-bottom: 0.25rem;
                            "
                        >
                            Monto Mínimo
                        </div>
                        <div
                            class="range-value"
                            style="
                                font-size: 1.2rem;
                                font-weight: 600;
                                color: #28a745;
                            "
                        >
                            ${{
                                financialSummary?.data?.minAmount || 0
                                    | number : "1.2-2"
                            }}
                        </div>
                    </div>
                    <div
                        class="range-item"
                        style="
                            text-align: center;
                            padding: 0.75rem;
                            background: #f8f9fa;
                            border-radius: 8px;
                        "
                    >
                        <div
                            class="range-label"
                            style="
                                font-size: 0.8rem;
                                color: #6c757d;
                                margin-bottom: 0.25rem;
                            "
                        >
                            Monto Máximo
                        </div>
                        <div
                            class="range-value"
                            style="
                                font-size: 1.2rem;
                                font-weight: 600;
                                color: #dc3545;
                            "
                        >
                            ${{
                                financialSummary?.data?.maxAmount || 0
                                    | number : "1.2-2"
                            }}
                        </div>
                    </div>
                </div>

                <!-- Desglose por estado -->
                <div
                    class="status-breakdown"
                    *ngIf="financialSummary?.data?.statusBreakdown"
                >
                    <h5 style="margin-bottom: 1rem; color: #495057">
                        Desglose por Estado
                    </h5>
                    <div class="status-grid" style="display: grid; gap: 1rem">
                        <div
                            class="status-item"
                            *ngFor="let status of getFinancialStatusArray()"
                            style="
                                display: flex;
                                justify-content: space-between;
                                align-items: center;
                                padding: 1rem;
                                background: white;
                                border-radius: 12px;
                                border-left: 4px solid var(--primary-color);
                                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.07);
                                transition: all 0.3s ease;
                                margin-bottom: 0.75rem;
                            "
                            (mouseenter)="onMouseEnter($event)"
                            (mouseleave)="onMouseLeave($event)"
                        >
                            <div class="status-info">
                                <div
                                    class="status-name"
                                    style="
                                        font-weight: 600;
                                        color: #2c3e50;
                                        margin-bottom: 0.25rem;
                                    "
                                >
                                    <i
                                        [class]="getStatusIcon(status.key)"
                                        [style.color]="
                                            getStatusColor(status.key)
                                        "
                                        style="margin-right: 0.5rem"
                                    ></i>
                                    {{ getStatusLabel(status.key) }}
                                </div>
                                <div
                                    class="status-details"
                                    style="font-size: 0.85rem; color: #6c757d"
                                >
                                    {{ status.value.count }} facturas •
                                    Promedio: ${{
                                        status.value.avgAmount
                                            | number : "1.2-2"
                                    }}
                                </div>
                            </div>

                            <div
                                class="status-amount"
                                style="text-align: right"
                            >
                                <div
                                    class="amount-value"
                                    style="
                                        font-size: 1.3rem;
                                        font-weight: bold;
                                        color: #2c3e50;
                                    "
                                >
                                    ${{
                                        status.value.amount | number : "1.2-2"
                                    }}
                                </div>
                                <div
                                    class="amount-percentage"
                                    style="font-size: 0.8rem; color: #6c757d"
                                >
                                    {{
                                        getStatusPercentage(status.value.amount)
                                            | number : "1.1-1"
                                    }}%
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Gráfico de estados financieros -->
                <div
                    class="financial-chart"
                    style="margin-top: 1.5rem"
                    *ngIf="financialStatusChartData"
                >
                    <h5 style="margin-bottom: 1rem; color: #495057">
                        Distribución por Estado
                    </h5>
                    <p-chart
                        type="pie"
                        [data]="financialStatusChartData"
                        [options]="financialChartOptions"
                        width="100%"
                        height="300px"
                    >
                    </p-chart>
                </div>
            </p-card>
        </div>

        <!-- Activity and Alerts Section -->
        <div class="activity-alerts-section">
            <div class="activity-alerts-grid">
                <!-- Recent Activity -->
                <p-card>
                    <ng-template pTemplate="header">
                        <div class="card-header">
                            <h4 class="card-title">Actividad Reciente</h4>
                            <p-button
                                icon="pi pi-refresh"
                                severity="secondary"
                                size="small"
                                (onClick)="loadRecentActivity()"
                            >
                            </p-button>
                        </div>
                    </ng-template>
                    <div class="activity-list">
                        <div
                            class="activity-item"
                            *ngFor="let activity of recentActivities"
                        >
                            <div class="activity-icon">
                                <i
                                    [class]="activity.icon"
                                    [style.color]="activity.color"
                                ></i>
                            </div>
                            <div class="activity-content">
                                <h6 class="activity-title">
                                    {{ activity.title }}
                                </h6>
                                <p class="activity-description">
                                    {{ activity.description }}
                                </p>
                                <div class="activity-meta">
                                    <span>{{
                                        activity.timestamp | date : "short"
                                    }}</span>
                                    <span>{{ activity.user }}</span>
                                </div>
                            </div>
                        </div>
                        <div
                            class="no-activity"
                            *ngIf="
                                !recentActivities ||
                                recentActivities.length === 0
                            "
                        >
                            <i class="pi pi-info-circle"></i>
                            <p>No hay actividad reciente</p>
                        </div>
                    </div>
                </p-card>

                <!-- System Alerts -->
                <p-card>
                    <ng-template pTemplate="header">
                        <div class="card-header">
                            <h4 class="card-title">Alertas del Sistema</h4>
                            <p-badge
                                [value]="systemAlerts?.length || 0"
                                severity="warning"
                                *ngIf="systemAlerts?.length"
                            >
                            </p-badge>
                        </div>
                    </ng-template>
                    <div class="alerts-list">
                        <div
                            class="alert-item"
                            *ngFor="let alert of systemAlerts"
                            [class.unread]="!alert.read"
                        >
                            <div class="alert-content">
                                <div class="alert-header">
                                    <h6 class="alert-title">
                                        {{ alert.title }}
                                    </h6>
                                    <div class="alert-actions">
                                        <p-button
                                            icon="pi pi-check"
                                            severity="success"
                                            size="small"
                                            (onClick)="markAlertAsRead(alert)"
                                            *ngIf="!alert.read"
                                        >
                                        </p-button>
                                        <p-button
                                            icon="pi pi-times"
                                            severity="danger"
                                            size="small"
                                            (onClick)="dismissAlert(alert)"
                                        >
                                        </p-button>
                                    </div>
                                </div>
                                <p class="alert-message">{{ alert.message }}</p>
                                <div class="alert-meta">
                                    <span class="alert-time">{{
                                        alert.timestamp | date : "short"
                                    }}</span>
                                    <p-badge
                                        [value]="alert.severity"
                                        [severity]="
                                            getBadgeSeverity(alert.severity)
                                        "
                                    >
                                    </p-badge>
                                </div>
                            </div>
                        </div>
                        <div
                            class="no-alerts"
                            *ngIf="!systemAlerts || systemAlerts.length === 0"
                        >
                            <i class="pi pi-check-circle"></i>
                            <p>No hay alertas pendientes</p>
                        </div>
                    </div>
                </p-card>
            </div>
        </div>
    </div>
</div>
