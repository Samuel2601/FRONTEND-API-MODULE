<div class="dashboard-container">
    <!-- Header del Dashboard -->
    <div class="dashboard-header">
        <div class="flex justify-content-between align-items-center mb-4">
            <div>
                <h1 class="text-3xl font-bold text-900 mb-2">
                    Dashboard de Faenamiento
                </h1>
                <p class="text-600 text-lg">
                    Gestión y monitoreo de procesos de faenamiento
                </p>
            </div>
            <div class="flex gap-2">
                <p-button
                    icon="pi pi-refresh"
                    label="Actualizar"
                    [loading]="loading"
                    (onClick)="refreshDashboard()"
                >
                </p-button>
                <p-button
                    icon="pi pi-plus"
                    label="Nuevo Proceso"
                    severity="success"
                    (onClick)="navigateTo('/faenamiento/procesos/nuevo')"
                >
                </p-button>
            </div>
        </div>
    </div>

    <!-- Alertas y Notificaciones -->
    <div class="alerts-section mb-4" *ngIf="alerts.length > 0">
        <div class="grid">
            <div class="col-12" *ngFor="let alert of alerts">
                <p-message [severity]="alert.severity" styleClass="w-full">
                    <div
                        class="flex justify-content-between align-items-center w-full"
                    >
                        <div class="flex align-items-center gap-3">
                            <i class="pi pi-exclamation-triangle text-xl"></i>
                            <div>
                                <div class="font-semibold">
                                    {{ alert.title }}
                                </div>
                                <div class="text-sm">{{ alert.message }}</div>
                            </div>
                            <p-chip
                                [label]="alert.count.toString()"
                                styleClass="ml-2"
                            >
                            </p-chip>
                        </div>
                        <p-button
                            *ngIf="alert.action"
                            [label]="alert.action"
                            severity="secondary"
                            size="small"
                            (onClick)="handleAlertAction(alert)"
                        >
                        </p-button>
                    </div>
                </p-message>
            </div>
        </div>
    </div>

    <!-- Tarjetas Principales -->
    <div class="main-cards mb-5">
        <div class="grid">
            <div
                class="col-12 md:col-6 lg:col-3"
                *ngFor="let card of mainCards"
            >
                <p-card
                    styleClass="dashboard-card cursor-pointer h-full"
                    (click)="navigateTo(card.route!)"
                >
                    <div class="flex justify-content-between align-items-start">
                        <div>
                            <div class="text-600 font-medium mb-2">
                                {{ card.title }}
                            </div>
                            <div class="text-900 font-bold text-2xl">
                                <span
                                    *ngIf="
                                        card.title.includes('Ingresos');
                                        else normalValue
                                    "
                                >
                                    {{ formatCurrency(card.value) }}
                                </span>
                                <ng-template #normalValue>
                                    {{ formatNumber(card.value) }}
                                    <span
                                        *ngIf="card.title.includes('Tiempo')"
                                        class="text-sm font-normal"
                                    >
                                        min</span
                                    >
                                </ng-template>
                            </div>
                            <div
                                class="text-green-500 font-medium mt-2"
                                *ngIf="card.trend"
                            >
                                <i class="pi pi-arrow-up"></i>
                                <span>{{ card.trend.value }}%</span>
                            </div>
                        </div>
                        <div
                            class="dashboard-icon"
                            [style.background-color]="card.color + '20'"
                            [style.color]="card.color"
                        >
                            <i [class]="card.icon"></i>
                        </div>
                    </div>
                </p-card>
            </div>
        </div>
    </div>

    <!-- Contenido Principal del Dashboard -->
    <div class="grid">
        <!-- Estados de Procesos -->
        <div class="col-12 lg:col-8">
            <p-card header="Estados de Procesos" styleClass="h-full">
                <div class="grid" *ngIf="!dashboardLoading; else loadingStatus">
                    <div
                        class="col-12 md:col-6 lg:col-4"
                        *ngFor="let card of statusCards"
                    >
                        <div
                            class="status-card p-3 border-1 border-200 border-round"
                        >
                            <div
                                class="flex justify-content-between align-items-center"
                            >
                                <div>
                                    <div class="text-600 text-sm mb-1">
                                        {{ card.title }}
                                    </div>
                                    <div class="text-900 font-bold text-xl">
                                        {{ card.value }}
                                    </div>
                                </div>
                                <div
                                    class="status-icon"
                                    [style.background-color]="card.color + '20'"
                                    [style.color]="card.color"
                                >
                                    <i [class]="card.icon"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <ng-template #loadingStatus>
                    <div class="grid">
                        <div
                            class="col-12 md:col-6 lg:col-4"
                            *ngFor="let item of [1, 2, 3, 4, 5, 6]"
                        >
                            <p-skeleton
                                height="80px"
                                styleClass="border-round"
                            ></p-skeleton>
                        </div>
                    </div>
                </ng-template>
            </p-card>
        </div>

        <!-- Gráfico de Estado de Procesos -->
        <div class="col-12 lg:col-4">
            <p-card header="Distribución por Estado" styleClass="h-full">
                <div
                    *ngIf="
                        !loading && processStatusChartData;
                        else loadingChart
                    "
                >
                    <p-chart
                        type="doughnut"
                        [data]="processStatusChartData"
                        [options]="chartOptions"
                        height="250px"
                    >
                    </p-chart>
                </div>

                <ng-template #loadingChart>
                    <p-skeleton
                        height="250px"
                        styleClass="border-round"
                    ></p-skeleton>
                </ng-template>
            </p-card>
        </div>

        <!-- Procesos Recientes -->
        <div class="col-12 lg:col-8">
            <p-card header="Procesos Recientes" styleClass="h-full">
                <div *ngIf="!recentProcessesLoading; else loadingProcesses">
                    <div
                        class="recent-process-item"
                        *ngFor="let process of recentProcesses"
                    >
                        <div
                            class="flex justify-content-between align-items-center p-3 border-bottom-1 border-200"
                        >
                            <div class="flex align-items-center gap-3">
                                <div class="process-avatar">
                                    <i class="pi pi-file-o"></i>
                                </div>
                                <div>
                                    <div class="font-semibold text-900">
                                        {{ process.processNumber }}
                                    </div>
                                    <div class="text-600 text-sm">
                                        {{
                                            process.introducer?.name ||
                                                process.introducer?.companyName
                                        }}
                                    </div>
                                    <div class="text-600 text-xs">
                                        {{
                                            process.createdAt
                                                | date : "dd/MM/yyyy HH:mm"
                                        }}
                                    </div>
                                </div>
                            </div>
                            <div class="flex align-items-center gap-2">
                                <p-chip
                                    [label]="
                                        slaughterService.getStatusLabel(
                                            process.overallStatus
                                        )
                                    "
                                    [class]="
                                        getSeverityClass(process.overallStatus)
                                    "
                                >
                                </p-chip>
                                <p-button
                                    icon="pi pi-arrow-right"
                                    severity="secondary"
                                    size="small"
                                    [text]="true"
                                    (onClick)="
                                        navigateTo(
                                            '/faenamiento/procesos/' +
                                                process._id
                                        )
                                    "
                                >
                                </p-button>
                            </div>
                        </div>
                    </div>

                    <div
                        class="text-center mt-3"
                        *ngIf="recentProcesses.length === 0"
                    >
                        <p class="text-600">No hay procesos recientes</p>
                    </div>

                    <div
                        class="text-center mt-3"
                        *ngIf="recentProcesses.length > 0"
                    >
                        <p-button
                            label="Ver Todos los Procesos"
                            severity="secondary"
                            [text]="true"
                            (onClick)="navigateTo('/faenamiento/procesos')"
                        >
                        </p-button>
                    </div>
                </div>

                <ng-template #loadingProcesses>
                    <div *ngFor="let item of [1, 2, 3, 4, 5]">
                        <div
                            class="flex align-items-center gap-3 p-3 border-bottom-1 border-200"
                        >
                            <p-skeleton shape="circle" size="3rem"></p-skeleton>
                            <div class="flex-1">
                                <p-skeleton
                                    width="60%"
                                    height="1rem"
                                    styleClass="mb-2"
                                ></p-skeleton>
                                <p-skeleton
                                    width="40%"
                                    height="0.8rem"
                                ></p-skeleton>
                            </div>
                            <p-skeleton width="80px" height="2rem"></p-skeleton>
                        </div>
                    </div>
                </ng-template>
            </p-card>
        </div>

        <!-- Estadísticas Rápidas -->
        <div class="col-12 lg:col-4">
            <p-card header="Estadísticas del Mes" styleClass="h-full">
                <div
                    *ngIf="!statisticsLoading && statistics; else loadingStats"
                >
                    <div class="statistic-item mb-3">
                        <div
                            class="flex justify-content-between align-items-center"
                        >
                            <span class="text-600">Animales Procesados</span>
                            <span class="font-bold text-900">{{
                                statistics.totalAnimalsProcessed
                            }}</span>
                        </div>
                    </div>

                    <div class="statistic-item mb-3">
                        <div
                            class="flex justify-content-between align-items-center"
                        >
                            <span class="text-600">Rendimiento Promedio</span>
                            <span class="font-bold text-900"
                                >{{
                                    statistics.avgYield | number : "1.1-1"
                                }}%</span
                            >
                        </div>
                    </div>

                    <div class="statistic-item mb-3">
                        <div
                            class="flex justify-content-between align-items-center"
                        >
                            <span class="text-600">Tasa de Decomiso</span>
                            <span class="font-bold text-900"
                                >{{
                                    statistics.confiscationRate
                                        | number : "1.1-1"
                                }}%</span
                            >
                        </div>
                    </div>

                    <div class="statistic-item mb-3">
                        <div
                            class="flex justify-content-between align-items-center"
                        >
                            <span class="text-600">Eficiencia del Proceso</span>
                            <span class="font-bold text-900"
                                >{{
                                    statistics.processEfficiency
                                        | number : "1.1-1"
                                }}%</span
                            >
                        </div>
                    </div>

                    <p-divider></p-divider>

                    <div class="text-center">
                        <p-button
                            label="Ver Estadísticas Completas"
                            severity="secondary"
                            [text]="true"
                            (onClick)="navigateTo('/faenamiento/estadisticas')"
                        >
                        </p-button>
                    </div>
                </div>

                <ng-template #loadingStats>
                    <div *ngFor="let item of [1, 2, 3, 4]" class="mb-3">
                        <div
                            class="flex justify-content-between align-items-center"
                        >
                            <p-skeleton width="60%" height="1rem"></p-skeleton>
                            <p-skeleton width="30%" height="1rem"></p-skeleton>
                        </div>
                    </div>
                </ng-template>
            </p-card>
        </div>

        <!-- Gráfico de Ingresos -->
        <div class="col-12 lg:col-6" *ngIf="revenueChartData">
            <p-card header="Ingresos Mensuales" styleClass="h-full">
                <div *ngIf="!loading; else loadingRevenue">
                    <p-chart
                        type="line"
                        [data]="revenueChartData"
                        [options]="chartOptions"
                        height="300px"
                    >
                    </p-chart>
                </div>

                <ng-template #loadingRevenue>
                    <p-skeleton
                        height="300px"
                        styleClass="border-round"
                    ></p-skeleton>
                </ng-template>
            </p-card>
        </div>

        <!-- Gráfico de Especies -->
        <div class="col-12 lg:col-6" *ngIf="animalSpeciesChartData">
            <p-card header="Distribución por Especies" styleClass="h-full">
                <div *ngIf="!loading; else loadingSpecies">
                    <p-chart
                        type="pie"
                        [data]="animalSpeciesChartData"
                        [options]="chartOptions"
                        height="300px"
                    >
                    </p-chart>
                </div>

                <ng-template #loadingSpecies>
                    <p-skeleton
                        height="300px"
                        styleClass="border-round"
                    ></p-skeleton>
                </ng-template>
            </p-card>
        </div>

        <!-- Resumen Financiero -->
        <div class="col-12" *ngIf="financialSummary">
            <p-card header="Resumen Financiero del Mes" styleClass="h-full">
                <div *ngIf="!financialLoading; else loadingFinancial">
                    <div class="grid">
                        <div class="col-12 md:col-6 lg:col-3">
                            <div class="financial-metric">
                                <div class="text-600 text-sm mb-1">
                                    Total Facturas
                                </div>
                                <div class="text-900 font-bold text-xl">
                                    {{ financialSummary.totalInvoices }}
                                </div>
                            </div>
                        </div>

                        <div class="col-12 md:col-6 lg:col-3">
                            <div class="financial-metric">
                                <div class="text-600 text-sm mb-1">
                                    Monto Total
                                </div>
                                <div class="text-900 font-bold text-xl">
                                    {{
                                        formatCurrency(
                                            financialSummary.totalAmount
                                        )
                                    }}
                                </div>
                            </div>
                        </div>

                        <div class="col-12 md:col-6 lg:col-3">
                            <div class="financial-metric">
                                <div class="text-600 text-sm mb-1">Pagado</div>
                                <div class="text-green-600 font-bold text-xl">
                                    {{
                                        formatCurrency(
                                            financialSummary.totalPaid
                                        )
                                    }}
                                </div>
                            </div>
                        </div>

                        <div class="col-12 md:col-6 lg:col-3">
                            <div class="financial-metric">
                                <div class="text-600 text-sm mb-1">
                                    Pendiente
                                </div>
                                <div class="text-orange-600 font-bold text-xl">
                                    {{
                                        formatCurrency(
                                            financialSummary.totalPending
                                        )
                                    }}
                                </div>
                            </div>
                        </div>
                    </div>

                    <p-divider></p-divider>

                    <div class="grid">
                        <div class="col-12 md:col-6">
                            <h5 class="text-900 mb-3">Por Tipo de Factura</h5>
                            <div
                                class="invoice-type-item mb-2"
                                *ngFor="
                                    let type of [
                                        {
                                            key: 'inscription',
                                            label: 'Inscripción',
                                            data: financialSummary.byType
                                                .inscription
                                        },
                                        {
                                            key: 'slaughterService',
                                            label: 'Faenamiento',
                                            data: financialSummary.byType
                                                .slaughterService
                                        },
                                        {
                                            key: 'additionalService',
                                            label: 'Servicios Adicionales',
                                            data: financialSummary.byType
                                                .additionalService
                                        },
                                        {
                                            key: 'fine',
                                            label: 'Multas',
                                            data: financialSummary.byType.fine
                                        }
                                    ]
                                "
                            >
                                <div
                                    class="flex justify-content-between align-items-center"
                                >
                                    <span class="text-600">{{
                                        type.label
                                    }}</span>
                                    <div class="text-right">
                                        <div class="font-bold text-900">
                                            {{
                                                formatCurrency(type.data.amount)
                                            }}
                                        </div>
                                        <div class="text-600 text-sm">
                                            {{ type.data.count }} facturas
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-12 md:col-6">
                            <h5 class="text-900 mb-3">Por Estado</h5>
                            <div
                                class="invoice-status-item mb-2"
                                *ngFor="
                                    let status of [
                                        {
                                            key: 'paid',
                                            label: 'Pagadas',
                                            data: financialSummary.byStatus
                                                .paid,
                                            color: 'text-green-600'
                                        },
                                        {
                                            key: 'pending',
                                            label: 'Pendientes',
                                            data: financialSummary.byStatus
                                                .pending,
                                            color: 'text-orange-600'
                                        },
                                        {
                                            key: 'overdue',
                                            label: 'Vencidas',
                                            data: financialSummary.byStatus
                                                .overdue,
                                            color: 'text-red-600'
                                        },
                                        {
                                            key: 'partial',
                                            label: 'Parciales',
                                            data: financialSummary.byStatus
                                                .partial,
                                            color: 'text-blue-600'
                                        }
                                    ]
                                "
                            >
                                <div
                                    class="flex justify-content-between align-items-center"
                                >
                                    <span class="text-600">{{
                                        status.label
                                    }}</span>
                                    <div class="text-right">
                                        <div
                                            class="font-bold"
                                            [class]="status.color"
                                        >
                                            {{
                                                formatCurrency(
                                                    status.data.amount
                                                )
                                            }}
                                        </div>
                                        <div class="text-600 text-sm">
                                            {{ status.data.count }} facturas
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <ng-template #loadingFinancial>
                    <div class="grid">
                        <div
                            class="col-12 md:col-6 lg:col-3"
                            *ngFor="let item of [1, 2, 3, 4]"
                        >
                            <p-skeleton
                                height="60px"
                                styleClass="border-round"
                            ></p-skeleton>
                        </div>
                    </div>
                </ng-template>
            </p-card>
        </div>
    </div>

    <!-- Acciones Rápidas -->
    <div class="quick-actions mt-5">
        <p-card header="Acciones Rápidas">
            <div class="grid">
                <div class="col-12 md:col-6 lg:col-3">
                    <p-button
                        label="Nuevo Proceso"
                        icon="pi pi-plus"
                        styleClass="w-full"
                        severity="success"
                        (onClick)="navigateTo('/faenamiento/procesos/nuevo')"
                    >
                    </p-button>
                </div>

                <div class="col-12 md:col-6 lg:col-3">
                    <p-button
                        label="Registrar Introductor"
                        icon="pi pi-user-plus"
                        styleClass="w-full"
                        severity="info"
                        (onClick)="
                            navigateTo('/faenamiento/introductores/nuevo')
                        "
                    >
                    </p-button>
                </div>

                <div class="col-12 md:col-6 lg:col-3">
                    <p-button
                        label="Ver Facturas"
                        icon="pi pi-file"
                        styleClass="w-full"
                        [outlined]="true"
                        (onClick)="navigateTo('/faenamiento/facturas')"
                    >
                    </p-button>
                </div>

                <div class="col-12 md:col-6 lg:col-3">
                    <p-button
                        label="Configurar Tarifas"
                        icon="pi pi-cog"
                        styleClass="w-full"
                        [outlined]="true"
                        (onClick)="navigateTo('/faenamiento/tarifas')"
                    >
                    </p-button>
                </div>
            </div>
        </p-card>
    </div>
</div>

<!-- Toast para notificaciones -->
<p-toast></p-toast>
