<div class="rate-details-container">
    <!-- Header -->
    <div class="page-header">
        <div class="flex justify-content-between align-items-center">
            <div>
                <h1>Detalles de Tarifas</h1>
                <p class="subtitle">
                    Configuración específica de cálculos y condiciones
                </p>
            </div>
            <div class="header-actions">
                <p-button
                    label="Nuevo Detalle"
                    icon="pi pi-plus"
                    (click)="openCreateForm()"
                >
                </p-button>
            </div>
        </div>
    </div>

    <!-- Filters -->
    <p-card styleClass="filters-card">
        <div class="filters-content">
            <div class="grid">
                <div class="col-12 md:col-3">
                    <label>Buscar</label>
                    <input
                        type="text"
                        pInputText
                        [(ngModel)]="filters.search"
                        placeholder="Descripción..."
                        (input)="onFilterChange()"
                        styleClass="w-full"
                    />
                </div>

                <div class="col-12 md:col-3">
                    <label>Tarifa</label>
                    <p-dropdown
                        [(ngModel)]="filters.rateId"
                        [options]="rateOptions"
                        placeholder="Todas las tarifas"
                        (onChange)="onFilterChange()"
                        styleClass="w-full"
                        [showClear]="true"
                    >
                    </p-dropdown>
                </div>

                <div class="col-12 md:col-2">
                    <label>Unidad</label>
                    <p-dropdown
                        [(ngModel)]="filters.unit"
                        [options]="unitOptions"
                        placeholder="Todas"
                        (onChange)="onFilterChange()"
                        styleClass="w-full"
                        [showClear]="true"
                    >
                    </p-dropdown>
                </div>

                <div class="col-12 md:col-2">
                    <label>Tipo Cálculo</label>
                    <p-dropdown
                        [(ngModel)]="filters.isFormula"
                        [options]="calculationTypeOptions"
                        placeholder="Todos"
                        (onChange)="onFilterChange()"
                        styleClass="w-full"
                        [showClear]="true"
                    >
                    </p-dropdown>
                </div>

                <div class="col-12 md:col-2">
                    <label>Estado</label>
                    <p-multiSelect
                        [(ngModel)]="filters.isActive"
                        [options]="statusOptions"
                        placeholder="Todos"
                        (onChange)="onFilterChange()"
                        styleClass="w-full"
                        [showClear]="true"
                    >
                    </p-multiSelect>
                </div>
            </div>
        </div>
    </p-card>

    <!-- Data Table -->
    <p-card styleClass="table-card">
        <p-table
            [value]="filteredRateDetails"
            [loading]="loading"
            [paginator]="true"
            [rows]="pageSize"
            [totalRecords]="totalRecords"
            [rowsPerPageOptions]="[10, 25, 50]"
            [showCurrentPageReport]="true"
            currentPageReportTemplate="Mostrando {first} a {last} de {totalRecords} detalles"
            responsiveLayout="scroll"
            [scrollable]="true"
            scrollHeight="calc(100vh - 400px)"
            styleClass="rate-details-table"
        >
            <ng-template pTemplate="header">
                <tr>
                    <th pSortableColumn="rate">
                        Tarifa <p-sortIcon field="rate"></p-sortIcon>
                    </th>
                    <th pSortableColumn="description">
                        Descripción
                        <p-sortIcon field="description"></p-sortIcon>
                    </th>
                    <th pSortableColumn="unit">
                        Unidad <p-sortIcon field="unit"></p-sortIcon>
                    </th>
                    <th>Tipo Cálculo</th>
                    <th>Valor</th>
                    <th pSortableColumn="effectiveDate">
                        Vigencia
                        <p-sortIcon field="effectiveDate"></p-sortIcon>
                    </th>
                    <th pSortableColumn="isActive">
                        Estado <p-sortIcon field="isActive"></p-sortIcon>
                    </th>
                    <th>Acciones</th>
                </tr>
            </ng-template>

            <ng-template pTemplate="body" let-detail>
                <tr>
                    <td>
                        <div class="rate-info">
                            <span class="rate-code">{{
                                detail.rate.type
                            }}</span>
                            <br />
                            <p-tag class="rate-id">
                                {{ detail.rate.code }}
                            </p-tag>
                        </div>
                    </td>
                    <td>
                        <span class="detail-description">{{
                            detail.description
                        }}</span>
                    </td>
                    <td>
                        <p-tag
                            [value]="detail.unit"
                            [severity]="getUnitSeverity(detail.unit)"
                        >
                        </p-tag>
                    </td>
                    <td>
                        <p-tag
                            [value]="getCalculationType(detail)"
                            [severity]="
                                getCalculationTypeSeverity(detail.isFormula)
                            "
                        >
                        </p-tag>
                    </td>
                    <td>
                        <div class="value-cell">
                            <span class="default-value">{{
                                formatValue(detail)
                            }}</span>
                        </div>
                    </td>
                    <td>
                        <div class="date-cell">
                            <span class="effective-date">{{
                                formatEffectiveDate(detail.effectiveDate)
                            }}</span>
                            <small class="version-info"
                                >v{{ detail.version }}</small
                            >
                        </div>
                    </td>
                    <td>
                        <p-tag
                            [value]="detail.isActive ? 'ACTIVO' : 'INACTIVO'"
                            [severity]="detail.isActive ? 'success' : 'danger'"
                            (click)="toggleStatus(detail)"
                            [style]="{ cursor: 'pointer' }"
                            pTooltip="Click para cambiar estado"
                        >
                        </p-tag>
                    </td>
                    <td>
                        <div class="action-buttons">
                            <p-button
                                icon="pi pi-eye"
                                severity="secondary"
                                [text]="true"
                                size="small"
                                pTooltip="Ver detalles"
                                (click)="viewDetail(detail)"
                            >
                            </p-button>
                            <p-button
                                icon="pi pi-pencil"
                                severity="secondary"
                                [text]="true"
                                size="small"
                                pTooltip="Editar"
                                (click)="editDetail(detail)"
                            >
                            </p-button>
                            <p-button
                                icon="pi pi-calculator"
                                [severity]="
                                    detail.isFormula ? 'info' : 'secondary'
                                "
                                [text]="true"
                                size="small"
                                pTooltip="Calcular"
                                (click)="testCalculation(detail)"
                            >
                            </p-button>
                            <p-button
                                icon="pi pi-trash"
                                severity="danger"
                                [text]="true"
                                size="small"
                                pTooltip="Eliminar"
                                (click)="deleteDetail(detail)"
                            >
                            </p-button>
                        </div>
                    </td>
                </tr>
            </ng-template>

            <ng-template pTemplate="emptymessage">
                <tr>
                    <td colspan="8" class="text-center">
                        <div class="empty-state">
                            <i class="pi pi-list empty-icon"></i>
                            <h3>No hay detalles de tarifa configurados</h3>
                            <p>Comience creando el primer detalle de tarifa</p>
                            <p-button
                                label="Crear Detalle"
                                icon="pi pi-plus"
                                (click)="openCreateForm()"
                            >
                            </p-button>
                        </div>
                    </td>
                </tr>
            </ng-template>
        </p-table>
    </p-card>
</div>

<!-- Rate Detail Form Dialog -->
<p-dialog
    [header]="dialogTitle"
    [(visible)]="showFormDialog"
    [modal]="true"
    [draggable]="false"
    [style]="{ width: '900px' }"
    [maximizable]="true"
    styleClass="rate-detail-form-dialog"
>
    <app-rate-detail-form
        [rateDetail]="selectedDetail"
        [mode]="formMode"
        [rates]="rates"
        (save)="onDetailSave($event)"
        (cancel)="onFormCancel()"
    >
    </app-rate-detail-form>
</p-dialog>

<!-- Formula/Calculation Dialog -->
<p-dialog
    header="Cálculo de Tarifa"
    [(visible)]="showFormulaDialog"
    [modal]="true"
    [draggable]="false"
    [style]="{ width: '700px' }"
    styleClass="formula-dialog"
>
    <div class="formula-content" *ngIf="selectedDetail">
        <div class="formula-info">
            <h4>{{ selectedDetail.description }}</h4>
            <div class="info-grid">
                <div class="info-item">
                    <label>Unidad:</label>
                    <span>{{ selectedDetail.unit }}</span>
                </div>
                <div class="info-item">
                    <label>Tipo:</label>
                    <span>{{ getCalculationType(selectedDetail) }}</span>
                </div>
                <div class="info-item" *ngIf="!selectedDetail.isFormula">
                    <label>Valor Fijo:</label>
                    <span class="value">{{
                        selectedDetail.fixedValue
                            | currency : "USD" : "symbol" : "1.2-4"
                    }}</span>
                </div>
            </div>
        </div>

        <div
            class="formula-display"
            *ngIf="selectedDetail.isFormula && selectedDetail.formulaText"
        >
            <h5>Fórmula:</h5>
            <pre><code>{{ selectedDetail.formulaText }}</code></pre>
        </div>

        <div class="formula-test">
            <h5>Probar Cálculo:</h5>
            <div class="grid">
                <div class="col-12 md:col-6">
                    <label>Cantidad</label>
                    <p-inputNumber
                        [(ngModel)]="testData.quantity"
                        [minFractionDigits]="0"
                        [maxFractionDigits]="4"
                        styleClass="w-full"
                    >
                    </p-inputNumber>
                </div>
                <div class="col-12 md:col-6">
                    <label>Peso (kg)</label>
                    <p-inputNumber
                        [(ngModel)]="testData.weight"
                        [minFractionDigits]="0"
                        [maxFractionDigits]="2"
                        styleClass="w-full"
                    >
                    </p-inputNumber>
                </div>
            </div>
            <div class="test-actions">
                <p-button
                    label="Calcular"
                    icon="pi pi-calculator"
                    [loading]="calculating"
                    (click)="calculateTestValue()"
                >
                </p-button>
            </div>
            <div class="test-result" *ngIf="calculationResult">
                <h6>Resultado del Cálculo:</h6>

                <div class="result-summary">
                    <div class="result-value">
                        {{
                            calculationResult.calculation.totalValue
                                | currency : "USD" : "symbol" : "1.2-4"
                        }}
                    </div>
                    <div class="result-unit">
                        {{ calculationResult.calculation.amount }} ×
                        {{
                            calculationResult.calculation.unitValue
                                | currency : "USD" : "symbol" : "1.2-4"
                        }}
                        / {{ calculationResult.calculation.unit }}
                    </div>
                </div>

                <div
                    class="result-details"
                    *ngIf="calculationResult.calculation.message"
                >
                    <small>{{ calculationResult.calculation.message }}</small>
                </div>

                <div
                    class="result-applicable"
                    *ngIf="!calculationResult.calculation.applicable"
                >
                    <p-message
                        severity="warn"
                        text="Este detalle no es aplicable según las condiciones definidas"
                    ></p-message>
                </div>
            </div>
        </div>
    </div>

    <ng-template pTemplate="footer">
        <p-button
            label="Cerrar"
            severity="secondary"
            (click)="showFormulaDialog = false"
        >
        </p-button>
    </ng-template>
</p-dialog>

<!-- Delete Confirmation -->
<p-confirmDialog
    [style]="{ width: '450px' }"
    [baseZIndex]="10000"
    rejectButtonStyleClass="p-button-text"
>
</p-confirmDialog>
