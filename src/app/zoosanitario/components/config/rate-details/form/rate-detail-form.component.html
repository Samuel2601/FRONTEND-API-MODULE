<div class="rate-detail-form">
    <form [formGroup]="detailForm" (ngSubmit)="onSubmit()">
        <p-tabView styleClass="form-tabs">
            <!-- Información Básica -->
            <p-tabPanel
                header="Información Básica"
                leftIcon="pi pi-info-circle"
            >
                <div class="grid">
                    <div class="col-12">
                        <div class="field">
                            <label for="rate">Tarifa *</label>
                            <p-dropdown
                                id="rate"
                                formControlName="rate"
                                [options]="rateOptions"
                                placeholder="Seleccionar tarifa"
                                [disabled]="mode === 'view'"
                                styleClass="w-full"
                            >
                            </p-dropdown>
                            <small
                                class="p-error"
                                *ngIf="isFieldInvalid('rate')"
                            >
                                {{ getFieldError("rate") }}
                            </small>
                        </div>
                    </div>

                    <div class="col-12">
                        <div class="field">
                            <label for="description">Descripción *</label>
                            <textarea
                                id="description"
                                style="width: 100%"
                                formControlName="description"
                                [rows]="3"
                                placeholder="Descripción detallada del detalle de tarifa"
                                styleClass="w-full"
                            >
                            </textarea>
                            <small
                                class="p-error"
                                *ngIf="isFieldInvalid('description')"
                            >
                                {{ getFieldError("description") }}
                            </small>
                        </div>
                    </div>

                    <div class="col-12 md:col-6">
                        <div class="field">
                            <label for="unit">Unidad *</label>
                            <p-dropdown
                                id="unit"
                                formControlName="unit"
                                [options]="unitOptions"
                                placeholder="Seleccionar unidad"
                                [disabled]="mode === 'view'"
                                styleClass="w-full"
                            >
                            </p-dropdown>
                            <small class="help-text"
                                >Define cómo se calcula el valor</small
                            >
                            <small
                                class="p-error"
                                *ngIf="isFieldInvalid('unit')"
                            >
                                {{ getFieldError("unit") }}
                            </small>
                        </div>
                    </div>

                    <div class="col-12 md:col-6">
                        <div class="field">
                            <label for="isActive">Estado</label>
                            <div class="status-toggle">
                                <p-inputSwitch
                                    id="isActive"
                                    formControlName="isActive"
                                    [disabled]="mode === 'view'"
                                >
                                </p-inputSwitch>
                                <span class="status-label">
                                    {{
                                        detailForm.get("isActive")?.value
                                            ? "Activo"
                                            : "Inactivo"
                                    }}
                                </span>
                            </div>
                        </div>
                    </div>

                    <div class="col-12 md:col-6">
                        <div class="field">
                            <label for="effectiveDate">Fecha Efectiva *</label>
                            <p-calendar
                                id="effectiveDate"
                                formControlName="effectiveDate"
                                [showIcon]="true"
                                dateFormat="dd/mm/yy"
                                [disabled]="mode === 'view'"
                                styleClass="w-full"
                            >
                            </p-calendar>
                            <small
                                class="p-error"
                                *ngIf="isFieldInvalid('effectiveDate')"
                            >
                                {{ getFieldError("effectiveDate") }}
                            </small>
                        </div>
                    </div>

                    <div class="col-12 md:col-6">
                        <div class="field">
                            <label for="expirationDate">Fecha Expiración</label>
                            <p-calendar
                                id="expirationDate"
                                formControlName="expirationDate"
                                [showIcon]="true"
                                dateFormat="dd/mm/yy"
                                [disabled]="mode === 'view'"
                                styleClass="w-full"
                                [showClear]="true"
                            >
                            </p-calendar>
                        </div>
                    </div>
                </div>
            </p-tabPanel>

            <!-- Valor o Fórmula -->
            <p-tabPanel header="Valor o Fórmula" leftIcon="pi pi-calculator">
                <div class="grid">
                    <div class="col-12">
                        <div class="field">
                            <label for="isFormula">Tipo de Cálculo</label>
                            <div class="calculation-type">
                                <p-inputSwitch
                                    id="isFormula"
                                    formControlName="isFormula"
                                    [disabled]="mode === 'view'"
                                >
                                </p-inputSwitch>
                                <span class="calculation-label">
                                    {{
                                        detailForm.get("isFormula")?.value
                                            ? "Usar Fórmula"
                                            : "Valor Fijo"
                                    }}
                                </span>
                            </div>
                        </div>
                    </div>

                    <div class="col-12" *ngIf="!isFormulaMode">
                        <div class="field">
                            <label for="fixedValue">Valor Fijo *</label>
                            <p-inputNumber
                                id="fixedValue"
                                formControlName="fixedValue"
                                mode="currency"
                                currency="USD"
                                [minFractionDigits]="2"
                                [maxFractionDigits]="4"
                                styleClass="w-full"
                            >
                            </p-inputNumber>
                            <small
                                class="p-error"
                                *ngIf="isFieldInvalid('fixedValue')"
                            >
                                {{ getFieldError("fixedValue") }}
                            </small>
                        </div>
                    </div>

                    <div class="col-12" *ngIf="isFormulaMode">
                        <div class="field">
                            <label for="formulaText">Fórmula *</label>
                            <textarea
                                id="formulaText"
                                style="width: 100%"
                                formControlName="formulaText"
                                [rows]="5"
                                placeholder="Ingrese la fórmula de cálculo"
                                styleClass="w-full font-monospace"
                            >
                            </textarea>
                            <small class="help-text">
                                Variables disponibles: quantity, weight, days,
                                fixedValue
                            </small>
                            <small
                                class="p-error"
                                *ngIf="isFieldInvalid('formulaText')"
                            >
                                {{ getFieldError("formulaText") }}
                            </small>
                        </div>
                    </div>

                    <div class="col-12">
                        <div class="value-preview">
                            <h4>Vista Previa</h4>
                            <div class="preview-content">
                                <div class="preview-item">
                                    <label>Unidad:</label>
                                    <span>{{ getUnitTypeLabel() }}</span>
                                </div>
                                <div class="preview-item">
                                    <label>Valor:</label>
                                    <span class="value">{{
                                        formatPreviewValue()
                                    }}</span>
                                </div>
                                <div class="preview-item">
                                    <label>Versión:</label>
                                    <span>{{
                                        detailForm.get("version")?.value
                                    }}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="formula-test" *ngIf="isFormulaMode">
                    <h4>Probar Fórmula</h4>
                    <div class="grid">
                        <div class="col-12 md:col-3">
                            <label>Cantidad</label>
                            <p-inputNumber
                                [(ngModel)]="testValues.quantity"
                                [minFractionDigits]="0"
                                [maxFractionDigits]="2"
                                [ngModelOptions]="{ standalone: true }"
                                styleClass="w-full"
                            >
                            </p-inputNumber>
                        </div>
                        <div class="col-12 md:col-3">
                            <label>Peso (kg)</label>
                            <p-inputNumber
                                [(ngModel)]="testValues.weight"
                                [minFractionDigits]="0"
                                [maxFractionDigits]="2"
                                [ngModelOptions]="{ standalone: true }"
                                styleClass="w-full"
                            >
                            </p-inputNumber>
                        </div>
                        <div class="col-12 md:col-3">
                            <label>Días</label>
                            <p-inputNumber
                                [(ngModel)]="testValues.days"
                                [minFractionDigits]="0"
                                [maxFractionDigits]="0"
                                [ngModelOptions]="{ standalone: true }"
                                styleClass="w-full"
                            >
                            </p-inputNumber>
                        </div>
                        <div class="col-12 md:col-3">
                            <div class="test-actions">
                                <p-button
                                    label="Probar"
                                    icon="pi pi-play"
                                    [disabled]="
                                        mode === 'view' ||
                                        !detailForm.get('formulaText')?.value
                                    "
                                    [loading]="testing"
                                    (click)="testFormula()"
                                    styleClass="w-full"
                                >
                                </p-button>
                            </div>
                        </div>
                    </div>

                    <div class="test-result" *ngIf="testResult">
                        <div class="result-header">
                            <h5>Resultado del Cálculo</h5>
                            <p-tag
                                [value]="
                                    testResult.success ? 'VÁLIDO' : 'ERROR'
                                "
                                [severity]="
                                    testResult.success ? 'success' : 'danger'
                                "
                            >
                            </p-tag>
                        </div>
                        <div class="result-content">
                            <div
                                class="result-value"
                                *ngIf="testResult.success"
                            >
                                {{
                                    testResult.value
                                        | currency : "USD" : "symbol" : "1.2-4"
                                }}
                            </div>
                            <div
                                class="result-error"
                                *ngIf="!testResult.success"
                            >
                                {{ testResult.error }}
                            </div>
                            <div
                                class="result-details"
                                *ngIf="testResult.details"
                            >
                                <small>{{ testResult.details }}</small>
                            </div>
                        </div>
                    </div>
                </div>
            </p-tabPanel>

            <!-- Condiciones de Aplicación -->
            <p-tabPanel header="Condiciones" leftIcon="pi pi-cog">
                <div class="conditions-section">
                    <div class="section-header">
                        <h3>Condiciones de Aplicación</h3>
                        <p>
                            Define cuándo debe aplicarse este detalle de tarifa
                        </p>
                    </div>

                    <div class="condition-builder" *ngIf="mode !== 'view'">
                        <div class="grid">
                            <div class="col-12 md:col-3">
                                <p-dropdown
                                    [(ngModel)]="newCondition.field"
                                    [options]="conditionFieldOptions"
                                    placeholder="Campo"
                                    [ngModelOptions]="{ standalone: true }"
                                    styleClass="w-full"
                                >
                                </p-dropdown>
                            </div>
                            <div class="col-12 md:col-3">
                                <p-dropdown
                                    [(ngModel)]="newCondition.operator"
                                    [options]="operatorOptions"
                                    placeholder="Operador"
                                    [ngModelOptions]="{ standalone: true }"
                                    styleClass="w-full"
                                >
                                </p-dropdown>
                            </div>
                            <div class="col-12 md:col-4">
                                <input
                                    type="text"
                                    pInputText
                                    [(ngModel)]="newCondition.value"
                                    placeholder="Valor"
                                    [ngModelOptions]="{ standalone: true }"
                                    styleClass="w-full"
                                />
                            </div>
                            <div class="col-12 md:col-2">
                                <p-button
                                    icon="pi pi-plus"
                                    label="Agregar"
                                    [disabled]="!isNewConditionValid()"
                                    (click)="addCondition()"
                                    styleClass="w-full"
                                >
                                </p-button>
                            </div>
                        </div>
                    </div>

                    <div
                        class="conditions-list"
                        *ngIf="applicationConditions.length > 0"
                    >
                        <div
                            class="condition-item"
                            *ngFor="
                                let condition of applicationConditions;
                                let i = index
                            "
                        >
                            <div class="condition-content">
                                <span class="condition-field">{{
                                    getConditionFieldLabel(condition.field)
                                }}</span>
                                <span class="condition-operator">{{
                                    getOperatorLabel(condition.operator)
                                }}</span>
                                <span class="condition-value">{{
                                    condition.value
                                }}</span>
                                <span
                                    class="condition-logic"
                                    *ngIf="i < applicationConditions.length - 1"
                                >
                                    {{ condition.logicalOperator }}
                                </span>
                            </div>
                            <div
                                class="condition-actions"
                                *ngIf="mode !== 'view'"
                            >
                                <p-button
                                    icon="pi pi-trash"
                                    severity="danger"
                                    [text]="true"
                                    size="small"
                                    (click)="removeCondition(i)"
                                >
                                </p-button>
                            </div>
                        </div>
                    </div>

                    <div
                        class="empty-conditions"
                        *ngIf="applicationConditions.length === 0"
                    >
                        <i class="pi pi-info-circle"></i>
                        <p>
                            No hay condiciones configuradas. Este detalle se
                            aplicará por defecto.
                        </p>
                    </div>
                </div>
            </p-tabPanel>
        </p-tabView>

        <!-- Form Actions -->
        <div class="form-actions" *ngIf="mode !== 'view'">
            <div class="flex justify-content-end gap-2">
                <p-button
                    label="Cancelar"
                    severity="secondary"
                    [text]="true"
                    type="button"
                    (click)="onCancel()"
                >
                </p-button>
                <p-button
                    label="Validar Configuración"
                    severity="secondary"
                    icon="pi pi-check"
                    type="button"
                    [disabled]="detailForm.invalid"
                    [loading]="validating"
                    (click)="validateConfiguration()"
                >
                </p-button>
                <p-button
                    [label]="
                        mode === 'create'
                            ? 'Crear Detalle'
                            : 'Actualizar Detalle'
                    "
                    type="submit"
                    [disabled]="detailForm.invalid || saving"
                    [loading]="saving"
                >
                </p-button>
            </div>
        </div>

        <!-- View Mode Actions -->
        <div class="form-actions" *ngIf="mode === 'view'">
            <div class="flex justify-content-end gap-2">
                <p-button
                    label="Cerrar"
                    severity="secondary"
                    (click)="onCancel()"
                >
                </p-button>
                <p-button
                    label="Editar"
                    icon="pi pi-pencil"
                    (click)="switchToEditMode()"
                >
                </p-button>
            </div>
        </div>
    </form>
</div>

<!-- Validation Result Dialog -->
<p-dialog
    header="Resultado de Validación"
    [(visible)]="showValidationDialog"
    [modal]="true"
    [style]="{ width: '500px' }"
    styleClass="validation-dialog"
>
    <div class="validation-content">
        <div
            class="validation-result"
            [ngClass]="validationResult?.success ? 'success' : 'error'"
        >
            <i
                [class]="
                    validationResult?.success
                        ? 'pi pi-check-circle'
                        : 'pi pi-times-circle'
                "
            ></i>
            <div class="result-text">
                <h4>
                    {{
                        validationResult?.success
                            ? "Configuración Válida"
                            : "Error de Configuración"
                    }}
                </h4>
                <p>{{ validationResult?.message }}</p>
            </div>
        </div>

        <div class="validation-details" *ngIf="validationResult?.details">
            <h5>Detalles:</h5>
            <ul>
                <li *ngFor="let detail of validationResult.details">
                    {{ detail }}
                </li>
            </ul>
        </div>
    </div>

    <ng-template pTemplate="footer">
        <p-button label="Cerrar" (click)="showValidationDialog = false">
        </p-button>
    </ng-template>
</p-dialog>
