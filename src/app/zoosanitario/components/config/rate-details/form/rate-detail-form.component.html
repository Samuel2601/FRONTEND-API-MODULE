<div class="rate-detail-form">
    <form [formGroup]="detailForm" (ngSubmit)="onSubmit()">
        <p-tabView styleClass="form-tabs">
            <!-- Información Básica -->
            <p-tabPanel
                header="Información Básica"
                leftIcon="pi pi-info-circle"
            >
                <div class="grid">
                    <div class="col-12">
                        <div class="field">
                            <label for="rate">Tarifa *</label>
                            <p-dropdown
                                id="rate"
                                formControlName="rate"
                                [options]="rateOptions"
                                placeholder="Seleccionar tarifa"
                                [disabled]="mode === 'view'"
                                styleClass="w-full"
                            >
                            </p-dropdown>
                            <small
                                class="p-error"
                                *ngIf="isFieldInvalid('rate')"
                            >
                                {{ getFieldError("rate") }}
                            </small>
                        </div>
                    </div>

                    <div class="col-12">
                        <div class="field">
                            <label for="description">Descripción *</label>
                            <textarea
                                id="description"
                                formControlName="description"
                                [rows]="3"
                                placeholder="Descripción detallada del detalle de tarifa"
                                styleClass="w-full"
                            >
                            </textarea>
                            <small
                                class="p-error"
                                *ngIf="isFieldInvalid('description')"
                            >
                                {{ getFieldError("description") }}
                            </small>
                        </div>
                    </div>

                    <div class="col-12 md:col-6">
                        <div class="field">
                            <label for="unitType">Tipo de Unidad *</label>
                            <p-dropdown
                                id="unitType"
                                formControlName="unitType"
                                [options]="unitTypeOptions"
                                placeholder="Seleccionar tipo"
                                [disabled]="mode === 'view'"
                                styleClass="w-full"
                            >
                            </p-dropdown>
                            <small class="help-text"
                                >Define cómo se calcula el valor</small
                            >
                            <small
                                class="p-error"
                                *ngIf="isFieldInvalid('unitType')"
                            >
                                {{ getFieldError("unitType") }}
                            </small>
                        </div>
                    </div>

                    <div class="col-12 md:col-6">
                        <div class="field">
                            <label for="isActive">Estado</label>
                            <div class="status-toggle">
                                <p-inputSwitch
                                    id="isActive"
                                    formControlName="isActive"
                                    [disabled]="mode === 'view'"
                                >
                                </p-inputSwitch>
                                <span class="status-label">
                                    {{
                                        detailForm.get("isActive")?.value
                                            ? "Activo"
                                            : "Inactivo"
                                    }}
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            </p-tabPanel>

            <!-- Valores y Límites -->
            <p-tabPanel header="Valores y Límites" leftIcon="pi pi-calculator">
                <div class="grid">
                    <div class="col-12 md:col-4">
                        <div class="field">
                            <label for="defaultValue"
                                >Valor Por Defecto *</label
                            >
                            <p-inputNumber
                                id="defaultValue"
                                formControlName="defaultValue"
                                [mode]="getNumberMode()"
                                [currency]="getCurrency()"
                                [minFractionDigits]="getMinDecimals()"
                                [maxFractionDigits]="getMaxDecimals()"
                                styleClass="w-full"
                            >
                            </p-inputNumber>
                            <small
                                class="p-error"
                                *ngIf="isFieldInvalid('defaultValue')"
                            >
                                {{ getFieldError("defaultValue") }}
                            </small>
                        </div>
                    </div>

                    <div class="col-12 md:col-4">
                        <div class="field">
                            <label for="minimumValue">Valor Mínimo</label>
                            <p-inputNumber
                                id="minimumValue"
                                formControlName="minimumValue"
                                [mode]="getNumberMode()"
                                [currency]="getCurrency()"
                                [minFractionDigits]="getMinDecimals()"
                                [maxFractionDigits]="getMaxDecimals()"
                                styleClass="w-full"
                            >
                            </p-inputNumber>
                        </div>
                    </div>

                    <div class="col-12 md:col-4">
                        <div class="field">
                            <label for="maximumValue">Valor Máximo</label>
                            <p-inputNumber
                                id="maximumValue"
                                formControlName="maximumValue"
                                [mode]="getNumberMode()"
                                [currency]="getCurrency()"
                                [minFractionDigits]="getMinDecimals()"
                                [maxFractionDigits]="getMaxDecimals()"
                                styleClass="w-full"
                            >
                            </p-inputNumber>
                        </div>
                    </div>

                    <div class="col-12">
                        <div class="value-preview">
                            <h4>Vista Previa del Cálculo</h4>
                            <div class="preview-content">
                                <div class="preview-item">
                                    <label>Tipo:</label>
                                    <span>{{ getUnitTypeLabel() }}</span>
                                </div>
                                <div class="preview-item">
                                    <label>Valor:</label>
                                    <span class="value">{{
                                        formatPreviewValue()
                                    }}</span>
                                </div>
                                <div class="preview-item" *ngIf="hasLimits()">
                                    <label>Límites:</label>
                                    <span>{{ formatLimits() }}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </p-tabPanel>

            <!-- Fórmula de Cálculo -->
            <p-tabPanel header="Fórmula de Cálculo" leftIcon="pi pi-code">
                <div class="formula-section">
                    <div class="section-header">
                        <h3>Configuración de Fórmula</h3>
                        <p>
                            Define cómo se calculará el valor final basado en
                            variables dinámicas
                        </p>
                    </div>

                    <div class="formula-builder">
                        <div class="grid">
                            <div class="col-12 md:col-6">
                                <div class="field">
                                    <label>Tipo de Fórmula</label>
                                    <p-dropdown
                                        [(ngModel)]="formulaType"
                                        [options]="formulaTypeOptions"
                                        placeholder="Seleccionar tipo"
                                        [disabled]="mode === 'view'"
                                        [ngModelOptions]="{ standalone: true }"
                                        (onChange)="onFormulaTypeChange()"
                                        styleClass="w-full"
                                    >
                                    </p-dropdown>
                                </div>
                            </div>

                            <div class="col-12 md:col-6" *ngIf="formulaType">
                                <div class="field">
                                    <label>Variables Disponibles</label>
                                    <p-multiSelect
                                        [(ngModel)]="selectedVariables"
                                        [options]="availableVariables"
                                        placeholder="Seleccionar variables"
                                        [disabled]="mode === 'view'"
                                        [ngModelOptions]="{ standalone: true }"
                                        styleClass="w-full"
                                    >
                                    </p-multiSelect>
                                </div>
                            </div>
                        </div>

                        <div
                            class="formula-editor"
                            *ngIf="formulaType === 'custom'"
                        >
                            <label>Fórmula Personalizada</label>
                            <p-editor
                                [(ngModel)]="customFormula"
                                [style]="{ height: '200px' }"
                                [ngModelOptions]="{ standalone: true }"
                            >
                            </p-editor>
                            <small class="help-text">
                                Use variables como {{ "{quantity}" }} o
                                {{ "{weight}" }}. Ejemplo: defaultValue *
                                {{ "{quantity}" }}
                            </small>
                        </div>

                        <div
                            class="formula-templates"
                            *ngIf="formulaType === 'template'"
                        >
                            <label>Plantillas Predefinidas</label>
                            <div class="template-grid">
                                <div
                                    class="template-item"
                                    *ngFor="let template of formulaTemplates"
                                    [class.selected]="
                                        selectedTemplate === template.id
                                    "
                                    (click)="selectTemplate(template)"
                                >
                                    <h5>{{ template.name }}</h5>
                                    <p>{{ template.description }}</p>
                                    <code>{{ template.formula }}</code>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="formula-test" *ngIf="hasFormula()">
                        <h4>Probar Fórmula</h4>
                        <div class="grid">
                            <div class="col-12 md:col-3">
                                <label>Cantidad</label>
                                <p-inputNumber
                                    [(ngModel)]="testValues.quantity"
                                    [minFractionDigits]="0"
                                    [maxFractionDigits]="2"
                                    [ngModelOptions]="{ standalone: true }"
                                    styleClass="w-full"
                                >
                                </p-inputNumber>
                            </div>
                            <div class="col-12 md:col-3">
                                <label>Peso (kg)</label>
                                <p-inputNumber
                                    [(ngModel)]="testValues.weight"
                                    [minFractionDigits]="0"
                                    [maxFractionDigits]="2"
                                    [ngModelOptions]="{ standalone: true }"
                                    styleClass="w-full"
                                >
                                </p-inputNumber>
                            </div>
                            <div class="col-12 md:col-3">
                                <label>Días</label>
                                <p-inputNumber
                                    [(ngModel)]="testValues.days"
                                    [minFractionDigits]="0"
                                    [maxFractionDigits]="0"
                                    [ngModelOptions]="{ standalone: true }"
                                    styleClass="w-full"
                                >
                                </p-inputNumber>
                            </div>
                            <div class="col-12 md:col-3">
                                <div class="test-actions">
                                    <p-button
                                        label="Calcular"
                                        icon="pi pi-calculator"
                                        [disabled]="mode === 'view'"
                                        [loading]="testing"
                                        (click)="testFormula()"
                                        styleClass="w-full"
                                    >
                                    </p-button>
                                </div>
                            </div>
                        </div>

                        <div class="test-result" *ngIf="testResult">
                            <div class="result-header">
                                <h5>Resultado del Cálculo</h5>
                                <p-tag
                                    [value]="
                                        testResult.success ? 'VÁLIDO' : 'ERROR'
                                    "
                                    [severity]="
                                        testResult.success
                                            ? 'success'
                                            : 'danger'
                                    "
                                >
                                </p-tag>
                            </div>
                            <div class="result-content">
                                <div
                                    class="result-value"
                                    *ngIf="testResult.success"
                                >
                                    {{
                                        testResult.value
                                            | currency
                                                : "USD"
                                                : "symbol"
                                                : "1.2-4"
                                    }}
                                </div>
                                <div
                                    class="result-error"
                                    *ngIf="!testResult.success"
                                >
                                    {{ testResult.error }}
                                </div>
                                <div
                                    class="result-details"
                                    *ngIf="testResult.details"
                                >
                                    <small>{{ testResult.details }}</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </p-tabPanel>

            <!-- Condiciones de Aplicación -->
            <p-tabPanel header="Condiciones" leftIcon="pi pi-cog">
                <div class="conditions-section">
                    <div class="section-header">
                        <h3>Condiciones de Aplicación</h3>
                        <p>
                            Define cuándo debe aplicarse este detalle de tarifa
                        </p>
                    </div>

                    <div class="condition-builder" *ngIf="mode !== 'view'">
                        <div class="grid">
                            <div class="col-12 md:col-3">
                                <p-dropdown
                                    [(ngModel)]="newCondition.field"
                                    [options]="conditionFieldOptions"
                                    placeholder="Campo"
                                    [ngModelOptions]="{ standalone: true }"
                                    styleClass="w-full"
                                >
                                </p-dropdown>
                            </div>
                            <div class="col-12 md:col-3">
                                <p-dropdown
                                    [(ngModel)]="newCondition.operator"
                                    [options]="operatorOptions"
                                    placeholder="Operador"
                                    [ngModelOptions]="{ standalone: true }"
                                    styleClass="w-full"
                                >
                                </p-dropdown>
                            </div>
                            <div class="col-12 md:col-4">
                                <input
                                    type="text"
                                    pInputText
                                    [(ngModel)]="newCondition.value"
                                    placeholder="Valor"
                                    [ngModelOptions]="{ standalone: true }"
                                    styleClass="w-full"
                                />
                            </div>
                            <div class="col-12 md:col-2">
                                <p-button
                                    icon="pi pi-plus"
                                    label="Agregar"
                                    [disabled]="!isNewConditionValid()"
                                    (click)="addCondition()"
                                    styleClass="w-full"
                                >
                                </p-button>
                            </div>
                        </div>
                    </div>

                    <div
                        class="conditions-list"
                        *ngIf="applicationConditions.length > 0"
                    >
                        <div
                            class="condition-item"
                            *ngFor="
                                let condition of applicationConditions;
                                let i = index
                            "
                        >
                            <div class="condition-content">
                                <span class="condition-field">{{
                                    getConditionFieldLabel(condition.field)
                                }}</span>
                                <span class="condition-operator">{{
                                    getOperatorLabel(condition.operator)
                                }}</span>
                                <span class="condition-value">{{
                                    condition.value
                                }}</span>
                                <span
                                    class="condition-logic"
                                    *ngIf="i < applicationConditions.length - 1"
                                >
                                    {{ condition.logicalOperator }}
                                </span>
                            </div>
                            <div
                                class="condition-actions"
                                *ngIf="mode !== 'view'"
                            >
                                <p-button
                                    icon="pi pi-trash"
                                    severity="danger"
                                    [text]="true"
                                    size="small"
                                    (click)="removeCondition(i)"
                                >
                                </p-button>
                            </div>
                        </div>
                    </div>

                    <div
                        class="empty-conditions"
                        *ngIf="applicationConditions.length === 0"
                    >
                        <i class="pi pi-info-circle"></i>
                        <p>
                            No hay condiciones configuradas. Este detalle se
                            aplicará por defecto.
                        </p>
                    </div>
                </div>
            </p-tabPanel>
        </p-tabView>

        <!-- Form Actions -->
        <div class="form-actions" *ngIf="mode !== 'view'">
            <div class="flex justify-content-end gap-2">
                <p-button
                    label="Cancelar"
                    severity="secondary"
                    [text]="true"
                    type="button"
                    (click)="onCancel()"
                >
                </p-button>
                <p-button
                    label="Validar Configuración"
                    severity="secondary"
                    icon="pi pi-check"
                    type="button"
                    [disabled]="detailForm.invalid"
                    [loading]="validating"
                    (click)="validateConfiguration()"
                >
                </p-button>
                <p-button
                    [label]="
                        mode === 'create'
                            ? 'Crear Detalle'
                            : 'Actualizar Detalle'
                    "
                    type="submit"
                    [disabled]="detailForm.invalid || saving"
                    [loading]="saving"
                >
                </p-button>
            </div>
        </div>

        <!-- View Mode Actions -->
        <div class="form-actions" *ngIf="mode === 'view'">
            <div class="flex justify-content-end gap-2">
                <p-button
                    label="Cerrar"
                    severity="secondary"
                    (click)="onCancel()"
                >
                </p-button>
                <p-button
                    label="Editar"
                    icon="pi pi-pencil"
                    (click)="switchToEditMode()"
                >
                </p-button>
            </div>
        </div>
    </form>
</div>

<!-- Validation Result Dialog -->
<p-dialog
    header="Resultado de Validación"
    [(visible)]="showValidationDialog"
    [modal]="true"
    [style]="{ width: '500px' }"
    styleClass="validation-dialog"
>
    <div class="validation-content">
        <div
            class="validation-result"
            [ngClass]="validationResult?.success ? 'success' : 'error'"
        >
            <i
                [class]="
                    validationResult?.success
                        ? 'pi pi-check-circle'
                        : 'pi pi-times-circle'
                "
            ></i>
            <div class="result-text">
                <h4>
                    {{
                        validationResult?.success
                            ? "Configuración Válida"
                            : "Error de Configuración"
                    }}
                </h4>
                <p>{{ validationResult?.message }}</p>
            </div>
        </div>

        <div class="validation-details" *ngIf="validationResult?.details">
            <h5>Detalles:</h5>
            <ul>
                <li *ngFor="let detail of validationResult.details">
                    {{ detail }}
                </li>
            </ul>
        </div>
    </div>

    <ng-template pTemplate="footer">
        <p-button label="Cerrar" (click)="showValidationDialog = false">
        </p-button>
    </ng-template>
</p-dialog>
