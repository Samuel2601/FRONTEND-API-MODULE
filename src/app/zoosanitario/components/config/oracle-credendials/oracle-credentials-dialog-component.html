<p-dialog
    [(visible)]="visible"
    [modal]="true"
    [style]="{ width: '500px' }"
    [draggable]="false"
    [resizable]="false"
    header="Configurar Credenciales Oracle"
    styleClass="oracle-credentials-dialog"
    (onHide)="onCancel()"
>
    <ng-template pTemplate="header">
        <div class="flex align-items-center gap-2">
            <i class="pi pi-database text-2xl text-orange-500"></i>
            <span class="font-semibold text-xl">Configurar Oracle</span>
        </div>
    </ng-template>

    <div class="flex flex-column gap-4 p-fluid">
        <!-- Mensaje informativo -->
        <p-message
            severity="info"
            text="Para continuar, necesitas configurar tus credenciales de Oracle."
            class="mb-3"
        >
        </p-message>

        <form [formGroup]="credentialsForm" class="flex flex-column gap-4">
            <!-- Usuario Oracle -->
            <div class="field">
                <label for="user" class="block text-900 font-medium mb-2">
                    <i class="pi pi-user mr-2"></i>Usuario Oracle
                </label>
                <p-iconField iconPosition="left">
                    <p-inputIcon>
                        <i class="pi pi-user"></i>
                    </p-inputIcon>
                    <input
                        pInputText
                        id="user"
                        formControlName="user"
                        placeholder="Ingresa tu usuario de Oracle"
                        [class.ng-invalid]="
                            credentialsForm.get('user')?.invalid &&
                            credentialsForm.get('user')?.touched
                        "
                        autocomplete="username"
                    />
                </p-iconField>
                <small
                    *ngIf="
                        credentialsForm.get('user')?.invalid &&
                        credentialsForm.get('user')?.touched
                    "
                    class="p-error"
                >
                    El usuario es requerido
                </small>
            </div>

            <!-- Contraseña Oracle -->
            <div class="field">
                <label for="password" class="block text-900 font-medium mb-2">
                    <i class="pi pi-lock mr-2"></i>Contraseña Oracle
                </label>
                <p-password
                    formControlName="password"
                    placeholder="Ingresa tu contraseña"
                    [toggleMask]="true"
                    [feedback]="false"
                    [class.ng-invalid]="
                        credentialsForm.get('password')?.invalid &&
                        credentialsForm.get('password')?.touched
                    "
                    autocomplete="current-password"
                    styleClass="w-full"
                >
                </p-password>
                <small
                    *ngIf="
                        credentialsForm.get('password')?.invalid &&
                        credentialsForm.get('password')?.touched
                    "
                    class="p-error"
                >
                    La contraseña es requerida
                </small>
            </div>

            <!-- String de Conexión -->
            <div class="field" style="display: none">
                <label
                    for="connectString"
                    class="block text-900 font-medium mb-2"
                >
                    <i class="pi pi-link mr-2"></i>String de Conexión
                </label>
                <p-iconField iconPosition="left">
                    <p-inputIcon>
                        <i class="pi pi-server"></i>
                    </p-inputIcon>
                    <input
                        pInputText
                        id="connectString"
                        formControlName="connectString"
                        placeholder="host:puerto/servicio"
                        [class.ng-invalid]="
                            credentialsForm.get('connectString')
                                ?.invalid &&
                            credentialsForm.get('connectString')
                                ?.touched
                        "
                        autocomplete="off"
                        pTooltip="Ejemplo: localhost:1521/ORCL"
                        tooltipPosition="bottom"
                    />
                </p-iconField>
                <small
                    *ngIf="
                        credentialsForm.get('connectString')?.invalid &&
                        credentialsForm.get('connectString')?.touched
                    "
                    class="p-error"
                >
                    El string de conexión es requerido
                </small>
                <small class="text-600 block mt-1">
                    <i class="pi pi-info-circle mr-1"></i>
                    Formato: host:puerto/servicio (ej: localhost:1521/ORCL)
                </small>
            </div>

            <!-- Divider -->
            <p-divider></p-divider>

            <!-- Botón de prueba de conectividad -->
            <div class="field">
                <p-button
                    label="Probar Conectividad"
                    icon="pi pi-wifi"
                    [loading]="testingConnection"
                    (onClick)="testConnection()"
                    [disabled]="!credentialsForm.valid"
                    severity="secondary"
                    class="w-full mb-3"
                >
                </p-button>

                <!-- Resultado del test -->
                <p-message
                    *ngIf="connectionTestResult && !testingConnection"
                    [severity]="
                        connectionTestResult.success
                            ? 'success'
                            : 'error'
                    "
                    [text]="connectionTestResult.message"
                    class="w-full"
                >
                </p-message>
            </div>
        </form>
    </div>

    <ng-template pTemplate="footer">
        <div class="flex justify-content-between">
            <p-button
                label="Cancelar"
                icon="pi pi-times"
                (onClick)="onCancel()"
                severity="secondary"
                [text]="true"
            >
            </p-button>

            <p-button
                label="Guardar y Continuar"
                icon="pi pi-check"
                (onClick)="onSave()"
                [loading]="saving"
                [disabled]="
                    !credentialsForm.valid ||
                    !connectionTestResult?.success
                "
            >
            </p-button>
        </div>
    </ng-template>
</p-dialog>
