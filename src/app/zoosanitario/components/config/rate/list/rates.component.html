<div class="rates-container">
    <!-- Header -->
    <div class="page-header">
        <div class="flex justify-content-between align-items-center">
            <div>
                <h1>Gesti贸n de Tarifas</h1>
                <p class="subtitle">
                    Administraci贸n de tarifas y precios del sistema
                </p>
            </div>
            <div class="header-actions">
                <p-button
                    label="Nueva Tarifa"
                    icon="pi pi-plus"
                    (click)="openCreateForm()"
                >
                </p-button>
            </div>
        </div>
    </div>

    <!-- Filters -->
    <p-card styleClass="filters-card">
        <div class="filters-content">
            <div class="grid">
                <div class="col-12 md:col-3">
                    <label>Buscar</label>
                    <input
                        type="text"
                        pInputText
                        [(ngModel)]="filters.search"
                        placeholder="C贸digo, nombre..."
                        (input)="onFilterChange()"
                        styleClass="w-full"
                    />
                </div>

                <div class="col-12 md:col-3">
                    <label>Tipo</label>
                    <p-dropdown
                        [(ngModel)]="filters.type"
                        [options]="typeOptions"
                        placeholder="Todos los tipos"
                        (onChange)="onFilterChange()"
                        styleClass="w-full"
                        [showClear]="true"
                    >
                    </p-dropdown>
                </div>

                <div class="col-12 md:col-3">
                    <label>Estado</label>
                    <p-dropdown
                        [(ngModel)]="filters.status"
                        [options]="statusOptions"
                        placeholder="Todos los estados"
                        (onChange)="onFilterChange()"
                        styleClass="w-full"
                        [showClear]="true"
                    >
                    </p-dropdown>
                </div>

                <div class="col-12 md:col-3">
                    <label>&nbsp;</label>
                    <div class="flex gap-2">
                        <p-button
                            label="Limpiar"
                            severity="secondary"
                            [text]="true"
                            icon="pi pi-filter-slash"
                            (click)="clearFilters()"
                            styleClass="w-full"
                        >
                        </p-button>
                    </div>
                </div>
            </div>
        </div>
    </p-card>

    <!-- Data Table -->
    <p-card styleClass="table-card">
        <p-table
            [value]="filteredRates"
            [loading]="loading"
            [paginator]="true"
            [rows]="pageSize"
            [totalRecords]="totalRecords"
            [lazy]="false"
            [rowsPerPageOptions]="[10, 25, 50]"
            [showCurrentPageReport]="true"
            currentPageReportTemplate="Mostrando {first} a {last} de {totalRecords} tarifas"
            [globalFilterFields]="['code', 'name', 'description']"
            responsiveLayout="scroll"
            [scrollable]="true"
            scrollHeight="calc(100vh - 400px)"
            styleClass="rates-table"
        >
            <ng-template pTemplate="header">
                <tr>
                    <th pSortableColumn="code">
                        C贸digo <p-sortIcon field="code"></p-sortIcon>
                    </th>
                    <th pSortableColumn="name">
                        Nombre <p-sortIcon field="name"></p-sortIcon>
                    </th>
                    <th pSortableColumn="type">
                        Tipo <p-sortIcon field="type"></p-sortIcon>
                    </th>
                    <th pSortableColumn="status">
                        Estado <p-sortIcon field="status"></p-sortIcon>
                    </th>
                    <th pSortableColumn="effectiveFrom">
                        Vigencia <p-sortIcon field="effectiveFrom"></p-sortIcon>
                    </th>
                    <th pSortableColumn="priority">
                        Prioridad <p-sortIcon field="priority"></p-sortIcon>
                    </th>
                    <th>Acciones</th>
                </tr>
            </ng-template>

            <ng-template pTemplate="body" let-rate>
                <tr>
                    <td>
                        <span class="rate-code">{{ rate.code }}</span>
                    </td>
                    <td>
                        <div class="rate-name-cell">
                            <span class="rate-name">{{ rate.name }}</span>
                            <small class="rate-description">{{
                                rate.description
                            }}</small>
                        </div>
                    </td>
                    <td>
                        <p-tag
                            [value]="rate.type"
                            [severity]="getTypeSeverity(rate.type)"
                        >
                        </p-tag>
                    </td>
                    <td>
                        <p-tag
                            [value]="rate.status"
                            [severity]="getStatusSeverity(rate.status)"
                        >
                        </p-tag>
                    </td>
                    <td>
                        <div class="date-range">
                            <span>{{
                                rate.effectiveFrom | date : "dd/MM/yyyy"
                            }}</span>
                            <span
                                *ngIf="rate.effectiveUntil"
                                class="until-date"
                            >
                                -
                                {{ rate.effectiveUntil | date : "dd/MM/yyyy" }}
                            </span>
                        </div>
                    </td>
                    <td>
                        <span
                            class="priority-badge"
                            [class]="'priority-' + rate.priority"
                        >
                            {{ rate.priority }}
                        </span>
                    </td>
                    <td>
                        <div class="action-buttons">
                            <p-button
                                icon="pi pi-eye"
                                severity="secondary"
                                [text]="true"
                                size="small"
                                pTooltip="Ver detalles"
                                (click)="viewRate(rate)"
                            >
                            </p-button>
                            <p-button
                                icon="pi pi-pencil"
                                severity="secondary"
                                [text]="true"
                                size="small"
                                pTooltip="Editar"
                                (click)="editRate(rate)"
                            >
                            </p-button>
                            <p-button
                                icon="pi pi-history"
                                severity="secondary"
                                [text]="true"
                                size="small"
                                pTooltip="Historial"
                                (click)="viewHistory(rate)"
                            >
                            </p-button>
                            <p-button
                                icon="pi pi-trash"
                                severity="danger"
                                [text]="true"
                                size="small"
                                pTooltip="Eliminar"
                                (click)="deleteRate(rate)"
                            >
                            </p-button>
                        </div>
                    </td>
                </tr>
            </ng-template>

            <ng-template pTemplate="emptymessage">
                <tr>
                    <td colspan="7" class="text-center">
                        <div class="empty-state">
                            <i class="pi pi-money-bill empty-icon"></i>
                            <h3>No hay tarifas registradas</h3>
                            <p>Comience creando su primera tarifa</p>
                            <p-button
                                label="Crear Tarifa"
                                icon="pi pi-plus"
                                (click)="openCreateForm()"
                            >
                            </p-button>
                        </div>
                    </td>
                </tr>
            </ng-template>
        </p-table>
    </p-card>
</div>

<!-- Rate Form Dialog -->
<p-dialog
    [header]="dialogTitle"
    [(visible)]="showFormDialog"
    [modal]="true"
    [draggable]="false"
    [style]="{ width: '900px' }"
    [maximizable]="true"
    styleClass="rate-form-dialog"
>
    <app-rate-form
        [rate]="selectedRate"
        [mode]="formMode"
        (save)="onRateSave($event)"
        (cancel)="onFormCancel()"
    >
    </app-rate-form>
</p-dialog>

<!-- History Dialog -->
<p-dialog
    header="Historial de Cambios"
    [(visible)]="showHistoryDialog"
    [modal]="true"
    [draggable]="false"
    [style]="{ width: '800px' }"
    styleClass="history-dialog"
>
    <div class="history-content" *ngIf="selectedRateHistory">
        <p-timeline
            [value]="selectedRateHistory"
            layout="vertical"
            styleClass="history-timeline"
        >
            <ng-template pTemplate="content" let-event>
                <div class="history-item">
                    <div class="flex justify-content-between align-items-start">
                        <div class="history-details">
                            <h4>{{ event.action }}</h4>
                            <p>{{ event.description }}</p>
                            <div class="history-changes" *ngIf="event.changes">
                                <div
                                    class="change-item"
                                    *ngFor="let change of event.changes"
                                >
                                    <strong>{{ change.field }}:</strong>
                                    <span class="old-value">{{
                                        change.oldValue
                                    }}</span>
                                    <i class="pi pi-arrow-right"></i>
                                    <span class="new-value">{{
                                        change.newValue
                                    }}</span>
                                </div>
                            </div>
                        </div>
                        <div class="history-meta">
                            <small>{{
                                event.createdAt | date : "dd/MM/yyyy HH:mm"
                            }}</small>
                            <br />
                            <small>{{ event.user }}</small>
                        </div>
                    </div>
                </div>
            </ng-template>

            <ng-template pTemplate="marker" let-event>
                <div class="timeline-marker" [ngClass]="'marker-' + event.type">
                    <i [class]="getHistoryIcon(event.type)"></i>
                </div>
            </ng-template>
        </p-timeline>
    </div>

    <ng-template pTemplate="footer">
        <p-button
            label="Cerrar"
            severity="secondary"
            (click)="showHistoryDialog = false"
        >
        </p-button>
    </ng-template>
</p-dialog>

<!-- Delete Confirmation -->
<p-confirmDialog
    [style]="{ width: '450px' }"
    [baseZIndex]="10000"
    rejectButtonStyleClass="p-button-text"
>
</p-confirmDialog>
