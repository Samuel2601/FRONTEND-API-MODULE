<div class="reception-container">
    <!-- Header -->
    <div class="reception-header">
        <div class="flex justify-content-between align-items-center mb-4">
            <div>
                <h1 class="text-3xl font-bold text-white mb-2">
                    Recepción de Animales
                </h1>
                <p class="text-white opacity-90">
                    Etapa 1: Registro y validación inicial
                </p>
            </div>
            <div class="flex gap-2">
                <p-button
                    icon="pi pi-times"
                    label="Cancelar"
                    severity="secondary"
                    [outlined]="true"
                    (onClick)="cancelReception()"
                >
                </p-button>
            </div>
        </div>

        <!-- Progress Steps -->
        <div class="steps-container">
            <div
                class="step"
                *ngFor="let step of steps; let i = index"
                [class]="getStepClass(i)"
                (click)="goToStep(i + 1)"
            >
                <div class="step-circle">
                    <i [class]="step.icon"></i>
                </div>
                <div class="step-content">
                    <div class="step-title">{{ step.label }}</div>
                    <div class="step-description">{{ step.description }}</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <form [formGroup]="receptionForm" (ngSubmit)="onSubmit()">
        <!-- Paso 1: Certificado Zoosanitario -->
        <div class="step-content-panel" *ngIf="currentStep === 1">
            <p-card header="Certificado Zoosanitario" styleClass="h-full">
                <!-- Método de Recepción -->
                <div class="field mb-4">
                    <label for="receptionMethod" class="font-semibold"
                        >Método de Recepción</label
                    >
                    <p-selectButton
                        id="receptionMethod"
                        formControlName="receptionMethod"
                        [options]="receptionMethodOptions"
                        optionLabel="label"
                        optionValue="value"
                        styleClass="w-full"
                        (onChange)="onReceptionMethodChange()"
                    >
                    </p-selectButton>
                </div>

                <!-- Botón de Escaneo QR -->
                <div
                    class="qr-scan-section mb-4"
                    *ngIf="
                        receptionForm.get('receptionMethod')?.value ===
                        'QR_SCAN'
                    "
                >
                    <div
                        class="text-center p-4 border-2 border-dashed border-300 border-round"
                    >
                        <i class="pi pi-qrcode text-6xl text-400 mb-3"></i>
                        <h4 class="text-900 mb-2">
                            Escanear Código QR del Certificado
                        </h4>
                        <p class="text-600 mb-4">
                            Posicione el código QR del certificado zoosanitario
                            frente a la cámara
                        </p>
                        <p-button
                            icon="pi pi-camera"
                            label="Iniciar Escáner"
                            [loading]="scanning"
                            loadingIcon="pi pi-spin pi-cog"
                            (onClick)="scanQRCode()"
                        >
                        </p-button>
                    </div>
                </div>

                <!-- Entrada Manual del Certificado -->
                <div
                    class="manual-entry-section"
                    *ngIf="
                        receptionForm.get('receptionMethod')?.value ===
                        'MANUAL_ENTRY'
                    "
                >
                    <h5 class="text-900 mb-3">
                        Datos del Certificado Zoosanitario
                    </h5>

                    <div class="grid">
                        <!-- CZPM Number -->
                        <div class="col-12 md:col-6">
                            <div class="field">
                                <label for="czpmNumber" class="font-semibold"
                                    >CZPM No</label
                                >
                                <input
                                    type="text"
                                    pInputText
                                    id="czpmNumber"
                                    formControlName="czpmNumber"
                                    placeholder="Ej: 2023-05-9765837433"
                                    styleClass="w-full"
                                />
                            </div>
                        </div>

                        <!-- Autorizado A -->
                        <div class="col-12 md:col-6">
                            <div class="field">
                                <label for="authorizedTo" class="font-semibold"
                                    >Autorizado A *</label
                                >
                                <input
                                    type="text"
                                    pInputText
                                    id="authorizedTo"
                                    formControlName="authorizedTo"
                                    placeholder="Ej: 0801921727"
                                    styleClass="w-full"
                                    [class.ng-invalid]="
                                        receptionForm.get('authorizedTo')
                                            ?.invalid &&
                                        receptionForm.get('authorizedTo')
                                            ?.touched
                                    "
                                />
                                <small
                                    class="p-error"
                                    *ngIf="
                                        receptionForm.get('authorizedTo')
                                            ?.invalid &&
                                        receptionForm.get('authorizedTo')
                                            ?.touched
                                    "
                                >
                                    Este campo es requerido
                                </small>
                            </div>
                        </div>

                        <!-- Código Área Origen -->
                        <div class="col-12 md:col-6">
                            <div class="field">
                                <label
                                    for="originAreaCode"
                                    class="font-semibold"
                                    >Código Área Origen *</label
                                >
                                <input
                                    type="text"
                                    pInputText
                                    id="originAreaCode"
                                    formControlName="originAreaCode"
                                    placeholder="Ej: 03-0062-00436-00374833"
                                    styleClass="w-full"
                                    [class.ng-invalid]="
                                        receptionForm.get('originAreaCode')
                                            ?.invalid &&
                                        receptionForm.get('originAreaCode')
                                            ?.touched
                                    "
                                />
                                <small
                                    class="p-error"
                                    *ngIf="
                                        receptionForm.get('originAreaCode')
                                            ?.invalid &&
                                        receptionForm.get('originAreaCode')
                                            ?.touched
                                    "
                                >
                                    Este campo es requerido
                                </small>
                            </div>
                        </div>

                        <!-- Código Área Destino -->
                        <div class="col-12 md:col-6">
                            <div class="field">
                                <label
                                    for="destinationAreaCode"
                                    class="font-semibold"
                                    >Código Área Destino *</label
                                >
                                <input
                                    type="text"
                                    pInputText
                                    id="destinationAreaCode"
                                    formControlName="destinationAreaCode"
                                    placeholder="Ej: 03-0062-00438-00160206"
                                    styleClass="w-full"
                                    [class.ng-invalid]="
                                        receptionForm.get('destinationAreaCode')
                                            ?.invalid &&
                                        receptionForm.get('destinationAreaCode')
                                            ?.touched
                                    "
                                />
                                <small
                                    class="p-error"
                                    *ngIf="
                                        receptionForm.get('destinationAreaCode')
                                            ?.invalid &&
                                        receptionForm.get('destinationAreaCode')
                                            ?.touched
                                    "
                                >
                                    Este campo es requerido
                                </small>
                            </div>
                        </div>

                        <!-- Vehículo -->
                        <div class="col-12 md:col-6">
                            <div class="field">
                                <label for="vehiclePlate" class="font-semibold"
                                    >Vehículo *</label
                                >
                                <input
                                    type="text"
                                    pInputText
                                    id="vehiclePlate"
                                    formControlName="vehiclePlate"
                                    placeholder="Ej: JBE0076"
                                    styleClass="w-full"
                                    [class.ng-invalid]="
                                        receptionForm.get('vehiclePlate')
                                            ?.invalid &&
                                        receptionForm.get('vehiclePlate')
                                            ?.touched
                                    "
                                />
                                <small
                                    class="p-error"
                                    *ngIf="
                                        receptionForm.get('vehiclePlate')
                                            ?.invalid &&
                                        receptionForm.get('vehiclePlate')
                                            ?.touched
                                    "
                                >
                                    Este campo es requerido
                                </small>
                            </div>
                        </div>

                        <!-- Total Productos -->
                        <div class="col-12 md:col-6">
                            <div class="field">
                                <label for="totalProducts" class="font-semibold"
                                    >Total Productos *</label
                                >
                                <p-inputNumber
                                    id="totalProducts"
                                    formControlName="totalProducts"
                                    placeholder="1"
                                    [min]="1"
                                    [max]="1000"
                                    styleClass="w-full"
                                    [class.ng-invalid]="
                                        receptionForm.get('totalProducts')
                                            ?.invalid &&
                                        receptionForm.get('totalProducts')
                                            ?.touched
                                    "
                                >
                                </p-inputNumber>
                                <small
                                    class="p-error"
                                    *ngIf="
                                        receptionForm.get('totalProducts')
                                            ?.invalid &&
                                        receptionForm.get('totalProducts')
                                            ?.touched
                                    "
                                >
                                    Debe ser un número mayor a 0
                                </small>
                            </div>
                        </div>

                        <!-- Válido Hasta -->
                        <div class="col-12">
                            <div class="field">
                                <label for="validTo" class="font-semibold"
                                    >Válido Hasta *</label
                                >
                                <p-calendar
                                    id="validTo"
                                    formControlName="validTo"
                                    placeholder="Seleccione fecha y hora"
                                    [showTime]="true"
                                    [showIcon]="true"
                                    [dateFormat]="'dd/mm/yy'"
                                    styleClass="w-full"
                                    [class.ng-invalid]="
                                        receptionForm.get('validTo')?.invalid &&
                                        receptionForm.get('validTo')?.touched
                                    "
                                >
                                </p-calendar>
                                <small
                                    class="p-error"
                                    *ngIf="
                                        receptionForm.get('validTo')?.invalid &&
                                        receptionForm.get('validTo')?.touched
                                    "
                                >
                                    Fecha de validez es requerida
                                </small>
                            </div>
                        </div>
                    </div>

                    <!-- Botón para procesar entrada manual -->
                    <div class="flex justify-content-end gap-2 mb-4">
                        <p-button
                            label="Validar Certificado"
                            icon="pi pi-check"
                            severity="success"
                            [outlined]="true"
                            [loading]="validatingCertificate"
                            (onClick)="processManualEntry()"
                            [disabled]="
                                !receptionForm.get('authorizedTo')?.value
                            "
                        >
                        </p-button>
                    </div>
                </div>

                <!-- Información del Certificado (después del procesamiento) -->
                <div
                    class="certificate-info"
                    *ngIf="certificateData || certificateValidation"
                >
                    <p-panel
                        header="Información del Certificado"
                        [toggleable]="false"
                    >
                        <div class="grid" *ngIf="certificateData">
                            <div class="col-12 md:col-6">
                                <div class="info-item">
                                    <label class="font-semibold text-600"
                                        >Número:</label
                                    >
                                    <span class="ml-2">{{
                                        certificateData.certificateNumber
                                    }}</span>
                                </div>
                            </div>
                            <div class="col-12 md:col-6">
                                <div class="info-item">
                                    <label class="font-semibold text-600"
                                        >CZPM No:</label
                                    >
                                    <span class="ml-2">{{
                                        certificateData.czpmNumber
                                    }}</span>
                                </div>
                            </div>
                            <div class="col-12 md:col-6">
                                <div class="info-item">
                                    <label class="font-semibold text-600"
                                        >Autorizado A:</label
                                    >
                                    <span class="ml-2">{{
                                        certificateData.authorizedTo
                                    }}</span>
                                </div>
                            </div>
                            <div class="col-12 md:col-6">
                                <div class="info-item">
                                    <label class="font-semibold text-600"
                                        >Vehículo:</label
                                    >
                                    <span class="ml-2">{{
                                        certificateData.vehiclePlate
                                    }}</span>
                                </div>
                            </div>
                            <div class="col-12 md:col-6">
                                <div class="info-item">
                                    <label class="font-semibold text-600"
                                        >Total Productos:</label
                                    >
                                    <span class="ml-2">{{
                                        certificateData.totalProducts
                                    }}</span>
                                </div>
                            </div>
                            <div class="col-12 md:col-6">
                                <div class="info-item">
                                    <label class="font-semibold text-600"
                                        >Válido Hasta:</label
                                    >
                                    <span class="ml-2">{{
                                        certificateData.validTo
                                            | date : "dd/MM/yyyy HH:mm"
                                    }}</span>
                                </div>
                            </div>
                        </div>

                        <!-- Mostrar info del formulario si no hay certificateData -->
                        <div
                            class="grid"
                            *ngIf="!certificateData && certificateValidation"
                        >
                            <div class="col-12 md:col-6">
                                <div class="info-item">
                                    <label class="font-semibold text-600"
                                        >Autorizado A:</label
                                    >
                                    <span class="ml-2">{{
                                        receptionForm.get("authorizedTo")?.value
                                    }}</span>
                                </div>
                            </div>
                            <div class="col-12 md:col-6">
                                <div class="info-item">
                                    <label class="font-semibold text-600"
                                        >Vehículo:</label
                                    >
                                    <span class="ml-2">{{
                                        receptionForm.get("vehiclePlate")?.value
                                    }}</span>
                                </div>
                            </div>
                            <div class="col-12 md:col-6">
                                <div class="info-item">
                                    <label class="font-semibold text-600"
                                        >Total Productos:</label
                                    >
                                    <span class="ml-2">{{
                                        receptionForm.get("totalProducts")
                                            ?.value
                                    }}</span>
                                </div>
                            </div>
                            <div class="col-12 md:col-6">
                                <div class="info-item">
                                    <label class="font-semibold text-600"
                                        >Válido Hasta:</label
                                    >
                                    <span class="ml-2">{{
                                        receptionForm.get("validTo")?.value
                                            | date : "dd/MM/yyyy HH:mm"
                                    }}</span>
                                </div>
                            </div>
                        </div>
                    </p-panel>
                </div>

                <!-- Estado de Validación del Certificado -->
                <div
                    class="validation-status mt-4"
                    *ngIf="certificateValidation"
                >
                    <p-message
                        *ngIf="
                            certificateValidation.isValid &&
                            certificateValidation.warnings.length === 0
                        "
                        severity="success"
                        text="Certificado válido y vigente"
                    >
                    </p-message>

                    <p-message
                        *ngFor="let warning of certificateValidation.warnings"
                        severity="warning"
                        [text]="warning"
                    >
                    </p-message>

                    <p-message
                        *ngFor="let error of certificateValidation.errors"
                        severity="danger"
                        [text]="error"
                    >
                    </p-message>
                </div>

                <!-- Botones de Acción -->
                <div class="flex justify-content-end gap-2 mt-4">
                    <p-button
                        label="Siguiente"
                        icon="pi pi-arrow-right"
                        iconPos="right"
                        [disabled]="!canProceedToNextStep()"
                        (onClick)="nextStep()"
                    >
                    </p-button>
                </div>
            </p-card>
        </div>

        <!-- Paso 2: Introductor -->
        <div class="step-content-panel" *ngIf="currentStep === 2">
            <p-card header="Información del Introductor" styleClass="h-full">
                <!-- Selector de Introductor -->
                <div class="field mb-4">
                    <label for="introducer" class="font-semibold"
                        >Seleccionar Introductor *</label
                    >
                    <p-dropdown
                        id="introducer"
                        formControlName="introducerId"
                        [options]="introducers"
                        optionLabel="displayName"
                        optionValue="_id"
                        placeholder="Seleccione un introductor"
                        [filter]="true"
                        filterBy="displayName,idNumber"
                        styleClass="w-full"
                        (onChange)="onIntroducerSelect()"
                        [class.ng-invalid]="
                            receptionForm.get('introducerId')?.invalid &&
                            receptionForm.get('introducerId')?.touched
                        "
                    >
                        <ng-template let-introducer pTemplate="item">
                            <div class="flex align-items-center gap-2">
                                <i
                                    class="pi"
                                    [class.pi-user]="
                                        introducer.type === 'NATURAL'
                                    "
                                    [class.pi-building]="
                                        introducer.type === 'JURIDICAL'
                                    "
                                ></i>
                                <div>
                                    <div class="font-semibold">
                                        {{
                                            getIntroducerDisplayName(introducer)
                                        }}
                                    </div>
                                    <div class="text-sm text-600">
                                        {{ introducer.idNumber }} -
                                        {{ introducer.introducerType }}
                                    </div>
                                </div>
                            </div>
                        </ng-template>
                    </p-dropdown>
                    <small
                        class="p-error"
                        *ngIf="
                            receptionForm.get('introducerId')?.invalid &&
                            receptionForm.get('introducerId')?.touched
                        "
                    >
                        Debe seleccionar un introductor
                    </small>
                </div>

                <!-- Información del Introductor Seleccionado -->
                <div class="introducer-details" *ngIf="selectedIntroducer">
                    <p-panel
                        header="Detalles del Introductor"
                        [toggleable]="true"
                    >
                        <div class="grid">
                            <div class="col-12 md:col-6">
                                <div class="info-item mb-3">
                                    <label class="font-semibold text-600"
                                        >Tipo:</label
                                    >
                                    <span class="ml-2">
                                        <p-tag
                                            [value]="
                                                selectedIntroducer.type ===
                                                'NATURAL'
                                                    ? 'Persona Natural'
                                                    : 'Persona Jurídica'
                                            "
                                            [severity]="
                                                selectedIntroducer.type ===
                                                'NATURAL'
                                                    ? 'info'
                                                    : 'warning'
                                            "
                                        >
                                        </p-tag>
                                    </span>
                                </div>
                                <div class="info-item mb-3">
                                    <label class="font-semibold text-600"
                                        >Documento:</label
                                    >
                                    <span class="ml-2">{{
                                        selectedIntroducer.idNumber
                                    }}</span>
                                </div>
                                <div class="info-item mb-3">
                                    <label class="font-semibold text-600"
                                        >Tipo de Introductor:</label
                                    >
                                    <span class="ml-2">{{
                                        selectedIntroducer.introducerType
                                    }}</span>
                                </div>
                            </div>
                            <div class="col-12 md:col-6">
                                <div
                                    class="info-item mb-3"
                                    *ngIf="selectedIntroducer.phone"
                                >
                                    <label class="font-semibold text-600"
                                        >Teléfono:</label
                                    >
                                    <span class="ml-2">{{
                                        selectedIntroducer.phone
                                    }}</span>
                                </div>
                                <div
                                    class="info-item mb-3"
                                    *ngIf="selectedIntroducer.email"
                                >
                                    <label class="font-semibold text-600"
                                        >Email:</label
                                    >
                                    <span class="ml-2">{{
                                        selectedIntroducer.email
                                    }}</span>
                                </div>
                                <div class="info-item mb-3">
                                    <label class="font-semibold text-600"
                                        >Estado:</label
                                    >
                                    <span class="ml-2">
                                        <p-tag
                                            [value]="
                                                selectedIntroducer.registrationStatus
                                            "
                                            [severity]="
                                                selectedIntroducer.registrationStatus ===
                                                'ACTIVE'
                                                    ? 'success'
                                                    : 'danger'
                                            "
                                        >
                                        </p-tag>
                                    </span>
                                </div>
                            </div>
                        </div>
                    </p-panel>
                </div>

                <!-- Validación de Pagos -->
                <div class="payment-validation mt-4" *ngIf="paymentValidation">
                    <h5 class="text-900 mb-3">Estado de Pagos</h5>
                    <div class="grid">
                        <div class="col-12 md:col-4">
                            <div
                                class="payment-status-card p-3 border-1 border-200 border-round"
                            >
                                <div class="text-600 text-sm mb-1">
                                    Inscripción Anual
                                </div>
                                <p-tag
                                    [value]="
                                        paymentValidation.inscriptionStatus ===
                                        'PAID'
                                            ? 'Pagado'
                                            : 'Pendiente'
                                    "
                                    [severity]="
                                        paymentValidation.inscriptionStatus ===
                                        'PAID'
                                            ? 'success'
                                            : 'danger'
                                    "
                                >
                                </p-tag>
                            </div>
                        </div>
                        <div class="col-12 md:col-4">
                            <div
                                class="payment-status-card p-3 border-1 border-200 border-round"
                            >
                                <div class="text-600 text-sm mb-1">Multas</div>
                                <p-tag
                                    [value]="
                                        paymentValidation.finesStatus === 'NONE'
                                            ? 'Sin Multas'
                                            : paymentValidation.finesStatus ===
                                              'PAID'
                                            ? 'Pagadas'
                                            : 'Pendientes'
                                    "
                                    [severity]="
                                        paymentValidation.finesStatus ===
                                        'PENDING'
                                            ? 'danger'
                                            : 'success'
                                    "
                                >
                                </p-tag>
                            </div>
                        </div>
                        <div class="col-12 md:col-4">
                            <div
                                class="payment-status-card p-3 border-1 border-200 border-round"
                            >
                                <div class="text-600 text-sm mb-1">
                                    Monto Pendiente
                                </div>
                                <div class="font-bold text-900">
                                    ${{
                                        paymentValidation.pendingAmount
                                            | number : "1.2-2"
                                    }}
                                </div>
                            </div>
                        </div>
                    </div>

                    <p-message
                        *ngIf="!paymentValidation.canProceed"
                        severity="danger"
                        [text]="
                            'No se puede proceder: ' + paymentValidation.reason
                        "
                    >
                    </p-message>

                    <p-message
                        *ngIf="paymentValidation.canProceed"
                        severity="success"
                        text="El introductor puede proceder con el faenamiento"
                    >
                    </p-message>
                </div>

                <!-- Botones de Acción -->
                <div class="flex justify-content-between gap-2 mt-4">
                    <p-button
                        label="Anterior"
                        icon="pi pi-arrow-left"
                        severity="secondary"
                        [outlined]="true"
                        (onClick)="previousStep()"
                    >
                    </p-button>
                    <p-button
                        label="Siguiente"
                        icon="pi pi-arrow-right"
                        iconPos="right"
                        [disabled]="!canProceedToNextStep()"
                        (onClick)="nextStep()"
                    >
                    </p-button>
                </div>
            </p-card>
        </div>

        <!-- Paso 3: Registro de Animales -->
        <div class="step-content-panel" *ngIf="currentStep === 3">
            <p-card header="Registro de Animales" styleClass="h-full">
                <!-- Herramientas -->
                <div class="animals-toolbar mb-4">
                    <div
                        class="flex justify-content-between align-items-center"
                    >
                        <div class="flex gap-2">
                            <p-button
                                icon="pi pi-plus"
                                label="Agregar Animal"
                                severity="success"
                                (onClick)="addAnimal()"
                            >
                            </p-button>
                            <p-button
                                icon="pi pi-download"
                                label="Auto-llenar desde Certificado"
                                severity="info"
                                [outlined]="true"
                                [disabled]="
                                    !receptionForm.get('totalProducts')?.value
                                "
                                (onClick)="autoFillAnimalsFromCertificate()"
                            >
                            </p-button>
                        </div>
                        <div class="animals-count">
                            <p-tag
                                [value]="
                                    'Total: ' +
                                    animalsFormArray.length +
                                    ' animales'
                                "
                                severity="info"
                            >
                            </p-tag>
                        </div>
                    </div>
                </div>

                <!-- Lista de Animales -->
                <div class="animals-list" *ngIf="animalsFormArray.length > 0">
                    <div
                        class="animal-card"
                        *ngFor="
                            let animalControl of animalsFormArray.controls;
                            let i = index
                        "
                        [formGroup]="getAnimalFormGroup(i)"
                    >
                        <p-panel
                            [header]="'Animal #' + (i + 1)"
                            [toggleable]="true"
                        >
                            <div class="grid">
                                <div class="col-12 md:col-6 lg:col-3">
                                    <div class="field">
                                        <label
                                            [for]="'animalId_' + i"
                                            class="font-semibold"
                                            >ID del Animal *</label
                                        >
                                        <input
                                            type="text"
                                            pInputText
                                            [id]="'animalId_' + i"
                                            formControlName="animalId"
                                            placeholder="Ej: BOV-001"
                                            styleClass="w-full"
                                            [class.ng-invalid]="
                                                getAnimalFormGroup(i).get(
                                                    'animalId'
                                                )?.invalid &&
                                                getAnimalFormGroup(i).get(
                                                    'animalId'
                                                )?.touched
                                            "
                                        />
                                        <small
                                            class="p-error"
                                            *ngIf="
                                                getAnimalFormGroup(i).get(
                                                    'animalId'
                                                )?.invalid &&
                                                getAnimalFormGroup(i).get(
                                                    'animalId'
                                                )?.touched
                                            "
                                        >
                                            ID del animal es requerido
                                        </small>
                                    </div>
                                </div>

                                <div class="col-12 md:col-6 lg:col-3">
                                    <div class="field">
                                        <label
                                            [for]="'species_' + i"
                                            class="font-semibold"
                                            >Especie *</label
                                        >
                                        <p-dropdown
                                            [id]="'species_' + i"
                                            formControlName="species"
                                            [options]="speciesOptions"
                                            optionLabel="label"
                                            optionValue="value"
                                            placeholder="Seleccionar"
                                            styleClass="w-full"
                                            [class.ng-invalid]="
                                                getAnimalFormGroup(i).get(
                                                    'species'
                                                )?.invalid &&
                                                getAnimalFormGroup(i).get(
                                                    'species'
                                                )?.touched
                                            "
                                        >
                                        </p-dropdown>
                                        <small
                                            class="p-error"
                                            *ngIf="
                                                getAnimalFormGroup(i).get(
                                                    'species'
                                                )?.invalid &&
                                                getAnimalFormGroup(i).get(
                                                    'species'
                                                )?.touched
                                            "
                                        >
                                            Especie es requerida
                                        </small>
                                    </div>
                                </div>

                                <div class="col-12 md:col-6 lg:col-3">
                                    <div class="field">
                                        <label
                                            [for]="'weight_' + i"
                                            class="font-semibold"
                                            >Peso (kg)</label
                                        >
                                        <p-inputNumber
                                            [id]="'weight_' + i"
                                            formControlName="weight"
                                            placeholder="0.00"
                                            mode="decimal"
                                            [minFractionDigits]="2"
                                            [maxFractionDigits]="2"
                                            styleClass="w-full"
                                        >
                                        </p-inputNumber>
                                    </div>
                                </div>

                                <div class="col-12 md:col-6 lg:col-3">
                                    <div class="field">
                                        <label
                                            [for]="'condition_' + i"
                                            class="font-semibold"
                                            >Condición *</label
                                        >
                                        <p-dropdown
                                            [id]="'condition_' + i"
                                            formControlName="condition"
                                            [options]="conditionOptions"
                                            optionLabel="label"
                                            optionValue="value"
                                            placeholder="Seleccionar"
                                            styleClass="w-full"
                                            [class.ng-invalid]="
                                                getAnimalFormGroup(i).get(
                                                    'condition'
                                                )?.invalid &&
                                                getAnimalFormGroup(i).get(
                                                    'condition'
                                                )?.touched
                                            "
                                        >
                                        </p-dropdown>
                                        <small
                                            class="p-error"
                                            *ngIf="
                                                getAnimalFormGroup(i).get(
                                                    'condition'
                                                )?.invalid &&
                                                getAnimalFormGroup(i).get(
                                                    'condition'
                                                )?.touched
                                            "
                                        >
                                            Condición es requerida
                                        </small>
                                    </div>
                                </div>

                                <div class="col-12">
                                    <div class="field">
                                        <label
                                            [for]="'observations_' + i"
                                            class="font-semibold"
                                            >Observaciones</label
                                        >
                                        <textarea
                                            pInputTextarea
                                            [id]="'observations_' + i"
                                            formControlName="observations"
                                            placeholder="Observaciones adicionales..."
                                            rows="2"
                                            styleClass="w-full"
                                        >
                                        </textarea>
                                    </div>
                                </div>
                            </div>

                            <div class="flex justify-content-end mt-3">
                                <p-button
                                    icon="pi pi-trash"
                                    severity="danger"
                                    size="small"
                                    [text]="true"
                                    (onClick)="removeAnimal(i)"
                                >
                                </p-button>
                            </div>
                        </p-panel>
                    </div>
                </div>

                <!-- Estado Vacío -->
                <div
                    class="empty-animals"
                    *ngIf="animalsFormArray.length === 0"
                >
                    <div
                        class="text-center p-5 border-2 border-dashed border-300 border-round"
                    >
                        <i class="pi pi-inbox text-5xl text-400 mb-3"></i>
                        <h4 class="text-900 mb-2">
                            No hay animales registrados
                        </h4>
                        <p class="text-600 mb-4">
                            Agregue al menos un animal para continuar
                        </p>
                        <p-button
                            icon="pi pi-plus"
                            label="Agregar Primer Animal"
                            (onClick)="addAnimal()"
                        >
                        </p-button>
                    </div>
                </div>

                <!-- Botones de Acción -->
                <div class="flex justify-content-between gap-2 mt-4">
                    <p-button
                        label="Anterior"
                        icon="pi pi-arrow-left"
                        severity="secondary"
                        [outlined]="true"
                        (onClick)="previousStep()"
                    >
                    </p-button>
                    <p-button
                        label="Siguiente"
                        icon="pi pi-arrow-right"
                        iconPos="right"
                        [disabled]="!canProceedToNextStep()"
                        (onClick)="nextStep()"
                    >
                    </p-button>
                </div>
            </p-card>
        </div>

        <!-- Paso 4: Confirmación -->
        <div class="step-content-panel" *ngIf="currentStep === 4">
            <p-card header="Confirmación de Recepción" styleClass="h-full">
                <!-- Resumen del Proceso -->
                <div class="summary-section">
                    <h5 class="text-900 mb-3">Resumen del Proceso</h5>

                    <!-- Resumen del Certificado -->
                    <p-panel
                        header="Certificado Zoosanitario"
                        styleClass="mb-3"
                    >
                        <div class="grid">
                            <div class="col-12 md:col-6">
                                <div class="info-item mb-2">
                                    <label class="font-semibold text-600"
                                        >Número:</label
                                    >
                                    <span class="ml-2">{{
                                        certificateData?.certificateNumber ||
                                            receptionForm.get(
                                                "certificateNumber"
                                            )?.value ||
                                            "Por generar"
                                    }}</span>
                                </div>
                                <div class="info-item mb-2">
                                    <label class="font-semibold text-600"
                                        >Método:</label
                                    >
                                    <span class="ml-2">{{
                                        receptionForm.get("receptionMethod")
                                            ?.value === "QR_SCAN"
                                            ? "Escáner QR"
                                            : "Entrada Manual"
                                    }}</span>
                                </div>
                                <div class="info-item mb-2">
                                    <label class="font-semibold text-600"
                                        >Autorizado A:</label
                                    >
                                    <span class="ml-2">{{
                                        certificateData?.authorizedTo ||
                                            receptionForm.get("authorizedTo")
                                                ?.value
                                    }}</span>
                                </div>
                            </div>
                            <div class="col-12 md:col-6">
                                <div class="info-item mb-2">
                                    <label class="font-semibold text-600"
                                        >Vehículo:</label
                                    >
                                    <span class="ml-2">{{
                                        certificateData?.vehiclePlate ||
                                            receptionForm.get("vehiclePlate")
                                                ?.value
                                    }}</span>
                                </div>
                                <div class="info-item mb-2">
                                    <label class="font-semibold text-600"
                                        >Total Productos:</label
                                    >
                                    <span class="ml-2">{{
                                        certificateData?.totalProducts ||
                                            receptionForm.get("totalProducts")
                                                ?.value
                                    }}</span>
                                </div>
                                <div class="info-item mb-2">
                                    <label class="font-semibold text-600"
                                        >Vencimiento:</label
                                    >
                                    <span class="ml-2">{{
                                        certificateData?.validTo ||
                                            receptionForm.get("validTo")?.value
                                            | date : "dd/MM/yyyy HH:mm"
                                    }}</span>
                                </div>
                            </div>
                        </div>
                    </p-panel>

                    <!-- Resumen del Introductor -->
                    <p-panel
                        header="Introductor"
                        styleClass="mb-3"
                        *ngIf="selectedIntroducer"
                    >
                        <div class="grid">
                            <div class="col-12 md:col-6">
                                <div class="info-item mb-2">
                                    <label class="font-semibold text-600"
                                        >Nombre:</label
                                    >
                                    <span class="ml-2">{{
                                        getIntroducerDisplayName(
                                            selectedIntroducer
                                        )
                                    }}</span>
                                </div>
                                <div class="info-item mb-2">
                                    <label class="font-semibold text-600"
                                        >Documento:</label
                                    >
                                    <span class="ml-2">{{
                                        selectedIntroducer.idNumber
                                    }}</span>
                                </div>
                            </div>
                            <div class="col-12 md:col-6">
                                <div class="info-item mb-2">
                                    <label class="font-semibold text-600"
                                        >Tipo:</label
                                    >
                                    <span class="ml-2">{{
                                        selectedIntroducer.introducerType
                                    }}</span>
                                </div>
                                <div class="info-item mb-2">
                                    <label class="font-semibold text-600"
                                        >Estado de Pagos:</label
                                    >
                                    <span class="ml-2">
                                        <p-tag
                                            [value]="
                                                paymentValidation?.canProceed
                                                    ? 'Al día'
                                                    : 'Pendiente'
                                            "
                                            [severity]="
                                                paymentValidation?.canProceed
                                                    ? 'success'
                                                    : 'danger'
                                            "
                                        >
                                        </p-tag>
                                    </span>
                                </div>
                            </div>
                        </div>
                    </p-panel>

                    <!-- Resumen de Animales -->
                    <p-panel header="Animales a Recibir" styleClass="mb-3">
                        <div class="animals-summary">
                            <div class="grid">
                                <div class="col-12 md:col-4">
                                    <div class="summary-stat">
                                        <div class="text-600 text-sm">
                                            Total de Animales
                                        </div>
                                        <div
                                            class="font-bold text-2xl text-900"
                                        >
                                            {{ animalsFormArray.length }}
                                        </div>
                                    </div>
                                </div>
                                <div class="col-12 md:col-4">
                                    <div class="summary-stat">
                                        <div class="text-600 text-sm">
                                            Bovinos
                                        </div>
                                        <div
                                            class="font-bold text-2xl text-900"
                                        >
                                            {{
                                                getAnimalCountBySpecies(
                                                    "BOVINE"
                                                )
                                            }}
                                        </div>
                                    </div>
                                </div>
                                <div class="col-12 md:col-4">
                                    <div class="summary-stat">
                                        <div class="text-600 text-sm">
                                            Porcinos
                                        </div>
                                        <div
                                            class="font-bold text-2xl text-900"
                                        >
                                            {{
                                                getAnimalCountBySpecies(
                                                    "PORCINE"
                                                )
                                            }}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </p-panel>

                    <!-- Notas Adicionales -->
                    <div class="field">
                        <label for="receptionNotes" class="font-semibold"
                            >Notas de Recepción</label
                        >
                        <textarea
                            pInputTextarea
                            id="receptionNotes"
                            formControlName="receptionNotes"
                            placeholder="Observaciones adicionales sobre la recepción..."
                            rows="3"
                            styleClass="w-full"
                            style="width: 100%; height: 100px"
                        >
                        </textarea>
                    </div>
                </div>

                <!-- Botones de Acción -->
                <div class="flex justify-content-between gap-2 mt-4">
                    <p-button
                        label="Anterior"
                        icon="pi pi-arrow-left"
                        severity="secondary"
                        [outlined]="true"
                        (onClick)="previousStep()"
                    >
                    </p-button>
                    <p-button
                        label="Iniciar Proceso de Recepción"
                        icon="pi pi-check"
                        iconPos="right"
                        [loading]="submitting || creatingCertificate"
                        type="submit"
                    >
                    </p-button>
                </div>
            </p-card>
        </div>
    </form>
</div>

<!-- Diálogos de Confirmación -->
<p-confirmDialog></p-confirmDialog>

<!-- Toast para notificaciones -->
<p-toast></p-toast>
