<!-- src/app/components/reception/reception.component.html -->
<div class="reception-container">
    <!-- Header -->
    <div class="reception-header">
        <div class="flex justify-content-between align-items-center mb-4">
            <div>
                <h1 class="text-3xl font-bold text-white mb-2">
                    Recepción de Animales
                </h1>
                <p class="text-white opacity-90">
                    Registro completo de recepción y condiciones de transporte
                </p>
                <div class="platform-info mt-2">
                    <p-tag
                        [value]="'Plataforma: ' + getPlatform().toUpperCase()"
                        severity="info"
                        [rounded]="true"
                    >
                    </p-tag>
                </div>
            </div>
            <div class="flex gap-2">
                <p-button
                    icon="pi pi-times"
                    label="Cancelar"
                    severity="secondary"
                    [outlined]="true"
                    (onClick)="cancelReception()"
                >
                </p-button>
            </div>
        </div>

        <!-- Progress Steps -->
        <div class="steps-container">
            <div
                class="step"
                *ngFor="let step of steps; let i = index"
                [class]="getStepClass(i)"
                (click)="goToStep(i + 1)"
            >
                <div class="step-circle">
                    <i [class]="step.icon"></i>
                </div>
                <div class="step-content">
                    <div class="step-title">{{ step.label }}</div>
                    <div class="step-description">{{ step.description }}</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <form [formGroup]="receptionForm" (ngSubmit)="onSubmit()">
        <!-- ===== PASO 1: CERTIFICADO ZOOSANITARIO ===== -->
        <div class="step-content-panel" *ngIf="currentStep === 1">
            <p-card header="Certificado Zoosanitario" styleClass="h-full">
                <!-- Método de Recepción -->
                <div class="field mb-4">
                    <label for="receptionMethod" class="font-semibold">
                        Método de Recepción
                    </label>
                    <p-selectButton
                        id="receptionMethod"
                        formControlName="receptionMethod"
                        [options]="receptionMethodOptions"
                        optionLabel="label"
                        optionValue="value"
                        styleClass="w-full"
                        (onChange)="onReceptionMethodChange()"
                    >
                    </p-selectButton>
                </div>

                <!-- Sección de Escaneo QR (Refactorizada) -->
                <div
                    class="qr-scan-section mb-4"
                    *ngIf="
                        receptionForm.get('receptionMethod')?.value ===
                        'QR_SCAN'
                    "
                >
                    <div class="qr-scanner-card">
                        <div class="scanner-header">
                            <i
                                class="pi pi-qrcode text-6xl text-primary mb-3"
                            ></i>
                            <h4 class="text-900 mb-2">
                                Escanear Certificado Zoosanitario
                            </h4>
                            <p class="text-600 mb-4">
                                Use uno de los métodos disponibles para escanear
                                el código QR
                            </p>
                        </div>

                        <!-- Métodos Disponibles -->
                        <div class="available-methods mb-4">
                            <h6 class="text-700 mb-3">
                                Métodos disponibles en su dispositivo:
                            </h6>
                            <div class="methods-list">
                                <div
                                    class="method-item"
                                    *ngFor="let method of getAvailableMethods()"
                                >
                                    <i
                                        class="pi"
                                        [class.pi-camera]="
                                            method.includes('camera')
                                        "
                                        [class.pi-image]="
                                            method === 'file-upload'
                                        "
                                        [class.pi-clipboard]="
                                            method.includes('clipboard')
                                        "
                                        [class.pi-pencil]="
                                            method === 'manual-input'
                                        "
                                    ></i>
                                    <span>{{ getMethodLabel(method) }}</span>
                                </div>
                            </div>
                        </div>

                        <!-- Botón Principal de Escaneo -->
                        <div class="scanner-actions">
                            <p-button
                                label="Iniciar Escaneo QR"
                                icon="pi pi-qrcode"
                                size="large"
                                styleClass="w-full mb-3"
                                (onClick)="openQRScanner()"
                            >
                            </p-button>

                            <!-- Botones Alternativos -->
                            <div class="alternative-actions">
                                <p-button
                                    label="Escanear desde Archivo"
                                    icon="pi pi-image"
                                    severity="secondary"
                                    [outlined]="true"
                                    size="small"
                                    (onClick)="openQRScanner()"
                                >
                                </p-button>

                                <p-button
                                    label="Pegar desde Portapapeles"
                                    icon="pi pi-clipboard"
                                    severity="info"
                                    [outlined]="true"
                                    size="small"
                                    (onClick)="openQRScanner()"
                                >
                                </p-button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Entrada Manual del Certificado -->
                <div
                    class="manual-entry-section"
                    *ngIf="
                        receptionForm.get('receptionMethod')?.value ===
                        'MANUAL_ENTRY'
                    "
                    formGroupName="animalHealthCertificate"
                >
                    <h5 class="text-900 mb-3">
                        Datos del Certificado Zoosanitario
                    </h5>

                    <div class="grid">
                        <!-- CZPM Number -->
                        <div class="col-12 md:col-6">
                            <div class="field">
                                <label for="numeroCZPM" class="font-semibold">
                                    CZPM No
                                </label>
                                <input
                                    type="text"
                                    pInputText
                                    id="numeroCZPM"
                                    formControlName="numeroCZPM"
                                    placeholder="Ej: 2023-05-9765837433"
                                    styleClass="w-full"
                                />
                            </div>
                        </div>

                        <!-- Autorizado A -->
                        <div class="col-12 md:col-6">
                            <div class="field">
                                <label for="autorizadoA" class="font-semibold">
                                    Autorizado A *
                                </label>
                                <input
                                    type="text"
                                    pInputText
                                    id="autorizadoA"
                                    formControlName="autorizadoA"
                                    placeholder="Ej: 0801921727"
                                    styleClass="w-full"
                                    [class.ng-invalid]="
                                        receptionForm.get(
                                            'animalHealthCertificate.autorizadoA'
                                        )?.invalid &&
                                        receptionForm.get(
                                            'animalHealthCertificate.autorizadoA'
                                        )?.touched
                                    "
                                />
                                <small
                                    class="p-error"
                                    *ngIf="
                                        receptionForm.get(
                                            'animalHealthCertificate.autorizadoA'
                                        )?.invalid &&
                                        receptionForm.get(
                                            'animalHealthCertificate.autorizadoA'
                                        )?.touched
                                    "
                                >
                                    Este campo es requerido
                                </small>
                            </div>
                        </div>

                        <!-- Código Área Origen -->
                        <div class="col-12 md:col-6">
                            <div class="field">
                                <label
                                    for="codigoAreaOrigen"
                                    class="font-semibold"
                                >
                                    Código Área Origen *
                                </label>
                                <input
                                    type="text"
                                    pInputText
                                    id="codigoAreaOrigen"
                                    formControlName="codigoAreaOrigen"
                                    placeholder="Ej: 03-0062-00436-00374833"
                                    styleClass="w-full"
                                    [class.ng-invalid]="
                                        receptionForm.get(
                                            'animalHealthCertificate.codigoAreaOrigen'
                                        )?.invalid &&
                                        receptionForm.get(
                                            'animalHealthCertificate.codigoAreaOrigen'
                                        )?.touched
                                    "
                                />
                                <small
                                    class="p-error"
                                    *ngIf="
                                        receptionForm.get(
                                            'animalHealthCertificate.codigoAreaOrigen'
                                        )?.invalid &&
                                        receptionForm.get(
                                            'animalHealthCertificate.codigoAreaOrigen'
                                        )?.touched
                                    "
                                >
                                    Este campo es requerido
                                </small>
                            </div>
                        </div>

                        <!-- Código Área Destino -->
                        <div class="col-12 md:col-6">
                            <div class="field">
                                <label
                                    for="codigoAreaDestino"
                                    class="font-semibold"
                                >
                                    Código Área Destino *
                                </label>
                                <input
                                    type="text"
                                    pInputText
                                    id="codigoAreaDestino"
                                    formControlName="codigoAreaDestino"
                                    placeholder="Ej: 03-0062-00438-00160206"
                                    styleClass="w-full"
                                    [class.ng-invalid]="
                                        receptionForm.get(
                                            'animalHealthCertificate.codigoAreaDestino'
                                        )?.invalid &&
                                        receptionForm.get(
                                            'animalHealthCertificate.codigoAreaDestino'
                                        )?.touched
                                    "
                                />
                                <small
                                    class="p-error"
                                    *ngIf="
                                        receptionForm.get(
                                            'animalHealthCertificate.codigoAreaDestino'
                                        )?.invalid &&
                                        receptionForm.get(
                                            'animalHealthCertificate.codigoAreaDestino'
                                        )?.touched
                                    "
                                >
                                    Este campo es requerido
                                </small>
                            </div>
                        </div>

                        <!-- Vehículo -->
                        <div class="col-12 md:col-6">
                            <div class="field">
                                <label for="vehiculo" class="font-semibold">
                                    Vehículo *
                                </label>
                                <input
                                    type="text"
                                    pInputText
                                    id="vehiculo"
                                    formControlName="vehiculo"
                                    placeholder="Ej: JBE0076"
                                    styleClass="w-full"
                                    [class.ng-invalid]="
                                        receptionForm.get(
                                            'animalHealthCertificate.vehiculo'
                                        )?.invalid &&
                                        receptionForm.get(
                                            'animalHealthCertificate.vehiculo'
                                        )?.touched
                                    "
                                />
                                <small
                                    class="p-error"
                                    *ngIf="
                                        receptionForm.get(
                                            'animalHealthCertificate.vehiculo'
                                        )?.invalid &&
                                        receptionForm.get(
                                            'animalHealthCertificate.vehiculo'
                                        )?.touched
                                    "
                                >
                                    Este campo es requerido
                                </small>
                            </div>
                        </div>

                        <!-- Total Productos -->
                        <div class="col-12 md:col-6">
                            <div class="field">
                                <label
                                    for="totalProductos"
                                    class="font-semibold"
                                >
                                    Total Productos *
                                </label>
                                <p-inputNumber
                                    id="totalProductos"
                                    formControlName="totalProductos"
                                    placeholder="1"
                                    [min]="1"
                                    [max]="1000"
                                    styleClass="w-full"
                                    [class.ng-invalid]="
                                        receptionForm.get(
                                            'animalHealthCertificate.totalProductos'
                                        )?.invalid &&
                                        receptionForm.get(
                                            'animalHealthCertificate.totalProductos'
                                        )?.touched
                                    "
                                >
                                </p-inputNumber>
                                <small
                                    class="p-error"
                                    *ngIf="
                                        receptionForm.get(
                                            'animalHealthCertificate.totalProductos'
                                        )?.invalid &&
                                        receptionForm.get(
                                            'animalHealthCertificate.totalProductos'
                                        )?.touched
                                    "
                                >
                                    Debe ser un número mayor a 0
                                </small>
                            </div>
                        </div>

                        <!-- Válido Hasta -->
                        <div class="col-12">
                            <div class="field">
                                <label for="validoHasta" class="font-semibold">
                                    Válido Hasta *
                                </label>
                                <p-calendar
                                    id="validoHasta"
                                    formControlName="validoHasta"
                                    placeholder="Seleccione fecha y hora"
                                    [showTime]="true"
                                    [showIcon]="true"
                                    [dateFormat]="'dd/mm/yy'"
                                    styleClass="w-full"
                                    [class.ng-invalid]="
                                        receptionForm.get(
                                            'animalHealthCertificate.validoHasta'
                                        )?.invalid &&
                                        receptionForm.get(
                                            'animalHealthCertificate.validoHasta'
                                        )?.touched
                                    "
                                >
                                </p-calendar>
                                <small
                                    class="p-error"
                                    *ngIf="
                                        receptionForm.get(
                                            'animalHealthCertificate.validoHasta'
                                        )?.invalid &&
                                        receptionForm.get(
                                            'animalHealthCertificate.validoHasta'
                                        )?.touched
                                    "
                                >
                                    Fecha de validez es requerida
                                </small>
                            </div>
                        </div>
                    </div>

                    <!-- Botón para procesar entrada manual -->
                    <div class="flex justify-content-end gap-2 mb-4">
                        <p-button
                            label="Validar Certificado"
                            icon="pi pi-check"
                            severity="success"
                            [outlined]="true"
                            (onClick)="processManualEntry()"
                            [disabled]="
                                !receptionForm.get(
                                    'animalHealthCertificate.autorizadoA'
                                )?.value
                            "
                        >
                        </p-button>
                    </div>
                </div>

                <!-- Información del Certificado (después del procesamiento) -->
                <div
                    class="certificate-info"
                    *ngIf="certificateData || certificateValidation"
                >
                    <p-panel
                        header="Información del Certificado"
                        [toggleable]="false"
                    >
                        <!-- Mostrar datos del certificado -->
                        <div class="grid" *ngIf="certificateData">
                            <div class="col-12 md:col-6">
                                <div class="info-item">
                                    <label class="font-semibold text-600"
                                        >Certificado No:</label
                                    >
                                    <span class="ml-2">{{
                                        certificateData.numeroCZPM
                                    }}</span>
                                </div>
                            </div>
                            <div class="col-12 md:col-6">
                                <div class="info-item">
                                    <label class="font-semibold text-600"
                                        >Autorizado A:</label
                                    >
                                    <span class="ml-2">{{
                                        certificateData.autorizadoA
                                    }}</span>
                                </div>
                            </div>
                            <div class="col-12 md:col-6">
                                <div class="info-item">
                                    <label class="font-semibold text-600"
                                        >Origen:</label
                                    >
                                    <span class="ml-2">{{
                                        certificateData.codigoAreaOrigen
                                    }}</span>
                                </div>
                            </div>
                            <div class="col-12 md:col-6">
                                <div class="info-item">
                                    <label class="font-semibold text-600"
                                        >Destino:</label
                                    >
                                    <span class="ml-2">{{
                                        certificateData.codigoAreaDestino
                                    }}</span>
                                </div>
                            </div>
                            <div class="col-12 md:col-6">
                                <div class="info-item">
                                    <label class="font-semibold text-600"
                                        >Vehículo:</label
                                    >
                                    <span class="ml-2">{{
                                        certificateData.vehiculo
                                    }}</span>
                                </div>
                            </div>
                            <div class="col-12 md:col-6">
                                <div class="info-item">
                                    <label class="font-semibold text-600"
                                        >Total Productos:</label
                                    >
                                    <span class="ml-2">{{
                                        certificateData.totalProductos
                                    }}</span>
                                </div>
                            </div>
                            <div class="col-12">
                                <div class="info-item">
                                    <label class="font-semibold text-600"
                                        >Válido Hasta:</label
                                    >
                                    <span class="ml-2">{{
                                        certificateData.validoHasta
                                            | date : "dd/MM/yyyy HH:mm"
                                    }}</span>
                                </div>
                            </div>
                        </div>

                        <!-- Mostrar datos del formulario si no hay certificado parseado -->
                        <div
                            class="grid"
                            *ngIf="!certificateData && certificateValidation"
                            formGroupName="animalHealthCertificate"
                        >
                            <div class="col-12 md:col-6">
                                <div class="info-item">
                                    <label class="font-semibold text-600"
                                        >Autorizado A:</label
                                    >
                                    <span class="ml-2">{{
                                        receptionForm.get(
                                            "animalHealthCertificate.autorizadoA"
                                        )?.value
                                    }}</span>
                                </div>
                            </div>
                            <div class="col-12 md:col-6">
                                <div class="info-item">
                                    <label class="font-semibold text-600"
                                        >Vehículo:</label
                                    >
                                    <span class="ml-2">{{
                                        receptionForm.get(
                                            "animalHealthCertificate.vehiculo"
                                        )?.value
                                    }}</span>
                                </div>
                            </div>
                            <div class="col-12 md:col-6">
                                <div class="info-item">
                                    <label class="font-semibold text-600"
                                        >Total Productos:</label
                                    >
                                    <span class="ml-2">{{
                                        receptionForm.get(
                                            "animalHealthCertificate.totalProductos"
                                        )?.value
                                    }}</span>
                                </div>
                            </div>
                            <div class="col-12 md:col-6">
                                <div class="info-item">
                                    <label class="font-semibold text-600"
                                        >Válido Hasta:</label
                                    >
                                    <span class="ml-2">{{
                                        receptionForm.get(
                                            "animalHealthCertificate.validoHasta"
                                        )?.value | date : "dd/MM/yyyy HH:mm"
                                    }}</span>
                                </div>
                            </div>
                        </div>

                        <!-- Badge del método usado -->
                        <div class="col-12" *ngIf="certificateData">
                            <div class="scan-method-badge mt-3">
                                <p-tag
                                    [value]="
                                        'Método: ' + getReceptionMethodLabel()
                                    "
                                    severity="info"
                                    icon="pi pi-qrcode"
                                >
                                </p-tag>
                            </div>
                        </div>
                    </p-panel>
                </div>

                <!-- Estado de Validación del Certificado -->
                <div
                    class="validation-status mt-4"
                    *ngIf="certificateValidation"
                >
                    <p-message
                        *ngIf="
                            certificateValidation.isValid &&
                            certificateValidation.warnings.length === 0
                        "
                        severity="success"
                        text="Certificado válido y vigente"
                    >
                    </p-message>

                    <p-message
                        *ngFor="let warning of certificateValidation.warnings"
                        severity="warn"
                        [text]="warning"
                    >
                    </p-message>

                    <p-message
                        *ngFor="let error of certificateValidation.errors"
                        severity="error"
                        [text]="error"
                    >
                    </p-message>
                </div>

                <!-- Botones de Acción -->
                <div class="flex justify-content-end gap-2 mt-4">
                    <p-button
                        label="Siguiente"
                        icon="pi pi-arrow-right"
                        iconPos="right"
                        [disabled]="!canProceedToNextStep()"
                        (onClick)="nextStep()"
                    >
                    </p-button>
                </div>
            </p-card>
        </div>

        <!-- ===== PASO 2: INFORMACIÓN DE TRANSPORTE ===== -->
        <div class="step-content-panel" *ngIf="currentStep === 2">
            <p-card header="Condiciones de Transporte" styleClass="h-full">
                <div formGroupName="transporte">
                    <!-- Información Ambiental -->
                    <div class="transport-section mb-4">
                        <h5 class="text-900 mb-3">
                            <i class="pi pi-cloud text-primary mr-2"></i>
                            Condiciones Ambientales
                        </h5>

                        <div class="grid">
                            <!-- Temperatura -->
                            <div class="col-12 md:col-6">
                                <div class="field">
                                    <label
                                        for="temperatura"
                                        class="font-semibold"
                                    >
                                        Temperatura (°C) *
                                    </label>
                                    <p-inputNumber
                                        id="temperatura"
                                        formControlName="temperatura"
                                        placeholder="Ej: 15.5"
                                        mode="decimal"
                                        [minFractionDigits]="1"
                                        [maxFractionDigits]="1"
                                        [min]="-10"
                                        [max]="50"
                                        suffix=" °C"
                                        styleClass="w-full"
                                        [class.ng-invalid]="
                                            receptionForm.get(
                                                'transporte.temperatura'
                                            )?.invalid &&
                                            receptionForm.get(
                                                'transporte.temperatura'
                                            )?.touched
                                        "
                                    >
                                    </p-inputNumber>
                                    <small
                                        class="p-error"
                                        *ngIf="
                                            receptionForm.get(
                                                'transporte.temperatura'
                                            )?.invalid &&
                                            receptionForm.get(
                                                'transporte.temperatura'
                                            )?.touched
                                        "
                                    >
                                        Temperatura requerida (entre -10°C y
                                        50°C)
                                    </small>
                                </div>
                            </div>

                            <!-- Humedad Ambiental -->
                            <div class="col-12 md:col-6">
                                <div class="field">
                                    <label
                                        for="humedadAmbiental"
                                        class="font-semibold"
                                    >
                                        Humedad Ambiental (%) *
                                    </label>
                                    <p-inputNumber
                                        id="humedadAmbiental"
                                        formControlName="humedadAmbiental"
                                        placeholder="Ej: 65"
                                        [min]="0"
                                        [max]="100"
                                        suffix=" %"
                                        styleClass="w-full"
                                        [class.ng-invalid]="
                                            receptionForm.get(
                                                'transporte.humedadAmbiental'
                                            )?.invalid &&
                                            receptionForm.get(
                                                'transporte.humedadAmbiental'
                                            )?.touched
                                        "
                                    >
                                    </p-inputNumber>
                                    <small
                                        class="p-error"
                                        *ngIf="
                                            receptionForm.get(
                                                'transporte.humedadAmbiental'
                                            )?.invalid &&
                                            receptionForm.get(
                                                'transporte.humedadAmbiental'
                                            )?.touched
                                        "
                                    >
                                        Humedad requerida (entre 0% y 100%)
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Condiciones Higiénicas y Estado -->
                    <div class="transport-section mb-4">
                        <h5 class="text-900 mb-3">
                            <i class="pi pi-shield text-primary mr-2"></i>
                            Condiciones Higiénicas y Estado de Animales
                        </h5>

                        <div class="grid">
                            <!-- Condiciones Higiénicas -->
                            <div class="col-12 md:col-6">
                                <div class="field">
                                    <label
                                        for="condicionesHigienicas"
                                        class="font-semibold"
                                    >
                                        Condiciones Higiénicas *
                                    </label>
                                    <p-dropdown
                                        id="condicionesHigienicas"
                                        formControlName="condicionesHigienicas"
                                        [options]="hygienicConditionOptions"
                                        optionLabel="label"
                                        optionValue="value"
                                        placeholder="Seleccionar condición"
                                        styleClass="w-full"
                                        [class.ng-invalid]="
                                            receptionForm.get(
                                                'transporte.condicionesHigienicas'
                                            )?.invalid &&
                                            receptionForm.get(
                                                'transporte.condicionesHigienicas'
                                            )?.touched
                                        "
                                    >
                                        <ng-template
                                            let-option
                                            pTemplate="item"
                                        >
                                            <div
                                                class="flex align-items-center gap-2"
                                            >
                                                <i
                                                    class="pi"
                                                    [class.pi-check-circle]="
                                                        option.value ===
                                                        'Óptimas'
                                                    "
                                                    [class.pi-exclamation-triangle]="
                                                        option.value ===
                                                        'Aceptables'
                                                    "
                                                    [class.pi-times-circle]="
                                                        option.value ===
                                                        'Deficientes'
                                                    "
                                                    [style.color]="
                                                        option.value ===
                                                        'Óptimas'
                                                            ? 'green'
                                                            : option.value ===
                                                              'Aceptables'
                                                            ? 'orange'
                                                            : 'red'
                                                    "
                                                ></i>
                                                <span>{{ option.label }}</span>
                                            </div>
                                        </ng-template>
                                    </p-dropdown>
                                    <small
                                        class="p-error"
                                        *ngIf="
                                            receptionForm.get(
                                                'transporte.condicionesHigienicas'
                                            )?.invalid &&
                                            receptionForm.get(
                                                'transporte.condicionesHigienicas'
                                            )?.touched
                                        "
                                    >
                                        Debe seleccionar las condiciones
                                        higiénicas
                                    </small>
                                </div>
                            </div>

                            <!-- Fecha de Inspección -->
                            <div class="col-12 md:col-6">
                                <div class="field">
                                    <label
                                        for="fechaInspeccion"
                                        class="font-semibold"
                                    >
                                        Fecha de Inspección *
                                    </label>
                                    <p-calendar
                                        id="fechaInspeccion"
                                        formControlName="fechaInspeccion"
                                        placeholder="Fecha y hora de inspección"
                                        [showTime]="true"
                                        [showIcon]="true"
                                        [dateFormat]="'dd/mm/yy'"
                                        styleClass="w-full"
                                        [class.ng-invalid]="
                                            receptionForm.get(
                                                'transporte.fechaInspeccion'
                                            )?.invalid &&
                                            receptionForm.get(
                                                'transporte.fechaInspeccion'
                                            )?.touched
                                        "
                                    >
                                    </p-calendar>
                                    <small
                                        class="p-error"
                                        *ngIf="
                                            receptionForm.get(
                                                'transporte.fechaInspeccion'
                                            )?.invalid &&
                                            receptionForm.get(
                                                'transporte.fechaInspeccion'
                                            )?.touched
                                        "
                                    >
                                        Fecha de inspección es requerida
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Condición de Animales -->
                    <div class="transport-section mb-4">
                        <div class="field">
                            <label
                                for="condicionAnimales"
                                class="font-semibold"
                            >
                                Condición de Animales *
                            </label>
                            <textarea
                                style="width: 100%"
                                pInputTextarea
                                id="condicionAnimales"
                                formControlName="condicionAnimales"
                                placeholder="Describa detalladamente la condición física y estado de los animales al momento de la recepción..."
                                rows="4"
                                maxlength="500"
                                styleClass="w-full"
                                [class.ng-invalid]="
                                    receptionForm.get(
                                        'transporte.condicionAnimales'
                                    )?.invalid &&
                                    receptionForm.get(
                                        'transporte.condicionAnimales'
                                    )?.touched
                                "
                            >
                            </textarea>
                            <div
                                class="flex justify-content-between align-items-center mt-2"
                            >
                                <small
                                    class="p-error"
                                    *ngIf="
                                        receptionForm.get(
                                            'transporte.condicionAnimales'
                                        )?.invalid &&
                                        receptionForm.get(
                                            'transporte.condicionAnimales'
                                        )?.touched
                                    "
                                >
                                    La condición de animales es requerida
                                </small>
                                <small class="text-600">
                                    {{
                                        receptionForm.get(
                                            "transporte.condicionAnimales"
                                        )?.value?.length || 0
                                    }}/500 caracteres
                                </small>
                            </div>
                        </div>
                    </div>

                    <!-- Observaciones -->
                    <div class="transport-section mb-4">
                        <div class="field">
                            <label
                                for="transporteObservaciones"
                                class="font-semibold"
                            >
                                Observaciones Adicionales
                            </label>
                            <textarea
                                style="width: 100%"
                                pInputTextarea
                                id="transporteObservaciones"
                                formControlName="observaciones"
                                placeholder="Observaciones adicionales sobre el transporte, condiciones especiales, incidentes, etc..."
                                rows="3"
                                maxlength="1000"
                                styleClass="w-full"
                            >
                            </textarea>
                            <div class="flex justify-content-end mt-2">
                                <small class="text-600">
                                    {{
                                        receptionForm.get(
                                            "transporte.observaciones"
                                        )?.value?.length || 0
                                    }}/1000 caracteres
                                </small>
                            </div>
                        </div>
                    </div>

                    <!-- Fotografías -->
                    <div class="transport-section mb-4">
                        <h5 class="text-900 mb-3">
                            <i class="pi pi-camera text-primary mr-2"></i>
                            Fotografías del Transporte
                        </h5>

                        <!-- Uploader de archivos -->
                        <div class="photo-upload-section">
                            <p-fileUpload
                                mode="basic"
                                chooseLabel="Seleccionar Fotografías"
                                accept="image/*"
                                [multiple]="true"
                                [maxFileSize]="maxFileSize"
                                [auto]="false"
                                (onSelect)="onPhotosSelected($event)"
                                styleClass="w-full"
                            >
                            </p-fileUpload>

                            <div class="upload-info mt-2">
                                <small class="text-600">
                                    <i class="pi pi-info-circle mr-1"></i>
                                    Máximo {{ maxPhotos }} fotos. Tamaño máximo:
                                    5MB por foto. Formatos: JPG, PNG, WebP
                                </small>
                            </div>
                        </div>

                        <!-- Preview de fotografías seleccionadas -->
                        <div
                            class="selected-photos mt-4"
                            *ngIf="selectedPhotos.length > 0"
                        >
                            <h6 class="text-900 mb-3">
                                Fotografías Seleccionadas ({{
                                    selectedPhotos.length
                                }})
                            </h6>

                            <div class="grid">
                                <div
                                    class="col-12 md:col-6 lg:col-4"
                                    *ngFor="
                                        let photo of selectedPhotos;
                                        let i = index
                                    "
                                >
                                    <div class="photo-preview-card">
                                        <div class="photo-preview-header">
                                            <span class="photo-name">{{
                                                photo.name
                                            }}</span>
                                            <p-button
                                                icon="pi pi-times"
                                                severity="danger"
                                                [text]="true"
                                                size="small"
                                                (onClick)="removePhoto(i)"
                                            >
                                            </p-button>
                                        </div>
                                        <div class="photo-info">
                                            <small class="text-600">
                                                {{ formatFileSize(photo.size) }}
                                            </small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Estado vacío -->
                        <div
                            class="empty-photos text-center p-4"
                            *ngIf="selectedPhotos.length === 0"
                        >
                            <i class="pi pi-camera text-4xl text-400 mb-2"></i>
                            <p class="text-600">
                                No hay fotografías seleccionadas
                            </p>
                            <small class="text-500">
                                Las fotografías ayudan a documentar las
                                condiciones de transporte
                            </small>
                        </div>
                    </div>
                </div>

                <!-- Botones de Acción -->
                <div class="flex justify-content-between gap-2 mt-4">
                    <p-button
                        label="Anterior"
                        icon="pi pi-arrow-left"
                        severity="secondary"
                        [outlined]="true"
                        (onClick)="previousStep()"
                    >
                    </p-button>
                    <p-button
                        label="Siguiente"
                        icon="pi pi-arrow-right"
                        iconPos="right"
                        [disabled]="!canProceedToNextStep()"
                        (onClick)="nextStep()"
                    >
                    </p-button>
                </div>
            </p-card>
        </div>

        <!-- ===== PASO 3: CONFIRMACIÓN ===== -->
        <div class="step-content-panel" *ngIf="currentStep === 3">
            <p-card header="Confirmación de Recepción" styleClass="h-full">
                <!-- Resumen del Proceso -->
                <div class="summary-section">
                    <h5 class="text-900 mb-3">Resumen del Proceso</h5>

                    <!-- Resumen del Certificado -->
                    <p-panel
                        header="Certificado Zoosanitario"
                        styleClass="mb-3"
                    >
                        <div class="grid">
                            <div class="col-12 md:col-6">
                                <div class="info-item mb-2">
                                    <label class="font-semibold text-600"
                                        >Número:</label
                                    >
                                    <span class="ml-2">{{
                                        certificateData?.numeroCZPM ||
                                            receptionForm.get(
                                                "animalHealthCertificate.numeroCZPM"
                                            )?.value ||
                                            "Por generar"
                                    }}</span>
                                </div>
                                <div class="info-item mb-2">
                                    <label class="font-semibold text-600"
                                        >Método:</label
                                    >
                                    <span class="ml-2">{{
                                        getReceptionMethodLabel()
                                    }}</span>
                                </div>
                                <div class="info-item mb-2">
                                    <label class="font-semibold text-600"
                                        >Autorizado A:</label
                                    >
                                    <span class="ml-2">{{
                                        certificateData?.autorizadoA ||
                                            receptionForm.get(
                                                "animalHealthCertificate.autorizadoA"
                                            )?.value
                                    }}</span>
                                </div>
                            </div>
                            <div class="col-12 md:col-6">
                                <div class="info-item mb-2">
                                    <label class="font-semibold text-600"
                                        >Vehículo:</label
                                    >
                                    <span class="ml-2">{{
                                        certificateData?.vehiculo ||
                                            receptionForm.get(
                                                "animalHealthCertificate.vehiculo"
                                            )?.value
                                    }}</span>
                                </div>
                                <div class="info-item mb-2">
                                    <label class="font-semibold text-600"
                                        >Total Productos:</label
                                    >
                                    <span class="ml-2">{{
                                        certificateData?.totalProductos ||
                                            receptionForm.get(
                                                "animalHealthCertificate.totalProductos"
                                            )?.value
                                    }}</span>
                                </div>
                                <div class="info-item mb-2">
                                    <label class="font-semibold text-600"
                                        >Vencimiento:</label
                                    >
                                    <span class="ml-2">{{
                                        certificateData?.validoHasta ||
                                            receptionForm.get(
                                                "animalHealthCertificate.validoHasta"
                                            )?.value | date : "dd/MM/yyyy HH:mm"
                                    }}</span>
                                </div>
                            </div>
                        </div>
                    </p-panel>

                    <!-- Resumen de Transporte -->
                    <p-panel
                        header="Condiciones de Transporte"
                        styleClass="mb-3"
                    >
                        <div class="grid">
                            <div class="col-12 md:col-4">
                                <div class="transport-stat">
                                    <div class="stat-label">Temperatura</div>
                                    <div class="stat-value">
                                        {{
                                            receptionForm.get(
                                                "transporte.temperatura"
                                            )?.value
                                        }}°C
                                    </div>
                                </div>
                            </div>
                            <div class="col-12 md:col-4">
                                <div class="transport-stat">
                                    <div class="stat-label">Humedad</div>
                                    <div class="stat-value">
                                        {{
                                            receptionForm.get(
                                                "transporte.humedadAmbiental"
                                            )?.value
                                        }}%
                                    </div>
                                </div>
                            </div>
                            <div class="col-12 md:col-4">
                                <div class="transport-stat">
                                    <div class="stat-label">
                                        Condiciones Higiénicas
                                    </div>
                                    <div class="stat-value">
                                        <p-tag
                                            [value]="
                                                receptionForm.get(
                                                    'transporte.condicionesHigienicas'
                                                )?.value
                                            "
                                            [severity]="
                                                receptionForm.get(
                                                    'transporte.condicionesHigienicas'
                                                )?.value === 'Óptimas'
                                                    ? 'success'
                                                    : receptionForm.get(
                                                          'transporte.condicionesHigienicas'
                                                      )?.value === 'Aceptables'
                                                    ? 'warning'
                                                    : 'danger'
                                            "
                                        >
                                        </p-tag>
                                    </div>
                                </div>
                            </div>
                            <div class="col-12">
                                <div class="transport-stat">
                                    <div class="stat-label">
                                        Condición de Animales
                                    </div>
                                    <div class="stat-value text-sm">
                                        {{
                                            receptionForm.get(
                                                "transporte.condicionAnimales"
                                            )?.value
                                        }}
                                    </div>
                                </div>
                            </div>
                            <div
                                class="col-12"
                                *ngIf="selectedPhotos.length > 0"
                            >
                                <div class="transport-stat">
                                    <div class="stat-label">Fotografías</div>
                                    <div class="stat-value">
                                        <p-tag
                                            [value]="
                                                selectedPhotos.length +
                                                ' fotografía(s) adjunta(s)'
                                            "
                                            severity="info"
                                            icon="pi pi-camera"
                                        >
                                        </p-tag>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </p-panel>

                    <!-- Información Adicional -->
                    <div class="additional-info mb-4">
                        <div class="grid">
                            <!-- Prioridad -->
                            <div class="col-12 md:col-6">
                                <div class="field">
                                    <label
                                        for="prioridad"
                                        class="font-semibold"
                                    >
                                        Prioridad (0-10)
                                    </label>
                                    <p-inputNumber
                                        id="prioridad"
                                        formControlName="prioridad"
                                        [min]="0"
                                        [max]="10"
                                        styleClass="w-full"
                                    >
                                    </p-inputNumber>
                                    <small class="text-600">
                                        0 = Normal, 10 = Máxima urgencia
                                    </small>
                                </div>
                            </div>

                            <!-- Fecha Programada -->
                            <div class="col-12 md:col-6">
                                <div class="field">
                                    <label
                                        for="fechaProgramada"
                                        class="font-semibold"
                                    >
                                        Fecha Programada (Opcional)
                                    </label>
                                    <p-calendar
                                        id="fechaProgramada"
                                        formControlName="fechaProgramada"
                                        placeholder="Fecha para programar faenamiento"
                                        [showTime]="true"
                                        [showIcon]="true"
                                        [dateFormat]="'dd/mm/yy'"
                                        styleClass="w-full"
                                    >
                                    </p-calendar>
                                </div>
                            </div>

                            <!--Introductor Obcional-->
                            <!-- Introductor Opcional -->
                            <div class="col-12 md:col-6">
                                <div class="field">
                                    <label
                                        for="introducer"
                                        class="font-semibold"
                                    >
                                        Introductor
                                    </label>
                                    <p-dropdown
                                        id="introducer"
                                        formControlName="introducer"
                                        [options]="intruders"
                                        optionLabel="name"
                                        optionValue="_id"
                                        styleClass="w-full"
                                        filter="true"
                                        [class.ng-invalid]="
                                            receptionForm.get('introducer')
                                                ?.invalid &&
                                            receptionForm.get('introducer')
                                                ?.touched
                                        "
                                    >
                                        <ng-template
                                            let-option
                                            pTemplate="item"
                                        >
                                            <div
                                                class="flex align-items-center gap-2"
                                            >
                                                <i
                                                    class="pi pi-user"
                                                    style="color: #2196f3"
                                                ></i>
                                                <span>{{ option.name }}</span>
                                            </div>
                                        </ng-template>
                                    </p-dropdown>
                                    <small
                                        class="p-error"
                                        *ngIf="
                                            receptionForm.get('introducer')
                                                ?.invalid &&
                                            receptionForm.get('introducer')
                                                ?.touched
                                        "
                                    >
                                        Debe seleccionar un introductor
                                    </small>
                                </div>
                            </div>
                        </div>

                        <!-- Observaciones Generales -->
                        <div class="field">
                            <label
                                for="observacionesGenerales"
                                class="font-semibold"
                            >
                                Observaciones Generales
                            </label>
                            <textarea
                                style="width: 100%"
                                pInputTextarea
                                id="observacionesGenerales"
                                formControlName="observaciones"
                                placeholder="Observaciones adicionales sobre la recepción..."
                                rows="3"
                                maxlength="1000"
                                styleClass="w-full"
                            >
                            </textarea>
                            <div class="flex justify-content-end mt-2">
                                <small class="text-600">
                                    {{
                                        receptionForm.get("observaciones")
                                            ?.value?.length || 0
                                    }}/1000 caracteres
                                </small>
                            </div>
                        </div>
                    </div>

                    <!-- Información del Proceso -->
                    <p-panel header="Proceso Automático" styleClass="mb-3">
                        <div class="process-info">
                            <p class="text-700 mb-3">
                                Al confirmar esta recepción, el sistema
                                realizará automáticamente:
                            </p>
                            <ul class="process-steps">
                                <li>
                                    <i
                                        class="pi pi-check-circle text-green-500 mr-2"
                                    ></i>
                                    Crear el registro de recepción
                                </li>
                                <li>
                                    <i
                                        class="pi pi-check-circle text-green-500 mr-2"
                                    ></i>
                                    Generar
                                    {{
                                        certificateData?.totalProductos ||
                                            receptionForm.get(
                                                "animalHealthCertificate.totalProductos"
                                            )?.value ||
                                            0
                                    }}
                                    inspección(es) externa(s)
                                </li>
                                <li>
                                    <i
                                        class="pi pi-check-circle text-green-500 mr-2"
                                    ></i>
                                    Iniciar el proceso de faenamiento
                                </li>
                                <li>
                                    <i
                                        class="pi pi-check-circle text-green-500 mr-2"
                                    ></i>
                                    Detectar automáticamente el introductor
                                </li>
                            </ul>
                        </div>
                    </p-panel>
                </div>

                <!-- Botones de Acción -->
                <div class="flex justify-content-between gap-2 mt-4">
                    <p-button
                        label="Anterior"
                        icon="pi pi-arrow-left"
                        severity="secondary"
                        [outlined]="true"
                        (onClick)="previousStep()"
                    >
                    </p-button>
                    <p-button
                        label="Crear Recepción"
                        icon="pi pi-check"
                        iconPos="right"
                        [loading]="submitting"
                        type="submit"
                        styleClass="reception-submit-btn"
                    >
                    </p-button>
                </div>
            </p-card>
        </div>
    </form>
</div>

<!-- Diálogos de Confirmación -->
<p-confirmDialog></p-confirmDialog>

<!-- Toast para notificaciones -->
<p-toast></p-toast>

<!-- Modal QR Scanner (Refactorizado) -->
<app-qr-scanner-modal
    [(visible)]="showQRScannerModal"
    [options]="qrScanOptions"
    (certificateScanned)="onCertificateScanned($event)"
    (scanCancelled)="onQRScanCancelled()"
>
</app-qr-scanner-modal>
