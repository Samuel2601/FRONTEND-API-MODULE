<p-dialog
    [(visible)]="visible"
    [header]="header"
    [modal]="true"
    [closable]="true"
    [draggable]="false"
    [resizable]="false"
    [style]="{ width: '90vw', 'max-width': '450px' }"
    [closeOnEscape]="true"
    (onShow)="onShow()"
    (onHide)="onHide()"
>
    <div class="qr-scanner-content">
        <!-- Loading State -->
        <div
            *ngIf="isLoading && !processingResult"
            class="scanner-state loading-state"
        >
            <div class="state-icon">
                <i class="pi pi-camera text-6xl text-primary animate-pulse"></i>
            </div>
            <h4 class="state-title">Preparando Escáner</h4>
            <p class="state-message text-600">Iniciando cámara...</p>
            <p-progressBar
                mode="indeterminate"
                [style]="{ height: '6px' }"
                class="mt-3 w-full"
            ></p-progressBar>
        </div>

        <!-- Processing Result State -->
        <div *ngIf="processingResult" class="scanner-state processing-state">
            <div class="state-icon" [class.success]="showSuccessAnimation">
                <i
                    class="pi pi-check-circle text-6xl text-green-500"
                    *ngIf="showSuccessAnimation"
                ></i>
                <i
                    class="pi pi-qrcode text-6xl text-primary animate-pulse"
                    *ngIf="!showSuccessAnimation"
                ></i>
            </div>
            <h4
                class="state-title"
                [class.text-green-600]="showSuccessAnimation"
            >
                {{
                    showSuccessAnimation
                        ? "¡Certificado Detectado!"
                        : "Procesando QR..."
                }}
            </h4>
            <div class="result-preview" *ngIf="scanResult">
                <p class="text-sm text-600 mb-2">Contenido detectado:</p>
                <div class="result-code">
                    {{ scanResult.substring(0, 100)
                    }}{{ scanResult.length > 100 ? "..." : "" }}
                </div>
            </div>
            <p-progressBar
                mode="indeterminate"
                [style]="{ height: '6px' }"
                class="mt-3 w-full"
                *ngIf="!showSuccessAnimation"
            ></p-progressBar>
        </div>

        <!-- Manual Mode -->
        <div
            *ngIf="manualMode && !processingResult"
            class="scanner-state manual-state"
        >
            <div class="state-icon">
                <i class="pi pi-pencil text-6xl text-primary"></i>
            </div>
            <h4 class="state-title">Ingreso Manual</h4>
            <p class="state-message text-600 mb-4">
                Ingrese el número del certificado zoosanitario
            </p>

            <form (ngSubmit)="onManualSubmit()" class="manual-form">
                <div class="p-inputgroup">
                    <span class="p-inputgroup-addon">
                        <i class="pi pi-qrcode"></i>
                    </span>
                    <input
                        type="text"
                        pInputText
                        [(ngModel)]="manualInput"
                        placeholder="Ej: CZPM-12345"
                        class="text-center uppercase"
                        [style]="{ 'text-transform': 'uppercase' }"
                        (input)="manualInput = manualInput.toUpperCase()"
                        #manualInputField
                        name="manualInput"
                        autocomplete="off"
                        autocapitalize="characters"
                    />
                    <button
                        type="submit"
                        pButton
                        icon="pi pi-check"
                        class="p-button-primary"
                        [disabled]="!manualInput.trim()"
                    ></button>
                </div>
            </form>

            <div class="manual-help mt-3">
                <p class="text-sm text-600">
                    <i class="pi pi-info-circle mr-1"></i>
                    El número debe comenzar con "CZPM"
                </p>
            </div>
        </div>

        <!-- Error State -->
        <div
            *ngIf="error && !manualMode && !processingResult"
            class="scanner-state error-state"
        >
            <div class="state-icon">
                <i class="pi pi-exclamation-triangle text-6xl text-red-500"></i>
            </div>
            <h4 class="state-title text-red-600">Error de Escaneo</h4>
            <p class="state-message text-600 mb-4">
                {{ error }}
            </p>

            <div class="error-actions">
                <p-button
                    label="Reintentar"
                    icon="pi pi-refresh"
                    severity="primary"
                    (click)="retry()"
                    styleClass="mr-2"
                    *ngIf="scannerAvailable"
                ></p-button>
                <p-button
                    label="Entrada Manual"
                    icon="pi pi-pencil"
                    severity="secondary"
                    (click)="toggleManualMode()"
                ></p-button>
            </div>
        </div>

        <!-- Initial State (Web or when scanner not available) -->
        <div
            *ngIf="
                !isLoading &&
                !manualMode &&
                !error &&
                !processingResult &&
                !manualMode
            "
            class="scanner-state initial-state"
        >
            <div class="state-icon">
                <i class="pi pi-qrcode text-6xl text-primary"></i>
            </div>
            <h4 class="state-title">Escanear Certificado</h4>
            <p class="state-message text-600 mb-4">
                Seleccione cómo desea ingresar el código del certificado
            </p>

            <div class="scan-options">
                <p-button
                    label="Entrada Manual"
                    icon="pi pi-pencil"
                    severity="primary"
                    (click)="toggleManualMode()"
                    styleClass="w-full"
                ></p-button>

                <small
                    class="block text-center text-600 mt-3"
                    *ngIf="!scannerAvailable"
                >
                    <i class="pi pi-info-circle mr-1"></i>
                    El escáner requiere HTTPS en navegadores web
                </small>
            </div>
        </div>
    </div>

    <!-- Footer Actions -->
    <ng-template pTemplate="footer">
        <div class="scanner-footer">
            <!-- Mode Toggle (solo cuando no está procesando) -->
            <div
                class="mode-toggle"
                *ngIf="!processingResult && scannerAvailable && manualMode"
            >
                <p-button
                    [label]="manualMode ? 'Usar Escáner' : 'Entrada Manual'"
                    [icon]="manualMode ? 'pi pi-camera' : 'pi pi-pencil'"
                    severity="info"
                    size="small"
                    text
                    (click)="toggleManualMode()"
                ></p-button>
            </div>

            <!-- Action Buttons -->
            <div class="action-buttons">
                <p-button
                    label="Cancelar"
                    icon="pi pi-times"
                    severity="secondary"
                    (click)="cancel()"
                    [disabled]="processingResult"
                ></p-button>
            </div>
        </div>
    </ng-template>
</p-dialog>
