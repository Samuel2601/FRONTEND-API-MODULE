<div class="introducer-detail-container">
    <!-- Loading State -->
    <div *ngIf="loading" class="loading-container">
        <p-progressSpinner></p-progressSpinner>
        <p>Cargando información del introductor...</p>
    </div>

    <!-- Main Content -->
    <div *ngIf="!loading" class="detail-content">
        <!-- Header -->
        <div class="detail-header">
            <div class="header-content">
                <div class="introducer-info">
                    <h1>{{ getIntroducerName() }}</h1>
                    <div class="meta-info">
                        <p-tag
                            [value]="
                                introducer.personType === 'Natural'
                                    ? 'Persona Natural'
                                    : 'Persona Jurídica'
                            "
                            [severity]="
                                introducer.personType === 'Natural'
                                    ? 'info'
                                    : 'warning'
                            "
                        >
                        </p-tag>
                        <p-tag
                            [value]="
                                introducer.registrationStatus ||
                                'Estado no definido'
                            "
                            [severity]="
                                getStatusSeverity(introducer.registrationStatus)
                            "
                        >
                        </p-tag>
                        <p-tag
                            value="{{ getDocumentNumber() }}"
                            severity="secondary"
                        >
                        </p-tag>
                    </div>
                </div>
                <div class="header-actions">
                    <button
                        pButton
                        type="button"
                        icon="pi pi-refresh"
                        label="Actualizar"
                        class="p-button-outlined"
                        (click)="refreshData()"
                    ></button>
                    <button
                        pButton
                        type="button"
                        icon="pi pi-pencil"
                        label="Editar"
                        class="p-button-primary"
                        (click)="editIntroducer()"
                    ></button>
                    <button
                        pButton
                        type="button"
                        icon="pi pi-arrow-left"
                        label="Volver"
                        class="p-button-secondary"
                        (click)="goBack()"
                    ></button>
                </div>
            </div>
        </div>

        <!-- Estado de Faenamiento -->
        <div
            class="slaughter-status"
            [class.allowed]="canSlaughter"
            [class.denied]="!canSlaughter"
        >
            <i
                [class]="
                    canSlaughter ? 'pi pi-check-circle' : 'pi pi-times-circle'
                "
            ></i>
            <div class="status-info">
                <h4>
                    {{
                        canSlaughter
                            ? "Autorizado para Faenamiento"
                            : "No Autorizado para Faenamiento"
                    }}
                </h4>
                <p>{{ validationMessage }}</p>
                <div
                    *ngIf="
                        !canSlaughter &&
                        (paymentStatus?.required ||
                            finesStatus?.hasPendingFines)
                    "
                    class="action-buttons"
                >
                    <button
                        *ngIf="paymentStatus?.required"
                        pButton
                        type="button"
                        label="Pagar Inscripción"
                        icon="pi pi-credit-card"
                        class="p-button-sm p-button-success"
                        (click)="payInscription()"
                    ></button>
                    <button
                        *ngIf="finesStatus?.hasPendingFines"
                        pButton
                        type="button"
                        label="Pagar Multas ({{
                            formatCurrency(finesStatus.pendingAmount)
                        }})"
                        icon="pi pi-credit-card"
                        class="p-button-sm p-button-warning"
                        (click)="payFines()"
                    ></button>
                </div>
            </div>
        </div>

        <!-- Estado de Procesamiento -->
        <div
            *ngIf="introducerData?.canProceed !== undefined"
            class="process-status"
        >
            <div
                class="status-indicator"
                [class.can-proceed]="introducerData.canProceed"
                [class.blocked]="!introducerData.canProceed"
            >
                <i
                    [class]="
                        introducerData.canProceed
                            ? 'pi pi-check-circle'
                            : 'pi pi-exclamation-triangle'
                    "
                ></i>
                <div class="status-content">
                    <h4>
                        {{
                            introducerData.canProceed
                                ? "Puede proceder con nuevos faenos"
                                : "Procesamiento bloqueado"
                        }}
                    </h4>
                    <p>{{ introducerData.message }}</p>
                    <div
                        *ngIf="introducerData.details?.warningMessage"
                        class="warning-text"
                    >
                        <i class="pi pi-info-circle"></i>
                        {{ introducerData.details.warningMessage }}
                    </div>
                </div>
            </div>
        </div>

        <!-- Grid de Información -->
        <div class="info-grid">
            <!-- Información Personal/Empresarial -->
            <div class="card personal-info">
                <div class="card-header">
                    <h3>
                        <i class="pi pi-user"></i>
                        {{
                            introducer.personType === "Natural"
                                ? "Información Personal"
                                : "Información Empresarial"
                        }}
                    </h3>
                </div>
                <div class="info-grid-content">
                    <ng-container *ngIf="introducer.personType === 'Natural'">
                        <div class="info-item">
                            <label>Nombres</label>
                            <span>{{
                                introducer.name || "No especificado"
                            }}</span>
                        </div>
                        <div class="info-item">
                            <label>Cédula</label>
                            <span>{{
                                introducer.idNumber || "No especificado"
                            }}</span>
                        </div>
                    </ng-container>
                    <ng-container *ngIf="introducer.personType === 'Jurídica'">
                        <div class="info-item">
                            <label>Razón Social</label>
                            <span>{{
                                introducer.companyName || "No especificado"
                            }}</span>
                        </div>
                        <div class="info-item">
                            <label>RUC</label>
                            <span>{{
                                introducer.ruc || "No especificado"
                            }}</span>
                        </div>
                        <div class="info-item">
                            <label>Representante Legal</label>
                            <span>{{
                                introducer.legalRepresentative ||
                                    "No especificado"
                            }}</span>
                        </div>
                        <div class="info-item">
                            <label>Cédula Representante</label>
                            <span>{{
                                introducer.idNumber || "No especificado"
                            }}</span>
                        </div>
                    </ng-container>
                </div>
            </div>

            <!-- Información de Contacto -->
            <div class="card contact-info">
                <div class="card-header">
                    <h3>
                        <i class="pi pi-phone"></i>
                        Información de Contacto
                    </h3>
                </div>
                <div class="info-grid-content">
                    <div class="info-item">
                        <label>Teléfono</label>
                        <span>{{ introducer.phone || "No especificado" }}</span>
                    </div>
                    <div class="info-item">
                        <label>Email</label>
                        <span>{{ introducer.email || "No especificado" }}</span>
                    </div>
                    <div class="info-item">
                        <label>Dirección</label>
                        <span>{{
                            introducer.address || "No especificado"
                        }}</span>
                    </div>
                </div>
            </div>

            <!-- Tipos de Introductor -->
            <div class="card type-info">
                <div class="card-header">
                    <h3>
                        <i class="pi pi-list"></i>
                        Tipos de Introductor
                    </h3>
                </div>
                <div class="content">
                    <div
                        *ngIf="getIntroducerTypeLabels().length > 0"
                        class="type-chips"
                    >
                        <p-chip
                            *ngFor="let type of getIntroducerTypeLabels()"
                            [label]="type"
                            class="type-chip"
                        >
                        </p-chip>
                    </div>
                    <p
                        *ngIf="getIntroducerTypeLabels().length === 0"
                        class="no-data"
                    >
                        No se han definido tipos de introductor
                    </p>
                </div>
            </div>

            <!-- Límites y Cuotas de Procesamiento -->
            <div *ngIf="introducerData?.details" class="card limits-info">
                <div class="card-header">
                    <h3>
                        <i class="pi pi-chart-pie"></i>
                        Límites de Procesamiento
                    </h3>
                </div>
                <div class="content">
                    <div class="limits-summary">
                        <div class="limit-item">
                            <div
                                class="limit-circle"
                                [class.warning]="
                                    introducerData.details
                                        .remainingFreeProcesses <= 1
                                "
                            >
                                <span class="remaining">{{
                                    introducerData.details
                                        .remainingFreeProcesses
                                }}</span>
                                <span class="total"
                                    >/
                                    {{
                                        introducerData.details.limitInfo
                                            .maxFreeProcesses
                                    }}</span
                                >
                            </div>
                            <div class="limit-text">
                                <strong>Procesos Gratuitos Restantes</strong>
                                <p>
                                    {{
                                        introducerData.details.limitInfo
                                            .configDescription
                                    }}
                                </p>
                            </div>
                        </div>

                        <div class="limit-details">
                            <div class="detail-row">
                                <span>Procesos utilizados:</span>
                                <span class="value">{{
                                    introducerData.details.usedProcesses
                                }}</span>
                            </div>
                            <div class="detail-row">
                                <span>Configuración:</span>
                                <span class="value">{{
                                    introducerData.details.limitInfo.configCode
                                }}</span>
                            </div>
                            <div
                                class="detail-row"
                                *ngIf="
                                    introducerData.details
                                        .willRequirePaymentNext
                                "
                            >
                                <span>Próximo proceso:</span>
                                <p-tag
                                    value="Requerirá pago"
                                    severity="warning"
                                ></p-tag>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Estado de Pagos Mejorado -->
            <div class="card payment-info">
                <div class="card-header">
                    <h3>
                        <i class="pi pi-credit-card"></i>
                        Estado de Pagos
                    </h3>
                </div>
                <div class="content">
                    <!-- Estado de Inscripción -->
                    <div class="payment-section">
                        <div class="payment-header">
                            <span class="payment-label"
                                >Tarifa de Inscripción</span
                            >
                            <p-tag
                                [value]="
                                    paymentStatus?.required
                                        ? 'Pendiente'
                                        : 'Pagado'
                                "
                                [severity]="
                                    paymentStatus?.required
                                        ? 'warning'
                                        : 'success'
                                "
                            >
                            </p-tag>
                        </div>
                        <p class="payment-message">
                            {{ paymentStatus?.message || "Sin información" }}
                        </p>
                        <div *ngIf="paymentStatus?.rateId" class="rate-info">
                            <small class="rate-id"
                                >ID de Tarifa: {{ paymentStatus.rateId }}</small
                            >
                        </div>
                        <small
                            *ngIf="paymentStatus?.paidDate"
                            class="payment-date"
                        >
                            Pagado el: {{ formatDate(paymentStatus.paidDate) }}
                        </small>
                        <small
                            *ngIf="paymentStatus?.lastUpdated"
                            class="last-updated"
                        >
                            Actualizado:
                            {{ formatDate(paymentStatus.lastUpdated) }}
                        </small>
                    </div>

                    <!-- Estado de Multas -->
                    <div class="payment-section">
                        <div class="payment-header">
                            <span class="payment-label">Multas</span>
                            <p-tag
                                [value]="
                                    finesStatus?.hasPendingFines
                                        ? 'Pendientes'
                                        : 'Al día'
                                "
                                [severity]="
                                    finesStatus?.hasPendingFines
                                        ? 'danger'
                                        : 'success'
                                "
                            >
                            </p-tag>
                        </div>
                        <div
                            *ngIf="finesStatus?.hasPendingFines"
                            class="fines-info"
                        >
                            <p class="amount">
                                Monto pendiente:
                                {{ formatCurrency(finesStatus.pendingAmount) }}
                            </p>
                            <div
                                *ngIf="finesStatus.fines?.length > 0"
                                class="fines-list"
                            >
                                <div
                                    *ngFor="let fine of finesStatus.fines"
                                    class="fine-item"
                                >
                                    <span>{{ fine.invoiceNumber }}</span>
                                    <span>{{
                                        formatCurrency(fine.amount)
                                    }}</span>
                                    <small>{{
                                        formatDate(fine.issueDate)
                                    }}</small>
                                </div>
                            </div>
                        </div>
                        <p
                            *ngIf="!finesStatus?.hasPendingFines"
                            class="payment-message"
                        >
                            Sin multas pendientes
                        </p>
                        <small
                            *ngIf="finesStatus?.lastUpdated"
                            class="last-updated"
                        >
                            Verificado:
                            {{ formatDate(finesStatus.lastUpdated) }}
                        </small>
                    </div>
                </div>
            </div>

            <!-- Estadísticas Mejoradas -->
            <div *ngIf="processStatistics" class="card statistics-info">
                <div class="card-header">
                    <h3>
                        <i class="pi pi-chart-bar"></i>
                        Estadísticas de Procesos
                    </h3>
                </div>
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-value">
                            {{ processStatistics.totalProcesses || 0 }}
                        </div>
                        <div class="stat-label">Total Procesos</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">
                            {{ processStatistics.freeProcessLimit || 0 }}
                        </div>
                        <div class="stat-label">Límite Gratuito</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">
                            {{ processStatistics.remainingFree || 0 }}
                        </div>
                        <div class="stat-label">Restantes Gratis</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">
                            {{
                                formatCurrency(
                                    processStatistics.totalAmount || 0
                                )
                            }}
                        </div>
                        <div class="stat-label">Monto Total</div>
                    </div>
                    <div
                        class="stat-item full-width"
                        *ngIf="processStatistics.limitConfig"
                    >
                        <div class="config-info">
                            <p-tag
                                [value]="processStatistics.limitConfig"
                                severity="info"
                            ></p-tag>
                            <span class="config-label"
                                >Configuración de límite aplicada</span
                            >
                        </div>
                    </div>
                </div>
            </div>

            <!-- Facturas Recientes -->
            <div *ngIf="recentInvoices?.length > 0" class="card invoices-info">
                <div class="card-header">
                    <h3>
                        <i class="pi pi-file-o"></i>
                        Facturas Recientes
                    </h3>
                </div>
                <div class="content">
                    <p-table
                        [value]="recentInvoices"
                        [paginator]="false"
                        styleClass="p-datatable-sm"
                    >
                        <ng-template pTemplate="header">
                            <tr>
                                <th>Número</th>
                                <th>Fecha</th>
                                <th>Monto</th>
                                <th>Estado</th>
                                <th>Acciones</th>
                            </tr>
                        </ng-template>
                        <ng-template pTemplate="body" let-invoice>
                            <tr>
                                <td>{{ invoice.invoiceNumber }}</td>
                                <td>{{ formatDate(invoice.issueDate) }}</td>
                                <td>
                                    {{ formatCurrency(invoice.totalAmount) }}
                                </td>
                                <td>
                                    <p-tag
                                        [value]="invoice.status"
                                        [severity]="
                                            getStatusSeverity(invoice.status)
                                        "
                                    >
                                    </p-tag>
                                </td>
                                <td>
                                    <button
                                        pButton
                                        type="button"
                                        icon="pi pi-eye"
                                        class="p-button-text p-button-sm"
                                        (click)="viewInvoice(invoice._id)"
                                        pTooltip="Ver factura"
                                    ></button>
                                </td>
                            </tr>
                        </ng-template>
                    </p-table>
                </div>
            </div>

            <!-- Alertas y Advertencias -->
            <div *ngIf="warnings?.length > 0" class="card warnings-info">
                <div class="card-header">
                    <h3>
                        <i class="pi pi-exclamation-triangle"></i>
                        Alertas
                    </h3>
                </div>
                <div class="content">
                    <div *ngFor="let warning of warnings" class="warning-item">
                        <i
                            [class]="
                                'pi ' +
                                (warning.severity === 'error'
                                    ? 'pi-times-circle text-red-500'
                                    : 'pi-exclamation-triangle text-yellow-500')
                            "
                        ></i>
                        <div class="warning-content">
                            <strong>{{ warning.title }}</strong>
                            <p>{{ warning.message }}</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Notas -->
            <div *ngIf="introducer.notes" class="card notes-info">
                <div class="card-header">
                    <h3>
                        <i class="pi pi-file-edit"></i>
                        Notas
                    </h3>
                </div>
                <div class="content">
                    <p>{{ introducer.notes }}</p>
                </div>
            </div>
        </div>

        <!-- Acciones Adicionales -->
        <div class="actions-section">
            <div class="actions-header">
                <h3>Acciones Administrativas</h3>
            </div>
            <div class="actions-buttons">
                <button
                    *ngIf="introducer.registrationStatus !== 'ACTIVE'"
                    pButton
                    type="button"
                    label="Activar Introductor"
                    icon="pi pi-check"
                    class="p-button-success"
                    (click)="activateIntroducer()"
                ></button>
                <button
                    *ngIf="introducer.registrationStatus === 'ACTIVE'"
                    pButton
                    type="button"
                    label="Suspender Introductor"
                    icon="pi pi-ban"
                    class="p-button-danger"
                    (click)="suspendIntroducer()"
                ></button>
            </div>
        </div>
    </div>
</div>

<!-- Toast y Confirmación -->
<p-toast></p-toast>
<p-confirmDialog></p-confirmDialog>
