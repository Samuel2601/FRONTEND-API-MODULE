<div class="introducer-form-container">
    <div class="card">
        <h2>{{ isEditMode ? "Editar" : "Nuevo" }} Introductor</h2>

        <p-progressBar
            *ngIf="loading"
            mode="indeterminate"
            [style]="{ height: '6px' }"
        ></p-progressBar>

        <form [formGroup]="form" (ngSubmit)="onSubmit()" *ngIf="!loading">
            <!-- Tipo de Persona -->
            <div class="field">
                <label for="personType" class="required">Tipo de Persona</label>
                <p-selectButton
                    formControlName="personType"
                    [options]="typeOptions"
                    [disabled]="isEditMode"
                >
                </p-selectButton>
            </div>

            <div class="grid">
                <!-- Campos para Persona Natural -->
                <ng-container *ngIf="isNaturalPerson">
                    <div class="col-12 md:col-6">
                        <div class="field">
                            <label for="name" class="required">
                                Nombres
                                <small
                                    *ngIf="nameFromConsult"
                                    style="color: #007ad9; font-weight: normal"
                                >
                                    (Obtenido automáticamente)
                                </small>
                            </label>
                            <div class="p-inputgroup w-full">
                                <span
                                    class="p-input-icon-right"
                                    style="flex: 1"
                                >
                                    <i
                                        class="pi pi-spin pi-spinner"
                                        *ngIf="consultingDocument"
                                        style="color: #007ad9"
                                    ></i>
                                    <input
                                        pInputText
                                        id="name"
                                        formControlName="name"
                                        class="w-full"
                                        [class.p-invalid]="
                                            form.get('name')?.invalid &&
                                            form.get('name')?.touched
                                        "
                                        [readonly]="nameFromConsult"
                                        [placeholder]="
                                            nameFromConsult
                                                ? ''
                                                : 'Se completará automáticamente'
                                        "
                                    />
                                </span>
                                <button
                                    *ngIf="nameFromConsult"
                                    pButton
                                    type="button"
                                    icon="pi pi-pencil"
                                    class="p-button-text p-button-sm"
                                    (click)="editarNombreManual()"
                                    pTooltip="Editar manualmente"
                                    tooltipPosition="top"
                                ></button>
                            </div>
                            <small
                                class="p-error"
                                *ngIf="getFieldError('name')"
                            >
                                {{ getFieldError("name") }}
                            </small>
                        </div>
                    </div>

                    <div class="col-12 md:col-6">
                        <div class="field">
                            <label for="idNumber" class="required">
                                Cédula / RUC
                                <small style="font-weight: normal">
                                    (10 dígitos: cédula, 13 dígitos: RUC)
                                </small>
                            </label>
                            <span class="p-input-icon-right w-full">
                                <i
                                    class="pi pi-spin pi-spinner"
                                    *ngIf="consultingDocument"
                                    style="color: #007ad9"
                                ></i>
                                <input
                                    pInputText
                                    id="idNumber"
                                    formControlName="idNumber"
                                    class="w-full"
                                    placeholder="Ej: 1712345678 o 1712345678001"
                                    [class.p-invalid]="
                                        form.get('idNumber')?.invalid &&
                                        form.get('idNumber')?.touched
                                    "
                                />
                            </span>
                            <small
                                class="p-error"
                                *ngIf="getFieldError('idNumber')"
                            >
                                {{ getFieldError("idNumber") }}
                            </small>
                            <small
                                class="p-info"
                                *ngIf="
                                    !getFieldError('idNumber') &&
                                    form.get('idNumber')?.value?.length >= 10
                                "
                                style="
                                    color: #007ad9;
                                    display: block;
                                    margin-top: 4px;
                                "
                            >
                                {{
                                    form.get("idNumber")?.value?.length === 10
                                        ? "Consultando cédula..."
                                        : "Consultando RUC..."
                                }}
                            </small>
                        </div>
                    </div>
                </ng-container>

                <!-- Campos para Persona Jurídica -->
                <ng-container *ngIf="!isNaturalPerson">
                    <div class="col-12">
                        <div class="field">
                            <label for="companyName" class="required"
                                >Razón Social</label
                            >
                            <input
                                pInputText
                                id="companyName"
                                formControlName="companyName"
                                class="w-full"
                                [class.p-invalid]="
                                    form.get('companyName')?.invalid &&
                                    form.get('companyName')?.touched
                                "
                            />
                            <small
                                class="p-error"
                                *ngIf="getFieldError('companyName')"
                            >
                                {{ getFieldError("companyName") }}
                            </small>
                        </div>
                    </div>

                    <div class="col-12 md:col-6">
                        <div class="field">
                            <label for="ruc" class="required">RUC</label>
                            <input
                                pInputText
                                id="ruc"
                                formControlName="ruc"
                                class="w-full"
                                placeholder="Ej: 1712345678001"
                                [class.p-invalid]="
                                    form.get('ruc')?.invalid &&
                                    form.get('ruc')?.touched
                                "
                            />
                            <small class="p-error" *ngIf="getFieldError('ruc')">
                                {{ getFieldError("ruc") }}
                            </small>
                        </div>
                    </div>

                    <div class="col-12 md:col-6">
                        <div class="field">
                            <label for="idNumber" class="required"
                                >Cédula Representante</label
                            >
                            <span class="p-input-icon-right w-full">
                                <i
                                    class="pi pi-spin pi-spinner"
                                    *ngIf="consultingDocument"
                                    style="color: #007ad9"
                                ></i>
                                <input
                                    pInputText
                                    id="idNumber"
                                    formControlName="idNumber"
                                    class="w-full"
                                    placeholder="Ej: 1712345678"
                                    [class.p-invalid]="
                                        form.get('idNumber')?.invalid &&
                                        form.get('idNumber')?.touched
                                    "
                                />
                            </span>
                            <small
                                class="p-error"
                                *ngIf="getFieldError('idNumber')"
                            >
                                {{ getFieldError("idNumber") }}
                            </small>
                        </div>
                    </div>

                    <div class="col-12">
                        <div class="field">
                            <label for="legalRepresentative" class="required">
                                Representante Legal
                                <small
                                    *ngIf="nameFromConsult"
                                    style="color: #007ad9; font-weight: normal"
                                >
                                    (Obtenido automáticamente)
                                </small>
                            </label>
                            <div class="p-inputgroup w-full">
                                <span
                                    class="p-input-icon-right"
                                    style="flex: 1"
                                >
                                    <i
                                        class="pi pi-spin pi-spinner"
                                        *ngIf="consultingDocument"
                                        style="color: #007ad9"
                                    ></i>
                                    <input
                                        pInputText
                                        id="legalRepresentative"
                                        formControlName="name"
                                        class="w-full"
                                        [class.p-invalid]="
                                            form.get('name')?.invalid &&
                                            form.get('name')?.touched
                                        "
                                        [readonly]="nameFromConsult"
                                        [placeholder]="
                                            nameFromConsult
                                                ? ''
                                                : 'Se completará automáticamente'
                                        "
                                    />
                                </span>
                                <button
                                    *ngIf="nameFromConsult"
                                    pButton
                                    type="button"
                                    icon="pi pi-pencil"
                                    class="p-button-text p-button-sm"
                                    (click)="editarNombreManual()"
                                    pTooltip="Editar manualmente"
                                    tooltipPosition="top"
                                ></button>
                            </div>
                            <small
                                class="p-error"
                                *ngIf="getFieldError('name')"
                            >
                                {{ getFieldError("name") }}
                            </small>
                        </div>
                    </div>
                </ng-container>

                <!-- Tipo de Introductor -->
                <div class="col-12">
                    <div class="field">
                        <label for="cattleTypes" class="required"
                            >Tipo de Introductor</label
                        >
                        <p-multiSelect
                            formControlName="cattleTypes"
                            [options]="introducerTypeOptions"
                            optionLabel="label"
                            optionValue="value"
                            [placeholder]="'Seleccione tipos de ganado'"
                        >
                        </p-multiSelect>
                        <small
                            class="p-error"
                            *ngIf="getFieldError('cattleTypes')"
                        >
                            {{ getFieldError("cattleTypes") }}
                        </small>
                    </div>
                </div>

                <!-- Información de Contacto -->
                <div class="col-12">
                    <h3>Información de Contacto</h3>
                </div>

                <div class="col-12 md:col-6">
                    <div class="field">
                        <label for="phone">Teléfono</label>
                        <span class="p-input-icon-left w-full">
                            <i class="pi pi-phone"></i>
                            <input
                                pInputText
                                id="phone"
                                formControlName="phone"
                                class="w-full"
                                placeholder="Ej: 0991234567"
                                [class.p-invalid]="
                                    form.get('phone')?.invalid &&
                                    form.get('phone')?.touched
                                "
                            />
                        </span>
                        <small class="p-error" *ngIf="getFieldError('phone')">
                            {{ getFieldError("phone") }}
                        </small>
                    </div>
                </div>

                <div class="col-12 md:col-6">
                    <div class="field">
                        <label for="email">Email</label>
                        <span class="p-input-icon-left w-full">
                            <i class="pi pi-envelope"></i>
                            <input
                                pInputText
                                id="email"
                                formControlName="email"
                                class="w-full"
                                placeholder="correo@ejemplo.com"
                                [class.p-invalid]="
                                    form.get('email')?.invalid &&
                                    form.get('email')?.touched
                                "
                            />
                        </span>
                        <small class="p-error" *ngIf="getFieldError('email')">
                            {{ getFieldError("email") }}
                        </small>
                    </div>
                </div>

                <div class="col-12">
                    <div class="field">
                        <label for="address">Dirección</label>
                        <span class="p-input-icon-left w-full">
                            <i class="pi pi-map-marker"></i>
                            <input
                                pInputText
                                id="address"
                                formControlName="address"
                                class="w-full"
                            />
                        </span>
                    </div>
                </div>

                <!-- Notas -->
                <div class="col-12">
                    <div class="field">
                        <label for="notes">Notas</label>
                        <textarea
                            pInputTextarea
                            id="notes"
                            formControlName="notes"
                            rows="3"
                            class="w-full"
                        >
                        </textarea>
                    </div>
                </div>
            </div>

            <!-- Botones de acción -->
            <div class="form-actions">
                <button
                    pButton
                    type="button"
                    label="Cancelar"
                    class="p-button-text"
                    (click)="cancel()"
                ></button>
                <button
                    pButton
                    type="submit"
                    [label]="isEditMode ? 'Actualizar' : 'Guardar'"
                    class="p-button-success"
                    [loading]="submitting"
                    [disabled]="
                        form.invalid || submitting || consultingDocument
                    "
                ></button>
            </div>
        </form>
    </div>
</div>

<p-toast></p-toast>
