<div class="rbu-management-container">
    <div class="page-header">
        <h2 class="page-title">
            <i class="pi pi-dollar mr-2"></i>
            Gestión de RBU
        </h2>
        <p class="page-description">
            Administre la Remuneración Básica Unificada (RBU) que afecta el
            cálculo de tarifas
        </p>
    </div>

    <div class="content-grid">
        <!-- Información Actual -->
        <div class="current-info-card">
            <p-card header="RBU Actual">
                <div class="current-rbu-display">
                    <div class="rbu-value">
                        <span class="currency">$</span>
                        <span class="amount">{{ currentRBU }}</span>
                    </div>
                    <div class="rbu-details">
                        <p-chip
                            label="Activo"
                            icon="pi pi-check-circle"
                            styleClass="status-active"
                        >
                        </p-chip>
                        <small class="last-updated">
                            Última actualización:
                            {{
                                rbuHistory[0]?.date
                                    ? (rbuHistory[0]?.date
                                      | date : "dd/MM/yyyy")
                                    : "N/A"
                            }}
                        </small>
                    </div>
                </div>
            </p-card>
        </div>

        <!-- Formulario de Actualización -->
        <div class="update-form-card">
            <p-card header="Actualizar RBU">
                <form [formGroup]="rbuForm" (ngSubmit)="updateRBU()">
                    <!-- Valores Predefinidos -->
                    <div class="form-section">
                        <h4 class="section-title">Valores Sugeridos</h4>
                        <div class="predefined-options">
                            <p-selectButton
                                formControlName="predefinedValue"
                                [options]="predefinedValues"
                                optionLabel="label"
                                optionValue="value"
                                [multiple]="false"
                            >
                            </p-selectButton>
                        </div>
                    </div>

                    <!-- Nuevo Valor -->
                    <div class="form-section">
                        <div class="form-field">
                            <label for="newRBU" class="field-label">
                                Nuevo Valor RBU <span class="required">*</span>
                            </label>
                            <p-inputNumber
                                id="newRBU"
                                formControlName="newRBU"
                                mode="currency"
                                currency="USD"
                                locale="en-US"
                                [min]="100"
                                [max]="2000"
                                [step]="1"
                                placeholder="470.00"
                                [class.p-invalid]="isFieldInvalid('newRBU')"
                            >
                            </p-inputNumber>
                            <small
                                *ngIf="isFieldInvalid('newRBU')"
                                class="p-error"
                            >
                                {{ getFieldError("newRBU") }}
                            </small>
                        </div>

                        <!-- Indicador de Cambio -->
                        <div
                            *ngIf="rbuForm.get('newRBU')?.value !== currentRBU"
                            class="change-indicator"
                            [ngClass]="getChangeIndicator()"
                        >
                            <div class="change-info">
                                <i
                                    class="pi"
                                    [ngClass]="{
                                        'pi-arrow-up':
                                            getChangeIndicator() === 'increase',
                                        'pi-arrow-down':
                                            getChangeIndicator() === 'decrease',
                                        'pi-minus':
                                            getChangeIndicator() === 'same'
                                    }"
                                ></i>
                                <span class="change-text">
                                    {{
                                        calculatePercentageChange()
                                            | number : "1.1-1"
                                    }}%
                                </span>
                            </div>
                            <small class="impact-message">{{
                                getImpactMessage()
                            }}</small>
                        </div>
                    </div>

                    <!-- Motivo -->
                    <div class="form-section">
                        <div class="form-field">
                            <label for="reason" class="field-label">
                                Motivo del Cambio
                                <span class="required">*</span>
                            </label>
                            <textarea
                                id="reason"
                                pInputTextarea
                                formControlName="reason"
                                rows="3"
                                placeholder="Ej: Ajuste anual según inflación, actualización por disposición legal, etc."
                                [class.p-invalid]="isFieldInvalid('reason')"
                                [autoResize]="true"
                            >
                            </textarea>
                            <small
                                *ngIf="isFieldInvalid('reason')"
                                class="p-error"
                            >
                                {{ getFieldError("reason") }}
                            </small>
                        </div>
                    </div>

                    <!-- Fecha Efectiva -->
                    <div class="form-section">
                        <div class="form-field">
                            <label for="effectiveDate" class="field-label">
                                Fecha Efectiva <span class="required">*</span>
                            </label>
                            <p-calendar
                                id="effectiveDate"
                                formControlName="effectiveDate"
                                dateFormat="dd/mm/yy"
                                [showIcon]="true"
                                [class.p-invalid]="
                                    isFieldInvalid('effectiveDate')
                                "
                            >
                            </p-calendar>
                            <small
                                *ngIf="isFieldInvalid('effectiveDate')"
                                class="p-error"
                            >
                                {{ getFieldError("effectiveDate") }}
                            </small>
                        </div>
                    </div>

                    <!-- Acciones -->
                    <div class="form-actions">
                        <p-button
                            label="Limpiar"
                            icon="pi pi-refresh"
                            severity="secondary"
                            [text]="true"
                            (onClick)="resetForm()"
                            [disabled]="loading"
                        >
                        </p-button>
                        <p-button
                            label="Actualizar RBU"
                            icon="pi pi-check"
                            severity="primary"
                            type="submit"
                            [loading]="loading"
                            [disabled]="
                                !rbuForm.valid ||
                                rbuForm.get('newRBU')?.value === currentRBU
                            "
                        >
                        </p-button>
                    </div>
                </form>
            </p-card>
        </div>

        <!-- Historial -->
        <div class="history-card">
            <p-card>
                <ng-template pTemplate="header">
                    <div class="card-header-content">
                        <span class="card-title">Historial de Cambios</span>
                        <div class="header-actions">
                            <p-button
                                icon="pi pi-download"
                                severity="secondary"
                                [text]="true"
                                [rounded]="true"
                                (onClick)="exportHistory()"
                                pTooltip="Exportar historial"
                            >
                            </p-button>
                            <p-button
                                [icon]="
                                    showHistory
                                        ? 'pi pi-chevron-up'
                                        : 'pi pi-chevron-down'
                                "
                                severity="secondary"
                                [text]="true"
                                [rounded]="true"
                                (onClick)="toggleHistory()"
                                [pTooltip]="
                                    showHistory
                                        ? 'Ocultar historial'
                                        : 'Mostrar historial'
                                "
                            >
                            </p-button>
                        </div>
                    </div>
                </ng-template>

                <div *ngIf="showHistory" class="history-content">
                    <div *ngIf="rbuHistory.length === 0" class="empty-history">
                        <i class="pi pi-history"></i>
                        <p>No hay historial de cambios disponible</p>
                    </div>

                    <div *ngIf="rbuHistory.length > 0" class="history-timeline">
                        <div
                            *ngFor="let record of rbuHistory; let first = first"
                            class="timeline-item"
                            [class.current]="first"
                        >
                            <div class="timeline-marker">
                                <i class="pi pi-circle-fill"></i>
                            </div>
                            <div class="timeline-content">
                                <div class="timeline-header">
                                    <h5 class="timeline-title">
                                        ${{ record.oldValue }} → ${{
                                            record.newValue
                                        }}
                                    </h5>
                                    <span class="timeline-date">
                                        {{
                                            record.date
                                                | date : "dd/MM/yyyy HH:mm"
                                        }}
                                    </span>
                                </div>
                                <div class="timeline-details">
                                    <div class="detail-item">
                                        <span class="detail-label"
                                            >Cambio:</span
                                        >
                                        <span
                                            class="detail-value"
                                            [ngClass]="{
                                                positive:
                                                    record.newValue >
                                                    record.oldValue,
                                                negative:
                                                    record.newValue <
                                                    record.oldValue
                                            }"
                                        >
                                            {{
                                                ((record.newValue -
                                                    record.oldValue) /
                                                    record.oldValue) *
                                                    100 | number : "1.1-1"
                                            }}%
                                        </span>
                                    </div>
                                    <div class="detail-item">
                                        <span class="detail-label"
                                            >Configuraciones afectadas:</span
                                        >
                                        <span class="detail-value">{{
                                            record.updatedConfigs
                                        }}</span>
                                    </div>
                                    <div
                                        *ngIf="record.user"
                                        class="detail-item"
                                    >
                                        <span class="detail-label"
                                            >Usuario:</span
                                        >
                                        <span class="detail-value">{{
                                            record.user
                                        }}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </p-card>
        </div>
    </div>

    <!-- Toast Messages -->
    <p-toast position="top-right"></p-toast>

    <!-- Confirmation Dialog -->
    <p-confirmDialog [style]="{ width: '450px' }" [baseZIndex]="10000">
    </p-confirmDialog>
</div>
