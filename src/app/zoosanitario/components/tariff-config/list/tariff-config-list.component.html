<div class="tariff-config-container">
    <div class="card">
        <div class="card-header">
            <div class="flex justify-content-between align-items-center">
                <h2 class="card-title">
                    <i class="pi pi-calculator mr-2"></i>
                    Configuración de Tarifas
                </h2>
                <div class="header-actions">
                    <p-button
                        label="Inicializar Defecto"
                        icon="pi pi-cog"
                        severity="secondary"
                        size="small"
                        (onClick)="initializeDefaults()"
                        class="mr-2"
                    >
                    </p-button>
                    <p-button
                        label="Nueva Tarifa"
                        icon="pi pi-plus"
                        severity="primary"
                        size="small"
                        (onClick)="newTariff()"
                    >
                    </p-button>
                </div>
            </div>
            <div class="rbu-info mt-3">
                <p-chip
                    label="RBU Actual: ${{ currentRBU }}"
                    icon="pi pi-dollar"
                    styleClass="rbu-chip"
                >
                </p-chip>
            </div>
        </div>

        <div class="card-content">
            <p-table
                #dt
                [value]="tariffs"
                [loading]="loading"
                [paginator]="true"
                [rows]="10"
                [rowsPerPageOptions]="[5, 10, 20]"
                [globalFilterFields]="[
                    'name',
                    'type',
                    'category',
                    'calculationType'
                ]"
                [tableStyle]="{ 'min-width': '50rem' }"
                styleClass="p-datatable-gridlines"
            >
                <ng-template pTemplate="caption">
                    <div class="table-header">
                        <div
                            class="flex justify-content-between align-items-center"
                        >
                            <span class="text-xl font-semibold"
                                >Tarifas Configuradas</span
                            >
                            <div class="table-actions">
                                <span class="p-input-icon-left">
                                    <i class="pi pi-search"></i>
                                    <input
                                        pInputText
                                        type="text"
                                        placeholder="Buscar..."
                                        (input)="
                                            dt.filterGlobal(
                                                $any($event.target).value,
                                                'contains'
                                            )
                                        "
                                    />
                                </span>
                                <p-button
                                    icon="pi pi-filter-slash"
                                    severity="secondary"
                                    [text]="true"
                                    (onClick)="clear(dt)"
                                    pTooltip="Limpiar filtros"
                                >
                                </p-button>
                            </div>
                        </div>
                    </div>
                </ng-template>

                <ng-template pTemplate="header">
                    <tr>
                        <th pSortableColumn="name">
                            <div class="flex align-items-center">
                                Nombre
                                <p-sortIcon field="name"></p-sortIcon>
                            </div>
                        </th>
                        <th pSortableColumn="type">
                            <div class="flex align-items-center">
                                Tipo
                                <p-sortIcon field="type"></p-sortIcon>
                                <p-columnFilter
                                    type="text"
                                    field="type"
                                    display="menu"
                                    [showMatchModes]="false"
                                    [showOperator]="false"
                                    [showAddButton]="false"
                                >
                                    <ng-template
                                        pTemplate="filter"
                                        let-value
                                        let-filter="filterCallback"
                                    >
                                        <p-dropdown
                                            [ngModel]="value"
                                            [options]="typeOptions"
                                            placeholder="Todos"
                                            (ngModelChange)="filter($event)"
                                            [showClear]="true"
                                        >
                                        </p-dropdown>
                                    </ng-template>
                                </p-columnFilter>
                            </div>
                        </th>
                        <th pSortableColumn="category">
                            <div class="flex align-items-center">
                                Categoría
                                <p-sortIcon field="category"></p-sortIcon>
                                <p-columnFilter
                                    type="text"
                                    field="category"
                                    display="menu"
                                    [showMatchModes]="false"
                                    [showOperator]="false"
                                    [showAddButton]="false"
                                >
                                    <ng-template
                                        pTemplate="filter"
                                        let-value
                                        let-filter="filterCallback"
                                    >
                                        <p-dropdown
                                            [ngModel]="value"
                                            [options]="categoryOptions"
                                            placeholder="Todas"
                                            (ngModelChange)="filter($event)"
                                            [showClear]="true"
                                        >
                                        </p-dropdown>
                                    </ng-template>
                                </p-columnFilter>
                            </div>
                        </th>
                        <th pSortableColumn="calculationType">
                            <div class="flex align-items-center">
                                Tipo de Cálculo
                                <p-sortIcon
                                    field="calculationType"
                                ></p-sortIcon>
                            </div>
                        </th>
                        <th>Valor/Cálculo</th>
                        <th pSortableColumn="isActive">
                            <div class="flex align-items-center">
                                Estado
                                <p-sortIcon field="isActive"></p-sortIcon>
                            </div>
                        </th>
                        <th>Acciones</th>
                    </tr>
                </ng-template>

                <ng-template pTemplate="body" let-tariff>
                    <tr>
                        <td>
                            <div class="flex align-items-center">
                                <span class="font-semibold">{{
                                    tariff.name
                                }}</span>
                                <div *ngIf="tariff.description" class="ml-2">
                                    <i
                                        class="pi pi-info-circle text-primary cursor-pointer"
                                        pTooltip="{{ tariff.description }}"
                                        tooltipPosition="top"
                                    >
                                    </i>
                                </div>
                            </div>
                        </td>
                        <td>
                            <p-tag
                                [value]="getTypeLabel(tariff.type)"
                                [severity]="
                                    tariff.type.includes('FINE')
                                        ? 'danger'
                                        : tariff.type === 'INSCRIPTION'
                                        ? 'info'
                                        : tariff.type === 'SLAUGHTER_FEE'
                                        ? 'success'
                                        : 'secondary'
                                "
                            >
                            </p-tag>
                        </td>
                        <td>
                            <p-tag
                                [value]="getCategoryLabel(tariff.category)"
                                severity="secondary"
                            >
                            </p-tag>
                        </td>
                        <td>
                            <span class="text-sm">{{
                                getCalculationTypeLabel(tariff.calculationType)
                            }}</span>
                        </td>
                        <td>
                            <div class="calculation-display">
                                <span class="font-semibold text-primary">{{
                                    getCalculationDisplay(tariff)
                                }}</span>
                            </div>
                        </td>
                        <td>
                            <p-inputSwitch
                                [ngModel]="tariff.isActive"
                                (ngModelChange)="toggleStatus(tariff)"
                            >
                            </p-inputSwitch>
                        </td>
                        <td>
                            <div class="action-buttons">
                                <p-button
                                    icon="pi pi-pencil"
                                    severity="info"
                                    [text]="true"
                                    [rounded]="true"
                                    size="small"
                                    (onClick)="editTariff(tariff)"
                                    pTooltip="Editar"
                                >
                                </p-button>
                                <p-button
                                    icon="pi pi-trash"
                                    severity="danger"
                                    [text]="true"
                                    [rounded]="true"
                                    size="small"
                                    (onClick)="deleteTariff(tariff)"
                                    pTooltip="Eliminar"
                                >
                                </p-button>
                            </div>
                        </td>
                    </tr>
                </ng-template>

                <ng-template pTemplate="emptymessage">
                    <tr>
                        <td colspan="7" class="text-center p-4">
                            <div class="empty-state">
                                <i class="pi pi-calculator empty-icon"></i>
                                <p class="empty-text">
                                    No se encontraron tarifas configuradas
                                </p>
                                <p-button
                                    label="Crear Primera Tarifa"
                                    icon="pi pi-plus"
                                    severity="primary"
                                    (onClick)="newTariff()"
                                >
                                </p-button>
                            </div>
                        </td>
                    </tr>
                </ng-template>
            </p-table>
        </div>
    </div>

    <!-- Formulario Modal -->
    <p-dialog
        [header]="selectedTariff ? 'Editar Tarifa' : 'Nueva Tarifa'"
        [(visible)]="showForm"
        [modal]="true"
        [breakpoints]="{ '960px': '80vw', '640px': '90vw' }"
        [style]="{ width: '70vw', 'max-width': '900px' }"
        [draggable]="false"
        [resizable]="false"
    >
        <app-tariff-config-form
            [tariff]="selectedTariff"
            [currentRBU]="currentRBU"
            (saved)="onFormSaved()"
            (cancelled)="onFormCancelled()"
        >
        </app-tariff-config-form>
    </p-dialog>

    <!-- Toast Messages -->
    <p-toast position="top-right"></p-toast>

    <!-- Confirmation Dialog -->
    <p-confirmDialog></p-confirmDialog>
</div>
