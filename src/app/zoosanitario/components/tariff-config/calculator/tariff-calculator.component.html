<div class="calculator-container">
    <div class="calculator-header">
        <h2 class="calculator-title">
            <i class="pi pi-calculator mr-2"></i>
            Calculadora de Tarifas
        </h2>
        <div class="header-info">
            <p-chip
                label="RBU: ${{ currentRBU }}"
                icon="pi pi-dollar"
                styleClass="rbu-chip"
            ></p-chip>
        </div>
    </div>

    <form [formGroup]="calculatorForm">
        <div class="calculator-grid">
            <!-- Columna Izquierda: Formularios -->
            <div class="calculator-inputs">
                <!-- Faenamiento -->
                <p-card header="Faenamiento" styleClass="calculation-card">
                    <div formGroupName="slaughter" class="form-group">
                        <div class="input-row">
                            <div class="input-field">
                                <label>Especie</label>
                                <p-dropdown
                                    formControlName="species"
                                    [options]="speciesOptions"
                                    placeholder="Seleccionar"
                                >
                                </p-dropdown>
                            </div>
                            <div class="input-field">
                                <label>Tipo Introductor</label>
                                <p-dropdown
                                    formControlName="introducerType"
                                    [options]="introducerTypeOptions"
                                    placeholder="Seleccionar"
                                >
                                </p-dropdown>
                            </div>
                        </div>
                        <div class="input-row">
                            <div class="input-field">
                                <label>Cantidad</label>
                                <p-inputNumber
                                    formControlName="quantity"
                                    [min]="1"
                                    [showButtons]="true"
                                    buttonLayout="horizontal"
                                    spinnerMode="horizontal"
                                >
                                </p-inputNumber>
                            </div>
                            <div class="input-field">
                                <label>Peso (kg)</label>
                                <p-inputNumber
                                    formControlName="weight"
                                    [min]="1"
                                    [showButtons]="true"
                                    suffix=" kg"
                                >
                                </p-inputNumber>
                            </div>
                        </div>
                        <div class="card-actions">
                            <p-button
                                label="Calcular Faenamiento"
                                icon="pi pi-calculator"
                                (onClick)="calculateSlaughterFee()"
                                [loading]="loading"
                                size="small"
                            >
                            </p-button>
                        </div>
                    </div>
                </p-card>

                <!-- Servicios Adicionales -->
                <p-card
                    header="Servicios Adicionales"
                    styleClass="calculation-card"
                >
                    <div class="form-group">
                        <div class="checkbox-field">
                            <p-checkbox
                                formControlName="enableAdditionalServices"
                                [binary]="true"
                                (onChange)="onAdditionalServicesToggle()"
                            >
                            </p-checkbox>
                            <label>Incluir servicios adicionales</label>
                        </div>

                        <div
                            *ngIf="
                                calculatorForm.get('enableAdditionalServices')
                                    ?.value
                            "
                            class="services-selection"
                        >
                            <label>Servicios:</label>
                            <div class="services-list">
                                <div
                                    *ngFor="let service of additionalServices"
                                    class="service-item"
                                >
                                    <p-checkbox
                                        [value]="service.type"
                                        formControlName="selectedServices"
                                        (onChange)="onSelectedServicesChange()"
                                    >
                                    </p-checkbox>
                                    <span class="service-label"
                                        >{{ service.label }} ({{
                                            service.percentage
                                        }}%)</span
                                    >
                                </div>
                            </div>
                        </div>
                    </div>
                </p-card>

                <!-- Uso Prolongado -->
                <p-card header="Uso Prolongado" styleClass="calculation-card">
                    <div formGroupName="prolongedUse" class="form-group">
                        <div class="input-row">
                            <div class="input-field">
                                <label>Especie</label>
                                <p-dropdown
                                    formControlName="species"
                                    [options]="speciesOptions"
                                    placeholder="Seleccionar"
                                >
                                </p-dropdown>
                            </div>
                            <div class="input-field">
                                <label>Cantidad</label>
                                <p-inputNumber
                                    formControlName="quantity"
                                    [min]="1"
                                    [showButtons]="true"
                                >
                                </p-inputNumber>
                            </div>
                        </div>
                        <div class="input-row">
                            <div class="input-field">
                                <label>Fecha/Hora Llegada</label>
                                <p-calendar
                                    formControlName="arrivalTime"
                                    [showTime]="true"
                                    dateFormat="dd/mm/yy"
                                    hourFormat="24"
                                >
                                </p-calendar>
                            </div>
                            <div class="input-field">
                                <label>Fecha/Hora Faenamiento</label>
                                <p-calendar
                                    formControlName="slaughterTime"
                                    [showTime]="true"
                                    dateFormat="dd/mm/yy"
                                    hourFormat="24"
                                >
                                </p-calendar>
                            </div>
                        </div>
                        <div class="time-info">
                            <p-chip
                                [label]="'Horas: ' + getHoursDifference()"
                                [class]="
                                    getHoursDifference() > 24
                                        ? 'warning-chip'
                                        : 'info-chip'
                                "
                            >
                            </p-chip>
                        </div>
                        <div class="card-actions">
                            <p-button
                                label="Calcular Uso Prolongado"
                                icon="pi pi-clock"
                                (onClick)="calculateProlongedUse()"
                                [loading]="loading"
                                size="small"
                            >
                            </p-button>
                        </div>
                    </div>
                </p-card>

                <!-- Inscripción -->
                <p-card header="Inscripción" styleClass="calculation-card">
                    <div formGroupName="inscription" class="form-group">
                        <div class="input-row">
                            <div class="input-field">
                                <label>Tipo Introductor</label>
                                <p-dropdown
                                    formControlName="introducerType"
                                    [options]="introducerTypeOptions"
                                    placeholder="Seleccionar"
                                >
                                </p-dropdown>
                            </div>
                            <div class="input-field">
                                <label>Año</label>
                                <p-inputNumber
                                    formControlName="year"
                                    [min]="2020"
                                    [max]="2030"
                                    [useGrouping]="false"
                                >
                                </p-inputNumber>
                            </div>
                        </div>
                        <div class="card-actions">
                            <p-button
                                label="Calcular Inscripción"
                                icon="pi pi-id-card"
                                (onClick)="calculateInscription()"
                                [loading]="loading"
                                size="small"
                            >
                            </p-button>
                        </div>
                    </div>
                </p-card>

                <!-- Multas -->
                <p-card header="Multas" styleClass="calculation-card">
                    <div formGroupName="fine" class="form-group">
                        <div class="input-row">
                            <div class="input-field">
                                <label>Tipo de Multa</label>
                                <p-dropdown
                                    formControlName="fineType"
                                    [options]="fineTypeOptions"
                                    placeholder="Seleccionar"
                                >
                                </p-dropdown>
                            </div>
                            <div class="input-field">
                                <label>Categoría</label>
                                <p-dropdown
                                    formControlName="category"
                                    [options]="categoryOptions"
                                    placeholder="Seleccionar"
                                >
                                </p-dropdown>
                            </div>
                        </div>
                        <div class="input-row">
                            <div class="input-field">
                                <label>Cantidad</label>
                                <p-inputNumber
                                    formControlName="quantity"
                                    [min]="1"
                                    [showButtons]="true"
                                >
                                </p-inputNumber>
                            </div>
                            <div class="input-field">
                                <label>Porcentaje (%)</label>
                                <p-inputNumber
                                    formControlName="percentage"
                                    [min]="0"
                                    [max]="100"
                                    suffix="%"
                                >
                                </p-inputNumber>
                            </div>
                        </div>
                        <div class="card-actions">
                            <p-button
                                label="Calcular Multa"
                                icon="pi pi-exclamation-triangle"
                                severity="warning"
                                (onClick)="calculateFine()"
                                [loading]="loading"
                                size="small"
                            >
                            </p-button>
                        </div>
                    </div>
                </p-card>

                <!-- Acciones Globales -->
                <div class="global-actions">
                    <p-button
                        label="Calcular Todo"
                        icon="pi pi-refresh"
                        severity="success"
                        (onClick)="calculateAll()"
                        [loading]="loading"
                        styleClass="w-full"
                    >
                    </p-button>
                    <p-button
                        label="Limpiar Todo"
                        icon="pi pi-trash"
                        severity="secondary"
                        [text]="true"
                        (onClick)="clearAll()"
                        styleClass="w-full"
                    >
                    </p-button>
                </div>
            </div>

            <!-- Columna Derecha: Resultados -->
            <div class="calculator-results">
                <p-card header="Resultados" styleClass="results-card">
                    <!-- Resumen Total -->
                    <div class="total-summary">
                        <div class="total-amount">
                            <span class="total-label">Total General:</span>
                            <span class="total-value"
                                >${{ totalAmount.toFixed(2) }}</span
                            >
                        </div>
                    </div>

                    <p-divider></p-divider>

                    <!-- Resultados Individuales -->
                    <div class="results-list">
                        <!-- Faenamiento -->
                        <div *ngIf="slaughterResult" class="result-item">
                            <div class="result-header">
                                <h4>Faenamiento</h4>
                                <span class="result-amount"
                                    >${{
                                        slaughterResult.amount.toFixed(2)
                                    }}</span
                                >
                            </div>
                            <div class="result-details">
                                <small *ngIf="slaughterResult.details.quantity">
                                    Cantidad:
                                    {{ slaughterResult.details.quantity }}
                                </small>
                                <small *ngIf="slaughterResult.details.weight">
                                    Peso:
                                    {{ slaughterResult.details.weight }} kg
                                </small>
                            </div>
                        </div>

                        <!-- Servicios Adicionales -->
                        <div
                            *ngIf="additionalServicesResult"
                            class="result-item"
                        >
                            <div class="result-header">
                                <h4>Servicios Adicionales</h4>
                                <span class="result-amount"
                                    >${{
                                        additionalServicesResult.amount.toFixed(
                                            2
                                        )
                                    }}</span
                                >
                            </div>
                            <div class="result-details">
                                <small
                                    *ngIf="
                                        additionalServicesResult.details
                                            .baseAmount
                                    "
                                >
                                    Base: ${{
                                        additionalServicesResult.details.baseAmount.toFixed(
                                            2
                                        )
                                    }}
                                </small>
                                <small
                                    *ngIf="
                                        additionalServicesResult.details
                                            .percentage
                                    "
                                >
                                    Porcentaje:
                                    {{
                                        additionalServicesResult.details
                                            .percentage
                                    }}%
                                </small>
                            </div>
                        </div>

                        <!-- Uso Prolongado -->
                        <div *ngIf="prolongedUseResult" class="result-item">
                            <div class="result-header">
                                <h4>Uso Prolongado</h4>
                                <span class="result-amount"
                                    >${{
                                        prolongedUseResult.amount.toFixed(2)
                                    }}</span
                                >
                            </div>
                            <div class="result-details">
                                <small *ngIf="prolongedUseResult.details.hours">
                                    Horas:
                                    {{ prolongedUseResult.details.hours }}
                                </small>
                                <small
                                    *ngIf="prolongedUseResult.details.quantity"
                                >
                                    Cantidad:
                                    {{ prolongedUseResult.details.quantity }}
                                </small>
                            </div>
                        </div>

                        <!-- Inscripción -->
                        <div *ngIf="inscriptionResult" class="result-item">
                            <div class="result-header">
                                <h4>Inscripción</h4>
                                <span class="result-amount"
                                    >${{
                                        inscriptionResult.amount.toFixed(2)
                                    }}</span
                                >
                            </div>
                            <div class="result-details">
                                <small
                                    *ngIf="inscriptionResult.details.rbuAmount"
                                >
                                    RBU: ${{
                                        inscriptionResult.details.rbuAmount.toFixed(
                                            2
                                        )
                                    }}
                                </small>
                                <small
                                    *ngIf="inscriptionResult.details.percentage"
                                >
                                    Porcentaje:
                                    {{ inscriptionResult.details.percentage }}%
                                </small>
                            </div>
                        </div>

                        <!-- Multa -->
                        <div *ngIf="fineResult" class="result-item warning">
                            <div class="result-header">
                                <h4>Multa</h4>
                                <span class="result-amount"
                                    >${{ fineResult.amount.toFixed(2) }}</span
                                >
                            </div>
                            <div class="result-details">
                                <small *ngIf="fineResult.details.quantity">
                                    Cantidad: {{ fineResult.details.quantity }}
                                </small>
                                <small *ngIf="fineResult.details.percentage">
                                    Porcentaje:
                                    {{ fineResult.details.percentage }}%
                                </small>
                            </div>
                        </div>

                        <!-- Estado vacío -->
                        <div
                            *ngIf="
                                !slaughterResult &&
                                !additionalServicesResult &&
                                !prolongedUseResult &&
                                !inscriptionResult &&
                                !fineResult
                            "
                            class="empty-results"
                        >
                            <i class="pi pi-calculator"></i>
                            <p>No hay cálculos realizados</p>
                            <small
                                >Complete los formularios y presione "Calcular"
                                para ver los resultados</small
                            >
                        </div>
                    </div>
                </p-card>
            </div>
        </div>
    </form>

    <!-- Toast Messages -->
    <p-toast position="top-right"></p-toast>
</div>
