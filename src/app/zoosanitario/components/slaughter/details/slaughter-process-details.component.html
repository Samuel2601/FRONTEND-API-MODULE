<!-- src/app/components/slaughter-process-details/slaughter-process-details.component.html -->
<div
    class="process-details-container"
    *ngIf="processData; else loadingTemplate"
>
    <!-- Información Principal -->
    <div class="process-header mb-4">
        <div class="flex justify-content-between align-items-start">
            <div class="process-title">
                <h2 class="text-2xl font-bold mb-2">
                    Proceso {{ processData.numeroOrden }}
                </h2>
                <div class="flex align-items-center gap-3">
                    <p-tag
                        [value]="processData.estado"
                        [severity]="getStateSeverity(processData.estado)"
                        [icon]="getStateIcon(processData.estado)"
                        styleClass="text-lg"
                    >
                    </p-tag>
                    <span class="text-600">
                        ID: {{ processData._id?.slice(-8) }}
                    </span>
                </div>
            </div>
            <div class="process-actions">
                <p-button
                    icon="pi pi-refresh"
                    severity="secondary"
                    (onClick)="refresh()"
                    [loading]="loading"
                    pTooltip="Actualizar datos"
                >
                </p-button>
            </div>
        </div>
    </div>

    <!-- Estadísticas Generales del Proceso -->
    <div class="grid mb-4" *ngIf="summaryData">
        <div class="col-12">
            <p-panel header="Estadísticas Generales">
                <div class="grid">
                    <div class="col-12 md:col-3">
                        <div class="stat-card text-center">
                            <div class="stat-icon">
                                <i
                                    class="pi pi-list text-4xl text-blue-500"
                                ></i>
                            </div>
                            <div class="stat-value">
                                {{
                                    summaryData.estadisticasGenerales
                                        .totalAnimales
                                }}
                            </div>
                            <div class="stat-label">Total Animales</div>
                        </div>
                    </div>
                    <div class="col-12 md:col-3">
                        <div class="stat-card text-center">
                            <div class="stat-icon">
                                <i
                                    class="pi pi-dollar text-4xl text-green-500"
                                ></i>
                            </div>
                            <div class="stat-value">
                                ${{
                                    summaryData.estadisticasGenerales
                                        .montoTotalFacturado | number : "1.2-2"
                                }}
                            </div>
                            <div class="stat-label">Total Facturado</div>
                        </div>
                    </div>
                    <div class="col-12 md:col-3">
                        <div class="stat-card text-center">
                            <div class="stat-icon">
                                <i
                                    class="pi pi-file text-4xl text-purple-500"
                                ></i>
                            </div>
                            <div class="stat-value">
                                {{
                                    summaryData.estadisticasGenerales
                                        .totalFacturas
                                }}
                            </div>
                            <div class="stat-label">Total Facturas</div>
                        </div>
                    </div>
                    <div class="col-12 md:col-3">
                        <div class="stat-card text-center">
                            <div class="stat-icon">
                                <i
                                    class="pi pi-check-circle text-4xl"
                                    [class]="
                                        summaryData.estadisticasGenerales
                                            .procesoCompleto
                                            ? 'text-green-500'
                                            : 'text-orange-500'
                                    "
                                ></i>
                            </div>
                            <div class="stat-value">
                                {{
                                    summaryData.estadisticasGenerales
                                        .procesoCompleto
                                        ? "SÍ"
                                        : "NO"
                                }}
                            </div>
                            <div class="stat-label">Proceso Completo</div>
                        </div>
                    </div>
                </div>
            </p-panel>
        </div>
    </div>

    <!-- Información General -->
    <div class="grid">
        <div class="col-12 lg:col-8">
            <!-- Datos del Proceso -->
            <p-panel header="Información del Proceso" styleClass="mb-4">
                <div class="grid">
                    <div class="col-12 md:col-6">
                        <div class="detail-group">
                            <div class="detail-item">
                                <label>Número de Orden:</label>
                                <span class="font-bold text-primary">
                                    {{ processData.numeroOrden }}
                                </span>
                            </div>
                            <div class="detail-item">
                                <label>Estado Actual:</label>
                                <p-tag
                                    [value]="processData.estado"
                                    [severity]="
                                        getStateSeverity(processData.estado)
                                    "
                                    [icon]="getStateIcon(processData.estado)"
                                >
                                </p-tag>
                            </div>
                            <div class="detail-item">
                                <label>Fecha de Creación:</label>
                                <span>
                                    {{
                                        processData.createdAt
                                            | date : "dd/MM/yyyy HH:mm"
                                    }}
                                </span>
                            </div>
                            <div class="detail-item" *ngIf="summaryData">
                                <label>Tiempo Transcurrido:</label>
                                <span>{{ tiempoTranscurridoText }}</span>
                            </div>
                        </div>
                    </div>
                    <div class="col-12 md:col-6">
                        <div class="detail-group">
                            <div class="detail-item">
                                <label>Creado por:</label>
                                <span>{{
                                    processData.createdBy?.name +
                                        " " +
                                        processData.createdBy?.last_name ||
                                        "No disponible"
                                }}</span>
                            </div>
                            <div
                                class="detail-item"
                                *ngIf="processData.updatedAt"
                            >
                                <label>Última Actualización:</label>
                                <span>
                                    {{
                                        processData.updatedAt
                                            | date : "dd/MM/yyyy HH:mm"
                                    }}
                                </span>
                            </div>
                            <div
                                class="detail-item"
                                *ngIf="processData.updatedBy"
                            >
                                <label>Actualizado por:</label>
                                <span>{{
                                    processData.updatedBy?.name +
                                        " " +
                                        processData.updatedBy?.last_name ||
                                        "No disponible"
                                }}</span>
                            </div>
                            <div
                                class="detail-item"
                                *ngIf="
                                    summaryData &&
                                    summaryData.tiempos.tiempoDesdeRecepcion
                                "
                            >
                                <label>Desde Recepción:</label>
                                <span>{{ tiempoDesdeRecepcionText }}</span>
                            </div>
                        </div>
                    </div>
                </div>
            </p-panel>

            <!-- Información del Introductor -->
            <p-panel header="Introductor" styleClass="mb-4">
                <div
                    class="introducer-card"
                    *ngIf="introducerData || summaryData?.introductor"
                >
                    <div class="flex justify-content-between align-items-start">
                        <div class="introducer-info flex-1">
                            <div class="grid">
                                <div class="col-12 md:col-6">
                                    <div class="detail-group">
                                        <div class="detail-item">
                                            <label>Nombre:</label>
                                            <span class="font-bold">
                                                {{
                                                    introducerData?.name ||
                                                        summaryData?.introductor
                                                            ?.nombre
                                                }}
                                            </span>
                                        </div>
                                        <div class="detail-item">
                                            <label>Tipo de Persona:</label>
                                            <p-tag
                                                [value]="
                                                    introducerData?.personType ||
                                                    summaryData?.introductor
                                                        ?.tipo
                                                "
                                                [severity]="
                                                    (introducerData?.personType ||
                                                        summaryData?.introductor
                                                            ?.tipo) ===
                                                    'Natural'
                                                        ? 'info'
                                                        : 'warning'
                                                "
                                            >
                                            </p-tag>
                                        </div>
                                        <div class="detail-item">
                                            <label>Documento:</label>
                                            <span>
                                                {{
                                                    introducerData?.idNumber ||
                                                        summaryData?.introductor
                                                            ?.idNumber ||
                                                        introducerData?.ruc ||
                                                        summaryData?.introductor
                                                            ?.ruc ||
                                                        "N/A"
                                                }}
                                            </span>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-12 md:col-6">
                                    <div class="detail-group">
                                        <div
                                            class="detail-item"
                                            *ngIf="
                                                introducerData?.email ||
                                                summaryData?.introductor?.email
                                            "
                                        >
                                            <label>Email:</label>
                                            <span>{{
                                                introducerData?.email ||
                                                    summaryData?.introductor
                                                        ?.email
                                            }}</span>
                                        </div>
                                        <div
                                            class="detail-item"
                                            *ngIf="
                                                introducerData?.phone ||
                                                summaryData?.introductor
                                                    ?.telefono
                                            "
                                        >
                                            <label>Teléfono:</label>
                                            <span>{{
                                                introducerData?.phone ||
                                                    summaryData?.introductor
                                                        ?.telefono
                                            }}</span>
                                        </div>
                                        <div
                                            class="detail-item"
                                            *ngIf="
                                                introducerData?.address ||
                                                summaryData?.introductor
                                                    ?.direccion
                                            "
                                        >
                                            <label>Dirección:</label>
                                            <span>{{
                                                introducerData?.address ||
                                                    summaryData?.introductor
                                                        ?.direccion
                                            }}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="introducer-actions">
                            <p-button
                                icon="pi pi-eye"
                                severity="info"
                                [text]="true"
                                pTooltip="Ver perfil completo"
                                (onClick)="viewIntroducerProfile()"
                            >
                            </p-button>
                        </div>
                    </div>
                </div>
                <div
                    *ngIf="!introducerData && !summaryData?.introductor"
                    class="text-center p-4 text-600"
                >
                    <i class="pi pi-user text-3xl mb-2 block"></i>
                    <p>Información del introductor no disponible</p>
                </div>
            </p-panel>

            <!-- Información de Recepción Detallada -->
            <p-panel header="Recepción" styleClass="mb-4">
                <div
                    class="reception-card"
                    *ngIf="receptionData || summaryData?.recepcion"
                >
                    <div class="grid">
                        <div class="col-12 md:col-6">
                            <div class="detail-group">
                                <div class="detail-item">
                                    <label>Fecha y Hora:</label>
                                    <span>
                                        {{
                                            receptionData?.fechaHoraRecepcion ||
                                                summaryData?.recepcion?.fecha
                                                | date : "dd/MM/yyyy HH:mm"
                                        }}
                                    </span>
                                </div>
                                <div class="detail-item">
                                    <label>Estado:</label>
                                    <p-tag
                                        [value]="
                                            receptionData?.estado ||
                                            summaryData?.recepcion?.estado
                                        "
                                        [severity]="
                                            getReceptionStateSeverity(
                                                receptionData?.estado ||
                                                    summaryData?.recepcion
                                                        ?.estado
                                            )
                                        "
                                    >
                                    </p-tag>
                                </div>
                                <div class="detail-item">
                                    <label>Prioridad:</label>
                                    <p-rating
                                        [ngModel]="
                                            receptionData?.prioridad ||
                                            summaryData?.recepcion?.prioridad
                                        "
                                        [readonly]="true"
                                        [stars]="5"
                                        [cancel]="false"
                                    >
                                    </p-rating>
                                </div>
                            </div>
                        </div>
                        <div class="col-12 md:col-6">
                            <div
                                class="detail-group"
                                *ngIf="
                                    receptionData?.animalHealthCertificate ||
                                    summaryData?.recepcion?.certificadoSanitario
                                "
                            >
                                <div class="detail-item">
                                    <label>Certificado CZPM:</label>
                                    <span class="font-bold">
                                        {{
                                            receptionData
                                                ?.animalHealthCertificate
                                                ?.numeroCZPM ||
                                                summaryData?.recepcion
                                                    ?.certificadoSanitario
                                                    ?.numero
                                        }}
                                    </span>
                                </div>
                                <div class="detail-item">
                                    <label>Total Productos:</label>
                                    <span>{{
                                        receptionData?.animalHealthCertificate
                                            ?.totalProductos ||
                                            summaryData?.recepcion
                                                ?.certificadoSanitario
                                                ?.totalProductos
                                    }}</span>
                                </div>
                                <div
                                    class="detail-item"
                                    *ngIf="
                                        receptionData?.animalHealthCertificate
                                            ?.autorizadoA ||
                                        summaryData?.recepcion
                                            ?.certificadoSanitario?.autorizadoA
                                    "
                                >
                                    <label>Autorizado A:</label>
                                    <span>{{
                                        receptionData?.animalHealthCertificate
                                            ?.autorizadoA ||
                                            summaryData?.recepcion
                                                ?.certificadoSanitario
                                                ?.autorizadoA
                                    }}</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Información de Transporte -->
                    <div
                        class="mt-4"
                        *ngIf="summaryData?.recepcion?.transporte"
                    >
                        <h6 class="text-primary mb-3">
                            Condiciones de Transporte
                        </h6>
                        <div class="grid">
                            <div class="col-12 md:col-4">
                                <div class="detail-group">
                                    <div class="detail-item">
                                        <label>Temperatura:</label>
                                        <span
                                            >{{
                                                summaryData.recepcion.transporte
                                                    .temperatura
                                            }}°C</span
                                        >
                                    </div>
                                    <div class="detail-item">
                                        <label>Humedad:</label>
                                        <span
                                            >{{
                                                summaryData.recepcion.transporte
                                                    .humedadAmbiental
                                            }}%</span
                                        >
                                    </div>
                                </div>
                            </div>
                            <div class="col-12 md:col-4">
                                <div class="detail-group">
                                    <div class="detail-item">
                                        <label>Condiciones Higiénicas:</label>
                                        <span>{{
                                            summaryData.recepcion.transporte
                                                .condicionesHigienicas
                                        }}</span>
                                    </div>
                                    <div
                                        class="detail-item"
                                        *ngIf="
                                            summaryData.recepcion.transporte
                                                .fotografias > 0
                                        "
                                    >
                                        <label>Fotografías:</label>
                                        <span>{{
                                            summaryData.recepcion.transporte
                                                .fotografias
                                        }}</span>
                                    </div>
                                </div>
                            </div>
                            <div class="col-12 md:col-4">
                                <div class="detail-group">
                                    <div
                                        class="detail-item"
                                        *ngIf="
                                            summaryData.recepcion.transporte
                                                .condicionAnimales
                                        "
                                    >
                                        <label>Condición Animales:</label>
                                        <span>{{
                                            summaryData.recepcion.transporte
                                                .condicionAnimales
                                        }}</span>
                                    </div>
                                    <div
                                        class="detail-item"
                                        *ngIf="
                                            summaryData.recepcion.transporte
                                                .fechaInspeccion
                                        "
                                    >
                                        <label>Fecha Inspección:</label>
                                        <span>{{
                                            summaryData.recepcion.transporte
                                                .fechaInspeccion
                                                | date : "dd/MM/yyyy HH:mm"
                                        }}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="mt-3">
                        <p-button
                            label="Ver Detalles de Recepción"
                            icon="pi pi-external-link"
                            severity="info"
                            [outlined]="true"
                            size="small"
                            (onClick)="viewReceptionDetails()"
                        >
                        </p-button>
                    </div>
                </div>
                <div
                    *ngIf="!receptionData && !summaryData?.recepcion"
                    class="text-center p-4 text-600"
                >
                    <i class="pi pi-inbox text-3xl mb-2 block"></i>
                    <p>No hay recepción asociada</p>
                </div>
            </p-panel>

            <!-- Resumen de Facturación Detallado -->
            <p-panel
                header="Facturación Detallada"
                styleClass="mb-4"
                *ngIf="summaryData"
            >
                <div class="invoice-summary">
                    <!-- Estados de Facturas -->
                    <div class="stat-section mb-3">
                        <h6 class="text-primary mb-2">Estados de Facturas</h6>
                        <div class="invoice-states">
                            <div class="invoice-state-item">
                                <span class="state-label">Pagadas:</span>
                                <p-tag
                                    [value]="
                                        summaryData.facturacion.porEstado.pagadas.toString()
                                    "
                                    severity="success"
                                    class="ml-2"
                                ></p-tag>
                            </div>
                            <div class="invoice-state-item">
                                <span class="state-label">Emitidas:</span>
                                <p-tag
                                    [value]="
                                        summaryData.facturacion.porEstado.emitidas.toString()
                                    "
                                    severity="warning"
                                    class="ml-2"
                                ></p-tag>
                            </div>
                            <div class="invoice-state-item">
                                <span class="state-label">Canceladas:</span>
                                <p-tag
                                    [value]="
                                        summaryData.facturacion.porEstado.canceladas.toString()
                                    "
                                    severity="danger"
                                    class="ml-2"
                                ></p-tag>
                            </div>
                            <div class="invoice-state-item">
                                <span class="state-label">Pendientes:</span>
                                <p-tag
                                    [value]="
                                        summaryData.facturacion.porEstado.pendientes.toString()
                                    "
                                    severity="info"
                                    class="ml-2"
                                ></p-tag>
                            </div>
                        </div>
                    </div>

                    <!-- Montos -->
                    <div class="stat-section mb-3">
                        <h6 class="text-primary mb-2">Montos</h6>
                        <div class="money-stats">
                            <div class="money-item">
                                <label>Total Pagado:</label>
                                <span class="font-bold text-green-600"
                                    >${{
                                        summaryData.facturacion.montos
                                            .totalPagado | number : "1.2-2"
                                    }}</span
                                >
                            </div>
                            <div class="money-item">
                                <label>Total Emitido:</label>
                                <span class="font-bold text-orange-600"
                                    >${{
                                        summaryData.facturacion.montos
                                            .totalEmitido | number : "1.2-2"
                                    }}</span
                                >
                            </div>
                            <div class="money-item">
                                <label>Total General:</label>
                                <span class="font-bold text-primary"
                                    >${{
                                        summaryData.facturacion.montos
                                            .totalGeneral | number : "1.2-2"
                                    }}</span
                                >
                            </div>
                            <div
                                class="money-item"
                                *ngIf="
                                    summaryData.facturacion.montos
                                        .promedioFactura > 0
                                "
                            >
                                <label>Promedio:</label>
                                <span class="font-bold"
                                    >${{
                                        summaryData.facturacion.montos
                                            .promedioFactura | number : "1.2-2"
                                    }}</span
                                >
                            </div>
                        </div>
                    </div>

                    <!-- Fechas Importantes -->
                    <div
                        class="stat-section mb-3"
                        *ngIf="summaryData.facturacion.fechas.primeraEmision"
                    >
                        <h6 class="text-primary mb-2">Fechas Importantes</h6>
                        <div class="date-stats">
                            <div class="date-item">
                                <label>Primera Emisión:</label>
                                <span>{{
                                    summaryData.facturacion.fechas
                                        .primeraEmision | date : "dd/MM/yyyy"
                                }}</span>
                            </div>
                            <div
                                class="date-item"
                                *ngIf="
                                    summaryData.facturacion.fechas.ultimaEmision
                                "
                            >
                                <label>Última Emisión:</label>
                                <span>{{
                                    summaryData.facturacion.fechas.ultimaEmision
                                        | date : "dd/MM/yyyy"
                                }}</span>
                            </div>
                            <div
                                class="date-item"
                                *ngIf="
                                    summaryData.facturacion.fechas
                                        .proximoVencimiento
                                "
                            >
                                <label>Próximo Vencimiento:</label>
                                <span class="font-bold text-orange-600">{{
                                    proximoVencimientoText
                                }}</span>
                            </div>
                        </div>
                    </div>

                    <!-- Gráfico de Facturación -->
                    <div
                        class="chart-section mt-4"
                        *ngIf="
                            invoiceChartData.labels &&
                            summaryData.facturacion.total > 0
                        "
                    >
                        <h6 class="text-primary mb-2">
                            Distribución por Estado
                        </h6>
                        <p-chart
                            type="doughnut"
                            [data]="invoiceChartData"
                            [options]="invoiceChartOptions"
                            width="250"
                            height="250"
                        ></p-chart>
                    </div>
                </div>
            </p-panel>
        </div>

        <div class="col-12 lg:col-4">
            <!-- Acciones Rápidas -->
            <p-panel header="Acciones" styleClass="mb-4">
                <div class="quick-actions">
                    <p-splitButton
                        label="Cambiar Estado"
                        icon="pi pi-cog"
                        [model]="stateActions"
                        severity="info"
                        styleClass="w-full mb-2"
                        *ngIf="stateActions.length > 0"
                    >
                    </p-splitButton>

                    <p-button
                        label="Ver Historial"
                        icon="pi pi-history"
                        severity="secondary"
                        [outlined]="true"
                        styleClass="w-full mb-2"
                        (onClick)="viewAuditHistory()"
                    >
                    </p-button>

                    <p-button
                        label="Generar Reporte"
                        icon="pi pi-file-pdf"
                        severity="help"
                        [outlined]="true"
                        styleClass="w-full mb-2"
                        (onClick)="generateReport()"
                    >
                    </p-button>
                </div>
            </p-panel>
            <!-- Resumen de Inspecciones Detallado -->
            <p-panel
                header="Inspecciones Detalladas"
                styleClass="mb-4"
                *ngIf="summaryData"
            >
                <div class="inspection-summary">
                    <!-- Estadísticas por Resultado -->
                    <div class="stat-section mb-3">
                        <h6 class="text-primary mb-2">Por Resultado</h6>
                        <div class="result-stats">
                            <div class="result-item">
                                <span class="result-label">Pendientes:</span>
                                <p-tag
                                    [value]="
                                        summaryData.inspecciones.porResultado.pendientes.toString()
                                    "
                                    severity="warning"
                                    class="ml-2"
                                ></p-tag>
                            </div>
                            <div class="result-item">
                                <span class="result-label">Aptas:</span>
                                <p-tag
                                    [value]="
                                        summaryData.inspecciones.porResultado.aptas.toString()
                                    "
                                    severity="success"
                                    class="ml-2"
                                ></p-tag>
                            </div>
                            <div class="result-item">
                                <span class="result-label">Devolución:</span>
                                <p-tag
                                    [value]="
                                        summaryData.inspecciones.porResultado.devolucion.toString()
                                    "
                                    severity="danger"
                                    class="ml-2"
                                ></p-tag>
                            </div>
                            <div class="result-item">
                                <span class="result-label">Cuarentena:</span>
                                <p-tag
                                    [value]="
                                        summaryData.inspecciones.porResultado.cuarentena.toString()
                                    "
                                    severity="info"
                                    class="ml-2"
                                ></p-tag>
                            </div>
                            <div class="result-item">
                                <span class="result-label">Comisión:</span>
                                <p-tag
                                    [value]="
                                        summaryData.inspecciones.porResultado.comision.toString()
                                    "
                                    severity="info"
                                    class="ml-2"
                                ></p-tag>
                            </div>
                        </div>
                    </div>

                    <!-- Estadísticas por Sexo -->
                    <div class="stat-section mb-3">
                        <h6 class="text-primary mb-2">Por Sexo</h6>
                        <div class="sex-stats">
                            <div class="sex-item">
                                <span class="sex-label">Machos:</span>
                                <span class="sex-value">{{
                                    summaryData.inspecciones.porSexo.macho || 0
                                }}</span>
                            </div>
                            <div class="sex-item">
                                <span class="sex-label">Hembras:</span>
                                <span class="sex-value">{{
                                    summaryData.inspecciones.porSexo.hembra || 0
                                }}</span>
                            </div>
                            <div class="sex-item">
                                <span class="sex-label">Pendientes:</span>
                                <span class="sex-value">{{
                                    summaryData.inspecciones.porSexo
                                        .pendiente || 0
                                }}</span>
                            </div>
                        </div>
                    </div>

                    <!-- Estadísticas de Peso y Edad -->
                    <div
                        class="stat-section mb-3"
                        *ngIf="
                            summaryData.inspecciones.estadisticas.pesoTotal > 0
                        "
                    >
                        <h6 class="text-primary mb-2">Estadísticas</h6>
                        <div class="stats-grid">
                            <div class="stat-item">
                                <label>Peso Promedio:</label>
                                <span class="font-bold"
                                    >{{
                                        summaryData.inspecciones.estadisticas
                                            .pesoPromedio
                                    }}
                                    kg</span
                                >
                            </div>
                            <div class="stat-item">
                                <label>Peso Total:</label>
                                <span class="font-bold"
                                    >{{
                                        summaryData.inspecciones.estadisticas
                                            .pesoTotal
                                    }}
                                    kg</span
                                >
                            </div>
                            <div class="stat-item">
                                <label>Edad Promedio:</label>
                                <span class="font-bold"
                                    >{{
                                        summaryData.inspecciones.estadisticas
                                            .edadPromedio
                                    }}
                                    años</span
                                >
                            </div>
                            <div class="stat-item">
                                <label>Rango Peso:</label>
                                <span
                                    >{{
                                        summaryData.inspecciones.estadisticas
                                            .pesoMinimo
                                    }}
                                    -
                                    {{
                                        summaryData.inspecciones.estadisticas
                                            .pesoMaximo
                                    }}
                                    kg</span
                                >
                            </div>
                        </div>
                    </div>

                    <!-- Especies -->
                    <div class="stat-section" *ngIf="especiesArray.length > 0">
                        <h6 class="text-primary mb-2">Por Especies</h6>
                        <div class="species-list">
                            <div
                                class="species-item"
                                *ngFor="let especie of especiesArray"
                            >
                                <span class="species-name"
                                    >{{ especie.nombre }}:</span
                                >
                                <p-tag
                                    [value]="especie.cantidad.toString()"
                                    severity="info"
                                    class="ml-2"
                                ></p-tag>
                            </div>
                        </div>
                    </div>

                    <!-- Gráfico de Inspecciones -->
                    <div
                        class="chart-section mt-4"
                        *ngIf="
                            inspectionChartData.labels &&
                            summaryData.inspecciones.total > 0
                        "
                    >
                        <h6 class="text-primary mb-2">
                            Distribución por Resultado
                        </h6>
                        <p-chart
                            type="doughnut"
                            [data]="inspectionChartData"
                            [options]="inspectionChartOptions"
                            width="250"
                            height="250"
                        ></p-chart>
                    </div>
                </div>
            </p-panel>

            <!-- Progreso del Proceso -->
            <p-panel header="Progreso" styleClass="mb-4">
                <div class="process-progress">
                    <div class="progress-steps">
                        <div
                            class="progress-step"
                            [class.active]="isStepActive('Iniciado')"
                            [class.completed]="isStepCompleted('Iniciado')"
                        >
                            <div class="step-circle">
                                <i class="pi pi-play"></i>
                            </div>
                            <div class="step-label">Iniciado</div>
                        </div>

                        <div
                            class="progress-step"
                            [class.active]="isStepActive('PreFaenamiento')"
                            [class.completed]="
                                isStepCompleted('PreFaenamiento')
                            "
                        >
                            <div class="step-circle">
                                <i class="pi pi-clock"></i>
                            </div>
                            <div class="step-label">Pre-Faenamiento</div>
                        </div>

                        <div
                            class="progress-step"
                            [class.active]="isStepActive('Pagado')"
                            [class.completed]="isStepCompleted('Pagado')"
                        >
                            <div class="step-circle">
                                <i class="pi pi-dollar"></i>
                            </div>
                            <div class="step-label">Pagado</div>
                        </div>

                        <div
                            class="progress-step"
                            [class.active]="isStepActive('EnProceso')"
                            [class.completed]="isStepCompleted('EnProceso')"
                        >
                            <div class="step-circle">
                                <i class="pi pi-cog"></i>
                            </div>
                            <div class="step-label">En Proceso</div>
                        </div>

                        <div
                            class="progress-step"
                            [class.active]="isStepActive('Finalizado')"
                            [class.completed]="isStepCompleted('Finalizado')"
                        >
                            <div class="step-circle">
                                <i class="pi pi-check"></i>
                            </div>
                            <div class="step-label">Finalizado</div>
                        </div>
                    </div>
                </div>
            </p-panel>
        </div>
    </div>

    <!-- Secciones Expandibles -->
    <div class="expandable-sections">
        <!-- Inspecciones Externas -->
        <p-accordion styleClass="mb-4">
            <p-accordionTab [selected]="true" [cache]="false">
                <ng-template pTemplate="header">
                    <div
                        class="flex align-items-center justify-content-between w-full mr-3"
                    >
                        <span class="font-semibold">Inspecciones Externas</span>
                        <div
                            class="p-button-outlined p-button-sm flex align-items-center"
                        >
                            <p-button
                                label="Todos"
                                class="p-button-outlined p-button-sm"
                                (click)="
                                    getExternalInspections(
                                        processData.numeroOrden
                                    )
                                "
                            >
                            </p-button>
                            <p-tag
                                [ngStyle]="{ 'margin-left': '0.5rem' }"
                                [value]="inspectionsData.length.toString()"
                                severity="info"
                            ></p-tag>
                        </div>
                    </div>
                </ng-template>

                <div
                    class="inspections-grid"
                    *ngIf="inspectionsData.length > 0; else noInspections"
                >
                    <div class="grid">
                        <div
                            class="col-12 md:col-6 lg:col-4"
                            *ngFor="let inspection of inspectionsData"
                        >
                            <p-card styleClass="inspection-summary-card">
                                <div
                                    class="flex justify-content-between align-items-start mb-3"
                                >
                                    <h5 class="m-0">{{ inspection.numero }}</h5>
                                    <p-tag
                                        [value]="
                                            inspection.examenAnteMortem
                                                .resultado !== 'Pendiente'
                                                ? inspection.examenAnteMortem
                                                      .resultado + '-EM'
                                                : inspection.inspeccionRecepcion
                                                      .resultado + '-RR'
                                        "
                                        [severity]="
                                            getInspectionResultSeverity(
                                                inspection.examenAnteMortem
                                                    .resultado !== 'Pendiente'
                                                    ? inspection
                                                          .examenAnteMortem
                                                          .resultado
                                                    : inspection
                                                          .inspeccionRecepcion
                                                          .resultado
                                            )
                                        "
                                    >
                                    </p-tag>
                                </div>
                                <div class="inspection-info">
                                    <div class="detail-item">
                                        <label>Especie:</label>
                                        <span>{{
                                            getSpeciesName(inspection.especie)
                                        }}</span>
                                    </div>
                                    <div
                                        class="detail-item"
                                        *ngIf="
                                            inspection.examenAnteMortem
                                                .resultado !== 'Pendiente'
                                                ? inspection.examenAnteMortem
                                                      .horaChequeo
                                                : inspection.inspeccionRecepcion
                                                      .horaChequeo
                                        "
                                    >
                                        <label>Fecha:</label>

                                        <span>
                                            {{
                                                inspection.examenAnteMortem
                                                    .resultado !== "Pendiente"
                                                    ? (inspection
                                                          .examenAnteMortem
                                                          .horaChequeo
                                                      | date
                                                          : "dd/MM/yyyy HH:mm")
                                                    : (inspection
                                                          .inspeccionRecepcion
                                                          .horaChequeo
                                                      | date
                                                          : "dd/MM/yyyy HH:mm")
                                            }}</span
                                        >
                                    </div>
                                </div>
                                <div class="mt-3">
                                    <p-button
                                        label="Ver Detalles"
                                        icon="pi pi-eye"
                                        severity="info"
                                        [text]="true"
                                        size="small"
                                        (onClick)="
                                            viewInspectionDetails(inspection)
                                        "
                                    >
                                    </p-button>
                                </div>
                            </p-card>
                        </div>
                    </div>
                </div>

                <ng-template #noInspections>
                    <div class="text-center p-4 text-600">
                        <i class="pi pi-search text-4xl mb-3 block"></i>
                        <p>No hay inspecciones externas asociadas</p>
                        <p-button
                            label="Crear Inspección"
                            icon="pi pi-plus"
                            (onClick)="createInspection()"
                        >
                        </p-button>
                    </div>
                </ng-template>
            </p-accordionTab>

            <!-- Facturación -->
            <p-accordionTab>
                <ng-template pTemplate="header">
                    <div
                        class="flex align-items-center justify-content-between w-full mr-3"
                    >
                        <span class="font-semibold">Facturación</span>
                        <p-tag
                            [value]="invoicesData.length.toString()"
                            [severity]="
                                invoicesData.length > 0 ? 'success' : 'warning'
                            "
                        ></p-tag>
                    </div>
                </ng-template>

                <div
                    class="invoices-section"
                    *ngIf="invoicesData.length > 0; else noInvoices"
                >
                    <div class="grid">
                        <div
                            class="col-12 md:col-6"
                            *ngFor="let invoice of invoicesData"
                        >
                            <p-card styleClass="invoice-card">
                                <div
                                    class="flex justify-content-between align-items-start mb-3"
                                >
                                    <h5 class="m-0">
                                        {{ invoice.invoiceNumber }}
                                    </h5>
                                    <p-tag
                                        [value]="invoice.status"
                                        [severity]="
                                            getInvoiceStatusSeverity(
                                                invoice.status
                                            )
                                        "
                                    >
                                    </p-tag>
                                </div>
                                <div class="invoice-info">
                                    <div class="detail-item">
                                        <label>Monto Total:</label>
                                        <span class="font-bold text-green-600">
                                            ${{
                                                invoice.totalAmount
                                                    | number : "1.2-2"
                                            }}
                                        </span>
                                    </div>
                                    <div class="detail-item">
                                        <label>Fecha de Emisión:</label>
                                        <span>{{
                                            invoice.issueDate
                                                | date : "dd/MM/yyyy"
                                        }}</span>
                                    </div>
                                    <div
                                        class="detail-item"
                                        *ngIf="invoice.dueDate"
                                    >
                                        <label>Fecha de Vencimiento:</label>
                                        <span>{{
                                            invoice.dueDate
                                                | date : "dd/MM/yyyy"
                                        }}</span>
                                    </div>
                                </div>
                                <div class="mt-3">
                                    <p-button
                                        label="Ver Factura"
                                        icon="pi pi-eye"
                                        severity="info"
                                        [text]="true"
                                        size="small"
                                        (onClick)="viewInvoiceDetails(invoice)"
                                    >
                                    </p-button>
                                </div>
                            </p-card>
                        </div>
                    </div>
                </div>

                <ng-template #noInvoices>
                    <div class="text-center p-4 text-600">
                        <i class="pi pi-dollar text-4xl mb-3 block"></i>
                        <p>No hay facturas generadas</p>
                        <p-button
                            label="Generar Factura"
                            icon="pi pi-plus"
                            (onClick)="createInvoice()"
                        >
                        </p-button>
                    </div>
                </ng-template>
            </p-accordionTab>

            <!-- Faenamientos -->
            <p-accordionTab>
                <ng-template pTemplate="header">
                    <div
                        class="flex align-items-center justify-content-between w-full mr-3"
                    >
                        <span class="font-semibold">Faenamientos</span>
                        <p-tag
                            [value]="slaughteringsData.length.toString()"
                            severity="info"
                        ></p-tag>
                    </div>
                </ng-template>

                <div
                    class="slaughterings-section"
                    *ngIf="slaughteringsData.length > 0; else noSlaughterings"
                >
                    <!-- Contenido de faenamientos -->
                    <p>Sección de faenamientos en desarrollo</p>
                </div>

                <ng-template #noSlaughterings>
                    <div class="text-center p-4 text-600">
                        <i class="pi pi-cog text-4xl mb-3 block"></i>
                        <p>No hay faenamientos registrados</p>
                    </div>
                </ng-template>
            </p-accordionTab>

            <!-- Despachos -->
            <p-accordionTab>
                <ng-template pTemplate="header">
                    <div
                        class="flex align-items-center justify-content-between w-full mr-3"
                    >
                        <span class="font-semibold">Despachos</span>
                        <p-tag
                            [value]="dispatchesData.length.toString()"
                            severity="info"
                        ></p-tag>
                    </div>
                </ng-template>

                <div
                    class="dispatches-section"
                    *ngIf="dispatchesData.length > 0; else noDispatches"
                >
                    <!-- Contenido de despachos -->
                    <p>Sección de despachos en desarrollo</p>
                </div>

                <ng-template #noDispatches>
                    <div class="text-center p-4 text-600">
                        <i class="pi pi-truck text-4xl mb-3 block"></i>
                        <p>No hay despachos registrados</p>
                    </div>
                </ng-template>
            </p-accordionTab>
        </p-accordion>
    </div>
</div>

<!-- Loading Template -->
<ng-template #loadingTemplate>
    <div class="loading-container">
        <div class="text-center p-5">
            <p-progressSpinner
                styleClass="w-4rem h-4rem"
                strokeWidth="4"
            ></p-progressSpinner>
            <p class="text-600 mt-3">Cargando detalles del proceso...</p>
        </div>
    </div>
</ng-template>

<!-- Toast para notificaciones -->
<p-toast></p-toast>
