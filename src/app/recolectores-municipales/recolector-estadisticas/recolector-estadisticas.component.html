<p *ngIf="cargando">Cargando datos...</p>

<div *ngIf="!cargando">
    <div class="card">
        <h2>Estadísticas Generales</h2>

        <p-table [value]="datosRecolectores">
            <ng-template pTemplate="header">
                <tr>
                    <th style="text-align: center;">Fecha</th>
                    <th style="text-align: center;">Recolector</th>
                    <th style="text-align: center;">Ruta</th>
                    <th style="text-align: center;">Puntos de Recolección</th>
                    <!--
                    <th>Capacidad Retorno</th>
                    -->
                    
                    <th style="text-align: center;">Velocidad Máxima</th>
                    <!-- Nueva columna -->
                </tr>
            </ng-template>
            <ng-template pTemplate="body" let-recolector>
                <tr>
                    <td style="text-align: center;">{{ recolector.dateOnly }}</td>
                    <td style="text-align: center;">{{ recolector.deviceId }}</td>
                    <td style="text-align: center;">{{ recolector.ruta.length }}</td>
                    <td style="text-align: center;">{{ recolector.puntos_recoleccion.length }}</td>
                    <!--
                     <td>{{ recolector.capacidad_retorno[0]?.value }}</td>
                    -->

                    <td style="text-align: center;">{{ calcularVelocidadMaxima(recolector.ruta) }} km/h</td>
                    <!-- Nueva columna con la velocidad máxima -->
                </tr>
            </ng-template>
        </p-table>
    </div>

    <div class="grid">
        <div class="col-12 xl:col-6">
            <div class="card">
                <label class="font-bold block mb-2">Velocidad Promedio</label>
                <p-chart type="line" [data]="dataVelocidadPromedio"></p-chart>
                <div style="display: flex; justify-content: flex-end">
                    <p-button
                        icon="pi pi-external-link"
                        label="ver"
                        (onClick)="
                            openDialog(
                                'Velocidad Promedio',
                                dataVelocidadPromedio,
                                'Fecha/Recolector',
                                'line'
                            )
                        "
                    ></p-button>
                </div>
            </div>

            <div class="card">
                <label class="font-bold block mb-2"
                    >Distribución de Velocidades</label
                >
                <p-chart
                    type="bar"
                    [data]="dataDistribucionVelocidades"
                ></p-chart>
                <div style="display: flex; justify-content: flex-end">
                    <p-button
                        icon="pi pi-external-link"
                        label="ver"
                        (onClick)="
                            openDialog(
                                'Distribución de Velocidades',
                                dataDistribucionVelocidades,
                                'Recolector',
                                'bar'
                            )
                        "
                    ></p-button>
                </div>
            </div>
        </div>
        <div class="col-12 xl:col-6">
            <div class="card">
                <label class="font-bold block mb-2"
                    >Puntos de Recolección</label
                >
                <p-chart type="line" [data]="dataPuntosRecoleccion"></p-chart>
                <div style="display: flex; justify-content: flex-end">
                    <p-button
                        icon="pi pi-external-link"
                        label="ver"
                        (onClick)="
                            openDialog(
                                'Puntos de Recolección',
                                dataPuntosRecoleccion,
                                'Recolector',
                                'line'
                            )
                        "
                    ></p-button>
                </div>
            </div>
            <div class="card">
                <label class="font-bold block mb-2">Desechos Recolectados</label>
                <p-chart type="line" [data]="dataCapacidadRetorno"></p-chart>
                <div style="display: flex; justify-content: space-between">
                    <p-button
                        (onClick)="op.toggle($event)"
                        icon="pi pi-info"
                        label="Info de Tonelaje"
                    />
                    <p-button
                        icon="pi pi-external-link"
                        label="ver"
                        (onClick)="
                            openDialog(
                                'Capacidad de Retorno',
                                dataCapacidadRetorno,
                                'Fecha/Recolector',
                                'line'
                            )
                        "
                    ></p-button>
                </div>
            </div>
            <p-overlayPanel #op>
                <div
                    class="flex flex-column gap-3"
                    [style]="{ 'min-width': !isMobil() ? '20rem' : '80vw' }"
                >
                    <div>
                        <span class="font-medium text-900 block mb-2"
                            >Información de tonelaje</span
                        >
                    </div>
                    <p-table
                        [value]="tabla_info"
                        [tableStyle]="{
                            'min-width': !isMobil() ? '20rem' : '80vw'
                        }"
                    >
                        <ng-template pTemplate="header">
                            <tr>
                                <th>ID</th>
                                <th>Nombre</th>
                                <th>Placa</th>
                                <th>Capacidad (Toneladas)</th>
                            </tr>
                        </ng-template>
                        <ng-template pTemplate="body" let-item>
                            <tr>
                                <td>{{ item.id }}</td>
                                <td>{{ item.name }}</td>
                                <td>{{ item.plate }}</td>
                                <td>{{ item.capacidad }}</td>
                            </tr>
                        </ng-template>
                    </p-table>
                </div>
            </p-overlayPanel>
        </div>

        <div class="col-12 xl:col-6">
            <div class="card">
                <label class="font-bold block mb-2">Distancia Recorrida</label>
                <p-chart type="line" [data]="dataDistanciaRecorrida"></p-chart>
                <div style="display: flex; justify-content: flex-end">
                    <p-button
                        icon="pi pi-external-link"
                        label="ver"
                        (onClick)="
                            openDialog(
                                'Distancia Recorrida',
                                dataDistanciaRecorrida,
                                'Fecha/Recolector',
                                'line'
                            )
                        "
                    ></p-button>
                </div>
            </div>
        </div>
    </div>

    <p-dialog
        [header]="headers_dialog"
        [(visible)]="dialogVisible"
        [modal]="true"
        [style]="{ width: '80vw' }"
        [responsive]="true"
        [draggable]="false"
    >
        <p-chart
            *ngIf="load_char_dialog"
            [data]="dialogChartData"
            [type]="tipo_chart"
        ></p-chart>
        <p-table
            *ngIf="load_char_dialog"
            [value]="dialogTableData"
            [tableStyle]="{ 'min-width': '20rem' }"
        >
            <ng-template pTemplate="header">
                <tr *ngIf="dialogTableData && dialogTableData.length > 0">
                    <th *ngFor="let header of tableHeaders" style="text-align: center;">{{ header }}</th>
                </tr>
            </ng-template>
            <ng-template pTemplate="body" let-row>
                <tr>
                    <td *ngFor="let header of tableHeaders" style="text-align: center;">
                        {{ row[header] }}
                    </td>
                </tr>
            </ng-template>
        </p-table>
        <div
            style="display: flex; justify-content: center"
            *ngIf="dialogVisible && !load_char_dialog"
        >
            <p-progressSpinner
                *ngIf="dialogVisible && !load_char_dialog"
                styleClass="w-4rem h-4rem"
                strokeWidth="8"
                fill="var(--surface-ground)"
                animationDuration=".5s"
            />
        </div>
    </p-dialog>
</div>
